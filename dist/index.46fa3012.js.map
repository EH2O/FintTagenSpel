{"mappings":"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","sources":["node_modules/kaboom/src/utils.ts","node_modules/kaboom/src/math.ts","node_modules/kaboom/src/fps.ts","node_modules/kaboom/src/timer.ts","node_modules/kaboom/src/kaboom.ts","src/tag.js"],"sourcesContent":["export class IDList<T> extends Map<number, T> {\n\t_lastID: number;\n\tconstructor(...args) {\n\t\tsuper(...args);\n\t\tthis._lastID = 0;\n\t}\n\tpush(v: T): number {\n\t\tconst id = this._lastID;\n\t\tthis.set(id, v);\n\t\tthis._lastID++;\n\t\treturn id;\n\t}\n\tpushd(v: T): () => void {\n\t\tconst id = this.push(v);\n\t\treturn () => this.delete(id);\n\t}\n}\n\nexport function deepEq(o1: any, o2: any): boolean {\n\tconst t1 = typeof o1;\n\tconst t2 = typeof o2;\n\tif (t1 !== t2) {\n\t\treturn false;\n\t}\n\tif (t1 === \"object\" && t2 === \"object\") {\n\t\tconst k1 = Object.keys(o1);\n\t\tconst k2 = Object.keys(o2);\n\t\tif (k1.length !== k2.length) {\n\t\t\treturn false;\n\t\t}\n\t\tfor (const k of k1) {\n\t\t\tconst v1 = o1[k];\n\t\t\tconst v2 = o2[k];\n\t\t\tif (!(typeof v1 === \"function\" && typeof v2 === \"function\")) {\n\t\t\t\tif (!deepEq(v1, v2)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\treturn o1 === o2;\n}\n\nexport function downloadURL(url: string, filename: string) {\n\tconst a = document.createElement(\"a\");\n\tdocument.body.appendChild(a);\n\ta.setAttribute(\"style\", \"display: none\");\n\ta.href = url;\n\ta.download = filename;\n\ta.click();\n\tdocument.body.removeChild(a);\n}\n\nexport function downloadBlob(blob: Blob, filename: string) {\n\tconst url = URL.createObjectURL(blob);\n\tdownloadURL(url, filename);\n\tURL.revokeObjectURL(url);\n}\n\nexport function isDataURL(str: string) {\n\treturn str.match(/^data:\\w+\\/\\w+;base64,.+/);\n}\n\nexport const uid = (() => {\n\tlet id = 0;\n\treturn () => id++;\n})();\n\nconst warned = new Set();\n\nexport function deprecateMsg(oldName: string, newName: string) {\n\tif (!warned.has(oldName)) {\n\t\twarned.add(oldName);\n\t\tconsole.warn(`${oldName} is deprecated. Use ${newName} instead.`);\n\t}\n}\n\nexport const deprecate = (oldName: string, newName: string, newFunc: (...args) => any) => (...args) => {\n\tdeprecateMsg(oldName, newName);\n\treturn newFunc(...args);\n};\n","import {\n\tVec4,\n\tPoint,\n\tPolygon,\n\tArea,\n} from \"./types\";\n\nimport {\n\tdeprecateMsg,\n} from \"./utils\";\n\nexport function deg2rad(deg: number): number {\n\treturn deg * Math.PI / 180;\n}\n\nexport function rad2deg(rad: number): number {\n\treturn rad * 180 / Math.PI;\n}\n\nexport function clamp(\n\tval: number,\n\tmin: number,\n\tmax: number,\n): number {\n\tif (min > max) {\n\t\treturn clamp(val, max, min);\n\t}\n\treturn Math.min(Math.max(val, min), max);\n}\n\nexport function lerp(\n\ta: number,\n\tb: number,\n\tt: number,\n): number {\n\treturn a + (b - a) * t;\n}\n\nexport function map(\n\tv: number,\n\tl1: number,\n\th1: number,\n\tl2: number,\n\th2: number,\n): number {\n\treturn l2 + (v - l1) / (h1 - l1) * (h2 - l2);\n}\n\nexport function mapc(\n\tv: number,\n\tl1: number,\n\th1: number,\n\tl2: number,\n\th2: number,\n): number {\n\treturn clamp(map(v, l1, h1, l2, h2), l2, h2);\n}\n\nexport class Vec2 {\n\tx: number = 0;\n\ty: number = 0;\n\tconstructor(x: number = 0, y: number = x) {\n\t\tthis.x = x;\n\t\tthis.y = y;\n\t}\n\tstatic fromAngle(deg: number) {\n\t\tconst angle = deg2rad(deg);\n\t\treturn new Vec2(Math.cos(angle), Math.sin(angle));\n\t}\n\tstatic LEFT = new Vec2(-1, 0);\n\tstatic RIGHT = new Vec2(1, 0);\n\tstatic UP = new Vec2(0, -1);\n\tstatic DOWN = new Vec2(0, 1);\n\tclone(): Vec2 {\n\t\treturn new Vec2(this.x, this.y);\n\t}\n\tadd(...args): Vec2 {\n\t\tconst p2 = vec2(...args);\n\t\treturn new Vec2(this.x + p2.x, this.y + p2.y);\n\t}\n\tsub(...args): Vec2 {\n\t\tconst p2 = vec2(...args);\n\t\treturn new Vec2(this.x - p2.x, this.y - p2.y);\n\t}\n\tscale(...args): Vec2 {\n\t\tconst s = vec2(...args);\n\t\treturn new Vec2(this.x * s.x, this.y * s.y);\n\t}\n\tdist(...args): number {\n\t\tconst p2 = vec2(...args);\n\t\treturn Math.sqrt(\n\t\t\t(this.x - p2.x) * (this.x - p2.x)\n\t\t\t+ (this.y - p2.y) * (this.y - p2.y)\n\t\t);\n\t}\n\tlen(): number {\n\t\treturn this.dist(new Vec2(0, 0));\n\t}\n\tunit(): Vec2 {\n\t\treturn this.scale(1 / this.len());\n\t}\n\tnormal(): Vec2 {\n\t\treturn new Vec2(this.y, -this.x);\n\t}\n\tdot(p2: Vec2): number {\n\t\treturn this.x * p2.x + this.y * p2.y;\n\t}\n\tangle(...args): number {\n\t\tconst p2 = vec2(...args);\n\t\treturn rad2deg(Math.atan2(this.y - p2.y, this.x - p2.x));\n\t}\n\tlerp(p2: Vec2, t: number): Vec2 {\n\t\treturn new Vec2(lerp(this.x, p2.x, t), lerp(this.y, p2.y, t));\n\t}\n\ttoFixed(n: number): Vec2 {\n\t\treturn new Vec2(Number(this.x.toFixed(n)), Number(this.y.toFixed(n)));\n\t}\n\teq(other: Vec2): boolean {\n\t\treturn this.x === other.x && this.y === other.y;\n\t}\n\ttoString(): string {\n\t\treturn `(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`;\n\t}\n\tstr(): string {\n\t\treturn this.toString();\n\t}\n}\n\nexport function vec2(...args): Vec2 {\n\tif (args.length === 1) {\n\t\tif (args[0] instanceof Vec2) {\n\t\t\treturn vec2(args[0].x, args[0].y);\n\t\t} else if (Array.isArray(args[0]) && args[0].length === 2) {\n\t\t\treturn vec2.apply(null, args[0]);\n\t\t}\n\t}\n\treturn new Vec2(...args);\n}\n\nexport class Vec3 {\n\tx: number = 0;\n\ty: number = 0;\n\tz: number = 0;\n\tconstructor(x: number, y: number, z: number) {\n\t\tthis.x = x;\n\t\tthis.y = y;\n\t\tthis.z = z;\n\t}\n\txy() {\n\t\treturn vec2(this.x, this.y);\n\t}\n}\n\nexport const vec3 = (x, y, z) => new Vec3(x, y, z);\n\nexport class Color {\n\n\tr: number = 255;\n\tg: number = 255;\n\tb: number = 255;\n\n\tconstructor(r: number, g: number, b: number) {\n\t\tthis.r = clamp(r, 0, 255);\n\t\tthis.g = clamp(g, 0, 255);\n\t\tthis.b = clamp(b, 0, 255);\n\t}\n\n\tstatic fromArray(arr: number[]) {\n\t\treturn new Color(arr[0], arr[1], arr[2])\n\t}\n\n\tstatic RED = rgb(255, 0, 0);\n\tstatic GREEN = rgb(0, 255, 0);\n\tstatic BLUE = rgb(0, 0, 255);\n\tstatic YELLOW = rgb(255, 255, 0);\n\tstatic MAGENTA = rgb(255, 0, 255);\n\tstatic CYAN = rgb(0, 255, 255);\n\tstatic WHITE = rgb(255, 255, 255);\n\tstatic BLACK = rgb(0, 0, 0);\n\n\tclone(): Color {\n\t\treturn new Color(this.r, this.g, this.b);\n\t}\n\n\tlighten(a: number): Color {\n\t\treturn new Color(this.r + a, this.g + a, this.b + a);\n\t}\n\n\tdarken(a: number): Color {\n\t\treturn this.lighten(-a);\n\t}\n\n\tinvert(): Color {\n\t\treturn new Color(255 - this.r, 255 - this.g, 255 - this.b);\n\t}\n\n\tmult(other: Color): Color {\n\t\treturn new Color(\n\t\t\tthis.r * other.r / 255,\n\t\t\tthis.g * other.g / 255,\n\t\t\tthis.b * other.b / 255,\n\t\t);\n\t}\n\n\teq(other: Color): boolean {\n\t\treturn this.r === other.r\n\t\t\t&& this.g === other.g\n\t\t\t&& this.b === other.b\n\t\t\t;\n\t}\n\n\tstr(): string {\n\t\tdeprecateMsg(\"str()\", \"toString()\");\n\t\treturn `(${this.r}, ${this.g}, ${this.b})`;\n\t}\n\n\ttoString(): string {\n\t\treturn `(${this.r}, ${this.g}, ${this.b})`;\n\t}\n\n\tstatic fromHSL(h: number, s: number, l: number) {\n\n\t\tif (s == 0){\n\t\t\treturn rgb(255 * l, 255 * l, 255 * l);\n\t\t}\n\n\t\tconst hue2rgb = (p, q, t) => {\n\t\t\tif (t < 0) t += 1;\n\t\t\tif (t > 1) t -= 1;\n\t\t\tif (t < 1 / 6) return p + (q - p) * 6 * t;\n\t\t\tif (t < 1 / 2) return q;\n\t\t\tif (t < 2 / 3) return p + (q - p) * (2/3 - t) * 6;\n\t\t\treturn p;\n\t\t}\n\n\t\tconst q = l < 0.5 ? l * (1 + s) : l + s - l * s;\n\t\tconst p = 2 * l - q;\n\t\tconst r = hue2rgb(p, q, h + 1 / 3);\n\t\tconst g = hue2rgb(p, q, h);\n\t\tconst b = hue2rgb(p, q, h - 1 / 3);\n\n\t\treturn new Color(Math.round(r * 255), Math.round(g * 255), Math.round(b * 255));\n\n\t}\n\n}\n\nexport function rgb(...args): Color {\n\tif (args.length === 0) {\n\t\treturn new Color(255, 255, 255);\n\t} else if (args.length === 1) {\n\t\tif (args[0] instanceof Color) {\n\t\t\treturn args[0].clone();\n\t\t} else if (Array.isArray(args[0]) && args[0].length === 3) {\n\t\t\treturn Color.fromArray(args[0]);\n\t\t}\n\t}\n\t// @ts-ignore\n\treturn new Color(...args);\n}\n\nexport const hsl2rgb = (h, s, l) => Color.fromHSL(h, s, l);\n\nexport class Quad {\n\tx: number = 0;\n\ty: number = 0;\n\tw: number = 1;\n\th: number = 1;\n\tconstructor(x: number, y: number, w: number, h: number) {\n\t\tthis.x = x;\n\t\tthis.y = y;\n\t\tthis.w = w;\n\t\tthis.h = h;\n\t}\n\tscale(other: Quad): Quad {\n\t\treturn new Quad(\n\t\t\tthis.x + this.w * other.x,\n\t\t\tthis.y + this.h * other.y,\n\t\t\tthis.w * other.w,\n\t\t\tthis.h * other.h\n\t\t);\n\t}\n\tclone(): Quad {\n\t\treturn new Quad(this.x, this.y, this.w, this.h);\n\t}\n\teq(other: Quad): boolean {\n\t\treturn this.x === other.x\n\t\t\t&& this.y === other.y\n\t\t\t&& this.w === other.w\n\t\t\t&& this.h === other.h;\n\t}\n\ttoString(): string {\n\t\treturn `quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`;\n\t}\n}\n\nexport function quad(x: number, y: number, w: number, h: number): Quad {\n\treturn new Quad(x, y, w, h);\n}\n\nexport class Mat4 {\n\n\tm: number[] = [\n\t\t1, 0, 0, 0,\n\t\t0, 1, 0, 0,\n\t\t0, 0, 1, 0,\n\t\t0, 0, 0, 1,\n\t];\n\n\tconstructor(m?: number[]) {\n\t\tif (m) {\n\t\t\tthis.m = m;\n\t\t}\n\t}\n\n\tclone(): Mat4 {\n\t\treturn new Mat4(this.m);\n\t};\n\n\tmult(other: Mat4): Mat4 {\n\n\t\tconst out = [];\n\n\t\tfor (let i = 0; i < 4; i++) {\n\t\t\tfor (let j = 0; j < 4; j++) {\n\t\t\t\tout[i * 4 + j] =\n\t\t\t\t\tthis.m[0 * 4 + j] * other.m[i * 4 + 0] +\n\t\t\t\t\tthis.m[1 * 4 + j] * other.m[i * 4 + 1] +\n\t\t\t\t\tthis.m[2 * 4 + j] * other.m[i * 4 + 2] +\n\t\t\t\t\tthis.m[3 * 4 + j] * other.m[i * 4 + 3];\n\t\t\t}\n\t\t}\n\n\t\treturn new Mat4(out);\n\n\t}\n\n\tmultVec4(p: Vec4): Vec4 {\n\t\treturn {\n\t\t\tx: p.x * this.m[0] + p.y * this.m[4] + p.z * this.m[8] + p.w * this.m[12],\n\t\t\ty: p.x * this.m[1] + p.y * this.m[5] + p.z * this.m[9] + p.w * this.m[13],\n\t\t\tz: p.x * this.m[2] + p.y * this.m[6] + p.z * this.m[10] + p.w * this.m[14],\n\t\t\tw: p.x * this.m[3] + p.y * this.m[7] + p.z * this.m[11] + p.w * this.m[15]\n\t\t};\n\t}\n\n\tmultVec3(p: Vec3): Vec3 {\n\t\tconst p4 = this.multVec4({\n\t\t\tx: p.x,\n\t\t\ty: p.y,\n\t\t\tz: p.z,\n\t\t\tw: 1.0,\n\t\t});\n\t\treturn vec3(p4.x, p4.y, p4.z);\n\t}\n\n\tmultVec2(p: Vec2): Vec2 {\n\t\treturn vec2(\n\t\t\tp.x * this.m[0] + p.y * this.m[4] + 0 * this.m[8] + 1 * this.m[12],\n\t\t\tp.x * this.m[1] + p.y * this.m[5] + 0 * this.m[9] + 1 * this.m[13],\n\t\t);\n\t}\n\n\tstatic translate(p: Vec2): Mat4 {\n\t\treturn new Mat4([\n\t\t\t1, 0, 0, 0,\n\t\t\t0, 1, 0, 0,\n\t\t\t0, 0, 1, 0,\n\t\t\tp.x, p.y, 0, 1,\n\t\t]);\n\t}\n\n\tstatic scale(s: Vec2): Mat4 {\n\t\treturn new Mat4([\n\t\t\ts.x, 0, 0, 0,\n\t\t\t0, s.y, 0, 0,\n\t\t\t0, 0, 1, 0,\n\t\t\t0, 0, 0, 1,\n\t\t]);\n\t}\n\n\tstatic rotateX(a: number): Mat4 {\n\t\ta = deg2rad(-a);\n\t\treturn new Mat4([\n\t\t\t1, 0, 0, 0,\n\t\t\t0, Math.cos(a), -Math.sin(a), 0,\n\t\t\t0, Math.sin(a), Math.cos(a), 0,\n\t\t\t0, 0, 0, 1,\n\t\t]);\n\t}\n\n\tstatic rotateY(a: number): Mat4 {\n\t\ta = deg2rad(-a);\n\t\treturn new Mat4([\n\t\t\tMath.cos(a), 0, Math.sin(a), 0,\n\t\t\t0, 1, 0, 0,\n\t\t\t-Math.sin(a), 0, Math.cos(a), 0,\n\t\t\t0, 0, 0, 1,\n\t\t]);\n\t}\n\n\tstatic rotateZ(a: number): Mat4 {\n\t\ta = deg2rad(-a);\n\t\treturn new Mat4([\n\t\t\tMath.cos(a), -Math.sin(a), 0, 0,\n\t\t\tMath.sin(a), Math.cos(a), 0, 0,\n\t\t\t0, 0, 1, 0,\n\t\t\t0, 0, 0, 1,\n\t\t]);\n\t}\n\n\ttranslate(p: Vec2): Mat4 {\n\t\treturn this.mult(Mat4.translate(p));\n\t}\n\n\tscale(s: Vec2): Mat4 {\n\t\treturn this.mult(Mat4.scale(s));\n\t}\n\n\trotateX(a: number): Mat4 {\n\t\treturn this.mult(Mat4.rotateX(a));\n\t}\n\n\trotateY(a: number): Mat4 {\n\t\treturn this.mult(Mat4.rotateY(a));\n\t}\n\n\trotateZ(a: number): Mat4 {\n\t\treturn this.mult(Mat4.rotateZ(a));\n\t}\n\n\tinvert(): Mat4 {\n\n\t\tconst out = [];\n\n\t\tconst f00 = this.m[10] * this.m[15] - this.m[14] * this.m[11];\n\t\tconst f01 = this.m[9] * this.m[15] - this.m[13] * this.m[11];\n\t\tconst f02 = this.m[9] * this.m[14] - this.m[13] * this.m[10];\n\t\tconst f03 = this.m[8] * this.m[15] - this.m[12] * this.m[11];\n\t\tconst f04 = this.m[8] * this.m[14] - this.m[12] * this.m[10];\n\t\tconst f05 = this.m[8] * this.m[13] - this.m[12] * this.m[9];\n\t\tconst f06 = this.m[6] * this.m[15] - this.m[14] * this.m[7];\n\t\tconst f07 = this.m[5] * this.m[15] - this.m[13] * this.m[7];\n\t\tconst f08 = this.m[5] * this.m[14] - this.m[13] * this.m[6];\n\t\tconst f09 = this.m[4] * this.m[15] - this.m[12] * this.m[7];\n\t\tconst f10 = this.m[4] * this.m[14] - this.m[12] * this.m[6];\n\t\tconst f11 = this.m[5] * this.m[15] - this.m[13] * this.m[7];\n\t\tconst f12 = this.m[4] * this.m[13] - this.m[12] * this.m[5];\n\t\tconst f13 = this.m[6] * this.m[11] - this.m[10] * this.m[7];\n\t\tconst f14 = this.m[5] * this.m[11] - this.m[9] * this.m[7];\n\t\tconst f15 = this.m[5] * this.m[10] - this.m[9] * this.m[6];\n\t\tconst f16 = this.m[4] * this.m[11] - this.m[8] * this.m[7];\n\t\tconst f17 = this.m[4] * this.m[10] - this.m[8] * this.m[6];\n\t\tconst f18 = this.m[4] * this.m[9] - this.m[8] * this.m[5];\n\n\t\tout[0] = this.m[5] * f00 - this.m[6] * f01 + this.m[7] * f02;\n\t\tout[4] = -(this.m[4] * f00 - this.m[6] * f03 + this.m[7] * f04);\n\t\tout[8] = this.m[4] * f01 - this.m[5] * f03 + this.m[7] * f05;\n\t\tout[12] = -(this.m[4] * f02 - this.m[5] * f04 + this.m[6] * f05);\n\n\t\tout[1] = -(this.m[1] * f00 - this.m[2] * f01 + this.m[3] * f02);\n\t\tout[5] = this.m[0] * f00 - this.m[2] * f03 + this.m[3] * f04;\n\t\tout[9] = -(this.m[0] * f01 - this.m[1] * f03 + this.m[3] * f05);\n\t\tout[13] = this.m[0] * f02 - this.m[1] * f04 + this.m[2] * f05;\n\n\t\tout[2] = this.m[1] * f06 - this.m[2] * f07 + this.m[3] * f08;\n\t\tout[6] = -(this.m[0] * f06 - this.m[2] * f09 + this.m[3] * f10);\n\t\tout[10] = this.m[0] * f11 - this.m[1] * f09 + this.m[3] * f12;\n\t\tout[14] = -(this.m[0] * f08 - this.m[1] * f10 + this.m[2] * f12);\n\n\t\tout[3] = -(this.m[1] * f13 - this.m[2] * f14 + this.m[3] * f15);\n\t\tout[7] = this.m[0] * f13 - this.m[2] * f16 + this.m[3] * f17;\n\t\tout[11] = -(this.m[0] * f14 - this.m[1] * f16 + this.m[3] * f18);\n\t\tout[15] = this.m[0] * f15 - this.m[1] * f17 + this.m[2] * f18;\n\n\t\tconst det =\n\t\t\tthis.m[0] * out[0] +\n\t\t\tthis.m[1] * out[4] +\n\t\t\tthis.m[2] * out[8] +\n\t\t\tthis.m[3] * out[12];\n\n\t\tfor (let i = 0; i < 4; i++) {\n\t\t\tfor (let j = 0; j < 4; j++) {\n\t\t\t\tout[i * 4 + j] *= (1.0 / det);\n\t\t\t}\n\t\t}\n\n\t\treturn new Mat4(out);\n\n\t}\n\n\ttoString(): string {\n\t\treturn this.m.toString();\n\t}\n\n}\n\nexport function wave(lo: number, hi: number, t: number, f = Math.sin): number {\n\treturn lo + (f(t) + 1) / 2 * (hi - lo);\n}\n\n// basic ANSI C LCG\nconst A = 1103515245;\nconst C = 12345;\nconst M = 2147483648;\n\nexport class RNG {\n\tseed: number;\n\tconstructor(seed: number) {\n\t\tthis.seed = seed;\n\t}\n\tgen(...args) {\n\t\tif (args.length === 0) {\n\t\t\tthis.seed = (A * this.seed + C) % M;\n\t\t\treturn this.seed / M;\n\t\t} else if (args.length === 1) {\n\t\t\tif (typeof args[0] === \"number\") {\n\t\t\t\treturn this.gen(0, args[0]);\n\t\t\t} else if (args[0] instanceof Vec2) {\n\t\t\t\treturn this.gen(vec2(0, 0), args[0]);\n\t\t\t} else if (args[0] instanceof Color) {\n\t\t\t\treturn this.gen(rgb(0, 0, 0), args[0]);\n\t\t\t}\n\t\t} else if (args.length === 2) {\n\t\t\tif (typeof args[0] === \"number\" && typeof args[1] === \"number\") {\n\t\t\t\treturn (this.gen() * (args[1] - args[0])) + args[0];\n\t\t\t} else if (args[0] instanceof Vec2 && args[1] instanceof Vec2) {\n\t\t\t\treturn vec2(\n\t\t\t\t\tthis.gen(args[0].x, args[1].x),\n\t\t\t\t\tthis.gen(args[0].y, args[1].y),\n\t\t\t\t);\n\t\t\t} else if (args[0] instanceof Color && args[1] instanceof Color) {\n\t\t\t\treturn rgb(\n\t\t\t\t\tthis.gen(args[0].r, args[1].r),\n\t\t\t\t\tthis.gen(args[0].g, args[1].g),\n\t\t\t\t\tthis.gen(args[0].b, args[1].b),\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n}\n\n// TODO: let user pass seed\nconst defRNG = new RNG(Date.now());\n\nexport function rng(seed: number): RNG {\n\tdeprecateMsg(\"rng()\", \"new RNG()\");\n\treturn new RNG(seed);\n}\n\nexport function randSeed(seed?: number): number {\n\tif (seed != null) {\n\t\tdefRNG.seed = seed;\n\t}\n\treturn defRNG.seed;\n}\n\nexport function rand(...args) {\n\t// @ts-ignore\n\treturn defRNG.gen(...args);\n}\n\n// TODO: randi() to return 0 / 1?\nexport function randi(...args) {\n\treturn Math.floor(rand(...args));\n}\n\nexport function chance(p: number): boolean {\n\treturn rand() <= p;\n}\n\nexport function choose<T>(list: T[]): T {\n\treturn list[randi(list.length)];\n}\n\n// TODO: better name\nexport function testRectRect2(r1: Rect, r2: Rect): boolean {\n\treturn r1.p2.x >= r2.p1.x\n\t\t&& r1.p1.x <= r2.p2.x\n\t\t&& r1.p2.y >= r2.p1.y\n\t\t&& r1.p1.y <= r2.p2.y;\n}\n\nexport function testRectRect(r1: Rect, r2: Rect): boolean {\n\treturn r1.p2.x > r2.p1.x\n\t\t&& r1.p1.x < r2.p2.x\n\t\t&& r1.p2.y > r2.p1.y\n\t\t&& r1.p1.y < r2.p2.y;\n}\n\n// TODO: better name\nexport function testLineLineT(l1: Line, l2: Line): number | null {\n\n\tif ((l1.p1.x === l1.p2.x && l1.p1.y === l1.p2.y) || (l2.p1.x === l2.p2.x && l2.p1.y === l2.p2.y)) {\n\t\treturn null;\n\t}\n\n\tconst denom = ((l2.p2.y - l2.p1.y) * (l1.p2.x - l1.p1.x) - (l2.p2.x - l2.p1.x) * (l1.p2.y - l1.p1.y));\n\n\t// parallel\n\tif (denom === 0) {\n\t\treturn null;\n\t}\n\n\tconst ua = ((l2.p2.x - l2.p1.x) * (l1.p1.y - l2.p1.y) - (l2.p2.y - l2.p1.y) * (l1.p1.x - l2.p1.x)) / denom;\n\tconst ub = ((l1.p2.x - l1.p1.x) * (l1.p1.y - l2.p1.y) - (l1.p2.y - l1.p1.y) * (l1.p1.x - l2.p1.x)) / denom;\n\n\t// is the intersection on the segments\n\tif (ua < 0 || ua > 1 || ub < 0 || ub > 1) {\n\t\treturn null;\n\t}\n\n\treturn ua;\n\n}\n\nexport function testLineLine(l1: Line, l2: Line): Vec2 | null {\n\tconst t = testLineLineT(l1, l2);\n\tif (!t) return null;\n\treturn vec2(\n\t\tl1.p1.x + t * (l1.p2.x - l1.p1.x),\n\t\tl1.p1.y + t * (l1.p2.y - l1.p1.y),\n\t);\n}\n\nexport function testRectLine(r: Rect, l: Line): boolean {\n\tif (testRectPoint(r, l.p1) || testRectPoint(r, l.p2)) {\n\t\treturn true;\n\t}\n\treturn !!testLineLine(l, new Line(r.p1, vec2(r.p2.x, r.p1.y)))\n\t\t|| !!testLineLine(l, new Line(vec2(r.p2.x, r.p1.y), r.p2))\n\t\t|| !!testLineLine(l, new Line(r.p2, vec2(r.p1.x, r.p2.y)))\n\t\t|| !!testLineLine(l, new Line(vec2(r.p1.x, r.p2.y), r.p1));\n}\n\nexport function testRectPoint2(r: Rect, pt: Point): boolean {\n\treturn pt.x >= r.p1.x && pt.x <= r.p2.x && pt.y >= r.p1.y && pt.y <= r.p2.y;\n}\n\nexport function testRectPoint(r: Rect, pt: Point): boolean {\n\treturn pt.x > r.p1.x && pt.x < r.p2.x && pt.y > r.p1.y && pt.y < r.p2.y;\n}\n\nexport function testRectCircle(r: Rect, c: Circle): boolean {\n\tconst nx = Math.max(r.p1.x, Math.min(c.center.x, r.p2.x));\n\tconst ny = Math.max(r.p1.y, Math.min(c.center.y, r.p2.y));\n\tconst nearestPoint = vec2(nx, ny);\n\treturn nearestPoint.dist(c.center) <= c.radius;\n}\n\nexport function testRectPolygon(r: Rect, p: Polygon): boolean {\n\treturn testPolygonPolygon(p, [\n\t\tr.p1,\n\t\tvec2(r.p2.x, r.p1.y),\n\t\tr.p2,\n\t\tvec2(r.p1.x, r.p2.y),\n\t]);\n}\n\n// TODO\nexport function testLinePoint(l: Line, pt: Vec2): boolean {\n\treturn false;\n}\n\n// TODO\nexport function testLineCircle(l: Line, c: Circle): boolean {\n\treturn false;\n}\n\nexport function testLinePolygon(l: Line, p: Polygon): boolean {\n\n\t// test if line is inside\n\tif (testPolygonPoint(p, l.p1) || testPolygonPoint(p, l.p2)) {\n\t\treturn true;\n\t}\n\n\t// test each line\n\tfor (let i = 0; i < p.length; i++) {\n\t\tconst p1 = p[i];\n\t\tconst p2 = p[(i + 1) % p.length];\n\t\tif (testLineLine(l, { p1, p2 })) {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\treturn false;\n\n}\n\nexport function testCirclePoint(c: Circle, p: Point): boolean {\n\treturn c.center.dist(p) < c.radius;\n}\n\nexport function testCircleCircle(c1: Circle, c2: Circle): boolean {\n\treturn c1.center.dist(c2.center) < c1.radius + c2.radius;\n}\n\n// TODO\nexport function testCirclePolygon(c: Circle, p: Polygon): boolean {\n\treturn false;\n}\n\nexport function testPolygonPolygon(p1: Polygon, p2: Polygon): boolean {\n\tfor (let i = 0; i < p1.length; i++) {\n\t\tconst l = {\n\t\t\tp1: p1[i],\n\t\t\tp2: p1[(i + 1) % p1.length],\n\t\t};\n\t\tif (testLinePolygon(l, p2)) {\n\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\n// https://wrf.ecse.rpi.edu/Research/Short_Notes/pnpoly.html\nexport function testPolygonPoint(p: Polygon, pt: Point): boolean {\n\n\tlet c = false;\n\n\tfor (let i = 0, j = p.length - 1; i < p.length; j = i++) {\n\t\tif (\n\t\t\t((p[i].y > pt.y) != (p[j].y > pt.y))\n\t\t\t&& (pt.x < (p[j].x - p[i].x) * (pt.y - p[i].y) / (p[j].y - p[i].y) + p[i].x)\n\t\t) {\n\t\t\tc = !c;\n\t\t}\n\t}\n\n\treturn c;\n\n}\n\nexport function testPointPoint(p1: Point, p2: Point): boolean {\n\treturn p1.eq(p2);\n}\n\nexport function testAreaRect(a: Area, r: Rect): boolean {\n\tswitch (a.shape) {\n\t\tcase \"rect\": return testRectRect(r, a);\n\t\tcase \"line\": return testRectLine(r, a);\n\t\tcase \"circle\": return testRectCircle(r, a);\n\t\tcase \"polygon\": return testRectPolygon(r, a.pts);\n\t\tcase \"point\": return testRectPoint(r, a.pt);\n\t}\n\tthrow new Error(`Unknown area shape: ${(a as Area).shape}`);\n}\n\nexport function testAreaLine(a: Area, l: Line): boolean {\n\tswitch (a.shape) {\n\t\tcase \"rect\": return testRectLine(a, l);\n\t\tcase \"line\": return Boolean(testLineLine(a, l));\n\t\tcase \"circle\": return testLineCircle(l, a);\n\t\tcase \"polygon\": return testLinePolygon(l, a.pts);\n\t\tcase \"point\": return testLinePoint(l, a.pt);\n\t}\n\tthrow new Error(`Unknown area shape: ${(a as Area).shape}`);\n}\n\nexport function testAreaCircle(a: Area, c: Circle): boolean {\n\tswitch (a.shape) {\n\t\tcase \"rect\": return testRectCircle(a, c);\n\t\tcase \"line\": return testLineCircle(a, c);\n\t\tcase \"circle\": return testCircleCircle(a, c);\n\t\tcase \"polygon\": return testCirclePolygon(c, a.pts);\n\t\tcase \"point\": return testCirclePoint(c, a.pt);\n\t}\n\tthrow new Error(`Unknown area shape: ${(a as Area).shape}`);\n}\n\nexport function testAreaPolygon(a: Area, p: Polygon): boolean {\n\tswitch (a.shape) {\n\t\tcase \"rect\": return testRectPolygon(a, p);\n\t\tcase \"line\": return testLinePolygon(a, p);\n\t\tcase \"circle\": return testCirclePolygon(a, p);\n\t\tcase \"polygon\": return testPolygonPolygon(p, a.pts);\n\t\tcase \"point\": return testPolygonPoint(p, a.pt);\n\t}\n\tthrow new Error(`Unknown area shape: ${(a as Area).shape}`);\n}\n\nexport function testAreaPoint(a: Area, p: Point): boolean {\n\tswitch (a.shape) {\n\t\tcase \"rect\": return testRectPoint(a, p);\n\t\tcase \"line\": return testLinePoint(a, p);\n\t\tcase \"circle\": return testCirclePoint(a, p);\n\t\tcase \"polygon\": return testPolygonPoint(a.pts, p);\n\t\tcase \"point\": return testPointPoint(a.pt, p);\n\t}\n\tthrow new Error(`Unknown area shape: ${(a as Area).shape}`);\n}\n\nexport function testAreaArea(a1: Area, a2: Area): boolean {\n\tswitch (a2.shape) {\n\t\tcase \"rect\": return testAreaRect(a1, a2);\n\t\tcase \"line\": return testAreaLine(a1, a2);\n\t\tcase \"circle\": return testAreaCircle(a1, a2);\n\t\tcase \"polygon\": return testAreaPolygon(a1, a2.pts);\n\t\tcase \"point\": return testAreaPoint(a1, a2.pt);\n\t}\n\tthrow new Error(`Unknown area shape: ${(a2 as Area).shape}`);\n}\n\nexport function minkDiff(r1: Rect, r2: Rect): Rect {\n\treturn {\n\t\tp1: vec2(r1.p1.x - r2.p2.x, r1.p1.y - r2.p2.y),\n\t\tp2: vec2(r1.p2.x - r2.p1.x, r1.p2.y - r2.p1.y),\n\t};\n}\n\nexport class Line {\n\tp1: Vec2;\n\tp2: Vec2;\n\tconstructor(p1: Vec2, p2: Vec2) {\n\t\tthis.p1 = p1;\n\t\tthis.p2 = p2;\n\t}\n}\n\nexport class Rect {\n\tp1: Vec2;\n\tp2: Vec2;\n\tconstructor(p1: Vec2, p2: Vec2) {\n\t\tthis.p1 = p1;\n\t\tthis.p2 = p2;\n\t}\n}\n\nexport class Circle {\n\tcenter: Vec2;\n\tradius: number;\n\tconstructor(center: Vec2, radius: number) {\n\t\tthis.center = center;\n\t\tthis.radius = radius;\n\t}\n}\n","export default class FPSCounter {\n\n\tprivate buf: number[] = [];\n\tprivate timer: number = 0;\n\tfps: number = 0;\n\n\ttick(dt: number) {\n\n\t\tthis.buf.push(1 / dt);\n\t\tthis.timer += dt;\n\n\t\tif (this.timer >= 1) {\n\t\t\tthis.timer = 0;\n\t\t\tthis.fps = Math.round(this.buf.reduce((a, b) => a + b) / this.buf.length);\n\t\t\tthis.buf = [];\n\t\t}\n\n\t}\n\n}\n","export default class Timer {\n\n\ttime: number\n\taction: () => void\n\tfinished: boolean = false\n\tpaused: boolean = false\n\n\tconstructor(time: number, action: () => void) {\n\t\tthis.time = time;\n\t\tthis.action = action;\n\t}\n\n\ttick(dt: number): boolean {\n\t\tif (this.finished || this.paused) return false;\n\t\tthis.time -= dt;\n\t\tif (this.time <= 0) {\n\t\t\tthis.action();\n\t\t\tthis.finished = true;\n\t\t\tthis.time = 0;\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\treset(time) {\n\t\tthis.time = time;\n\t\tthis.finished = false;\n\t}\n\n}\n","import {\n\tvec2,\n\tvec3,\n\tVec3,\n\tRect,\n\tLine,\n\tCircle,\n\tColor,\n\tVec2,\n\tMat4,\n\tQuad,\n\tRNG,\n\tquad,\n\trgb,\n\thsl2rgb,\n\trng,\n\trand,\n\trandi,\n\trandSeed,\n\tchance,\n\tchoose,\n\tclamp,\n\tlerp,\n\tmap,\n\tmapc,\n\twave,\n\ttestAreaRect,\n\ttestAreaLine,\n\ttestAreaCircle,\n\ttestAreaPolygon,\n\ttestAreaPoint,\n\ttestAreaArea,\n\ttestLineLineT,\n\ttestRectRect2,\n\ttestLineLine,\n\ttestRectRect,\n\ttestRectLine,\n\ttestRectPoint,\n\ttestPolygonPoint,\n\ttestLinePolygon,\n\ttestPolygonPolygon,\n\ttestCircleCircle,\n\ttestCirclePoint,\n\ttestRectPolygon,\n\tminkDiff,\n\tdeg2rad,\n\trad2deg,\n} from \"./math\";\n\nimport {\n\tIDList,\n\tdownloadURL,\n\tdownloadBlob,\n\tuid,\n\tdeprecate,\n\tdeprecateMsg,\n\tisDataURL,\n\tdeepEq,\n} from \"./utils\";\n\nimport {\n\tGfxShader,\n\tGfxFont,\n\tTexFilter,\n\tRenderProps,\n\tCharTransform,\n\tCharTransformFunc,\n\tTexWrap,\n\tFormattedText,\n\tFormattedChar,\n\tDrawRectOpt,\n\tDrawLineOpt,\n\tDrawLinesOpt,\n\tDrawTriangleOpt,\n\tDrawPolygonOpt,\n\tDrawCircleOpt,\n\tDrawEllipseOpt,\n\tDrawUVQuadOpt,\n\tVertex,\n\tSpriteData,\n\tSoundData,\n\tFontData,\n\tShaderData,\n\tSpriteLoadSrc,\n\tSpriteLoadOpt,\n\tSpriteAtlasData,\n\tFontLoadOpt,\n\tGfxTexData,\n\tKaboomCtx,\n\tKaboomOpt,\n\tAudioPlay,\n\tAudioPlayOpt,\n\tDrawSpriteOpt,\n\tDrawTextOpt,\n\tGameObj,\n\tEventCanceller,\n\tSceneID,\n\tSceneDef,\n\tCompList,\n\tComp,\n\tTag,\n\tKey,\n\tMouseButton,\n\tTouchID,\n\tCollision,\n\tPosComp,\n\tScaleComp,\n\tRotateComp,\n\tColorComp,\n\tOpacityComp,\n\tOrigin,\n\tOriginComp,\n\tLayerComp,\n\tZComp,\n\tFollowComp,\n\tMoveComp,\n\tOutviewCompOpt,\n\tOutviewComp,\n\tCleanupCompOpt,\n\tCleanupComp,\n\tAreaCompOpt,\n\tAreaComp,\n\tArea,\n\tSpriteComp,\n\tSpriteCompOpt,\n\tGfxTexture,\n\tSpriteAnimPlayOpt,\n\tTextComp,\n\tTextCompOpt,\n\tRectComp,\n\tRectCompOpt,\n\tUVQuadComp,\n\tCircleComp,\n\tOutlineComp,\n\tTimerComp,\n\tBodyComp,\n\tBodyCompOpt,\n\tUniform,\n\tShaderComp,\n\tSolidComp,\n\tFixedComp,\n\tStayComp,\n\tHealthComp,\n\tLifespanComp,\n\tLifespanCompOpt,\n\tStateComp,\n\tDebug,\n\tKaboomPlugin,\n\tMergeObj,\n\tLevel,\n\tLevelOpt,\n\tCursor,\n\tRecording,\n\tKaboom,\n} from \"./types\";\n\nimport FPSCounter from \"./fps\";\nimport Timer from \"./timer\";\n\n// @ts-ignore\nimport apl386Src from \"./assets/apl386.png\";\n// @ts-ignore\nimport apl386oSrc from \"./assets/apl386o.png\";\n// @ts-ignore\nimport sinkSrc from \"./assets/sink.png\";\n// @ts-ignore\nimport sinkoSrc from \"./assets/sinko.png\";\n// @ts-ignore\nimport beanSrc from \"./assets/bean.png\";\n// @ts-ignore\nimport burpBytes from \"./assets/burp.mp3\";\n// @ts-ignore\nimport kaSrc from \"./assets/ka.png\";\n// @ts-ignore\nimport boomSrc from \"./assets/boom.png\";\n\ntype ButtonState =\n\t\"up\"\n\t| \"pressed\"\n\t| \"rpressed\"\n\t| \"down\"\n\t| \"released\"\n\t;\n\ntype DrawTextureOpt = RenderProps & {\n\ttex: GfxTexture,\n\twidth?: number,\n\theight?: number,\n\ttiled?: boolean,\n\tflipX?: boolean,\n\tflipY?: boolean,\n\tquad?: Quad,\n\torigin?: Origin | Vec2,\n}\n\ninterface GfxTexOpt {\n\tfilter?: TexFilter,\n\twrap?: TexWrap,\n}\n\n// translate these key names to a simpler version\nconst KEY_ALIAS = {\n\t\"ArrowLeft\": \"left\",\n\t\"ArrowRight\": \"right\",\n\t\"ArrowUp\": \"up\",\n\t\"ArrowDown\": \"down\",\n\t\" \": \"space\",\n};\n\n// according to https://developer.mozilla.org/en-US/docs/Web/API/MouseEvent/button\nconst MOUSE_BUTTONS = [\n\t\"left\",\n\t\"middle\",\n\t\"right\",\n\t\"back\",\n\t\"forward\",\n];\n\n// don't trigger browser default event when these keys are pressed\nconst PREVENT_DEFAULT_KEYS = [\n\t\"space\",\n\t\"left\",\n\t\"right\",\n\t\"up\",\n\t\"down\",\n\t\"tab\",\n\t\"f1\",\n\t\"f2\",\n\t\"f3\",\n\t\"f4\",\n\t\"f5\",\n\t\"f6\",\n\t\"f7\",\n\t\"f8\",\n\t\"f9\",\n\t\"f10\",\n\t\"f11\",\n\t\"s\",\n];\n\n// some default charsets for loading bitmap fonts\nconst ASCII_CHARS = \" !\\\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\\\]^_`abcdefghijklmnopqrstuvwxyz{|}~\";\nconst CP437_CHARS = \"  !\\\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\\\]^_`abcdefghijklmnopqrstuvwxyz{|}~\";\n\n// audio gain range\nconst MIN_GAIN = 0;\nconst MAX_GAIN = 3;\n\n// audio speed range\nconst MIN_SPEED = 0;\nconst MAX_SPEED = 3;\n\n// audio detune range\nconst MIN_DETUNE = -1200;\nconst MAX_DETUNE = 1200;\n\nconst DEF_ORIGIN = \"topleft\";\nconst DEF_GRAVITY = 1600;\nconst QUEUE_COUNT = 65536;\nconst BG_GRID_SIZE = 64;\n\nconst DEF_FONT = \"apl386o\";\nconst DBG_FONT = \"sink\";\n\n// vertex format stride (vec3 pos, vec2 uv, vec4 color)\nconst STRIDE = 9;\n\n// vertex shader template, replace {{user}} with user vertex shader code\nconst VERT_TEMPLATE = `\nattribute vec3 a_pos;\nattribute vec2 a_uv;\nattribute vec4 a_color;\n\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nvec4 def_vert() {\n\treturn vec4(a_pos, 1.0);\n}\n\n{{user}}\n\nvoid main() {\n\tvec4 pos = vert(a_pos, a_uv, a_color);\n\tv_pos = a_pos;\n\tv_uv = a_uv;\n\tv_color = a_color;\n\tgl_Position = pos;\n}\n`;\n\n// fragment shader template, replace {{user}} with user fragment shader code\nconst FRAG_TEMPLATE = `\nprecision mediump float;\n\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nuniform sampler2D u_tex;\n\nvec4 def_frag() {\n\treturn v_color * texture2D(u_tex, v_uv);\n}\n\n{{user}}\n\nvoid main() {\n\tgl_FragColor = frag(v_pos, v_uv, v_color, u_tex);\n\tif (gl_FragColor.a == 0.0) {\n\t\tdiscard;\n\t}\n}\n`;\n\n// default {{user}} vertex shader code\nconst DEF_VERT = `\nvec4 vert(vec3 pos, vec2 uv, vec4 color) {\n\treturn def_vert();\n}\n`;\n\n// default {{user}} fragment shader code\nconst DEF_FRAG = `\nvec4 frag(vec3 pos, vec2 uv, vec4 color, sampler2D tex) {\n\treturn def_frag();\n}\n`;\n\nconst COMP_DESC = new Set([\n\t\"id\",\n\t\"require\",\n]);\n\nconst COMP_EVENTS = new Set([\n\t\"add\",\n\t\"load\",\n\t\"update\",\n\t\"draw\",\n\t\"destroy\",\n\t\"inspect\",\n]);\n\n// transform the button state to the next state\n// e.g. a button might become \"pressed\" one frame, and it should become \"down\" next frame\nfunction processButtonState(s: ButtonState): ButtonState {\n\tif (s === \"pressed\" || s === \"rpressed\") {\n\t\treturn \"down\";\n\t}\n\tif (s === \"released\") {\n\t\treturn \"up\";\n\t}\n\treturn s;\n}\n\n// wrappers around full screen functions to work across browsers\nfunction enterFullscreen(el: HTMLElement) {\n\tif (el.requestFullscreen) el.requestFullscreen();\n\t// @ts-ignore\n\telse if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();\n};\n\nfunction exitFullscreen() {\n\tif (document.exitFullscreen) document.exitFullscreen();\n\t// @ts-ignore\n\telse if (document.webkitExitFullScreen) document.webkitExitFullScreen();\n};\n\nfunction getFullscreenElement(): Element | void {\n\treturn document.fullscreenElement\n\t\t// @ts-ignore\n\t\t|| document.webkitFullscreenElement\n\t\t;\n};\n\n// convert origin string to a vec2 offset\nfunction originPt(orig: Origin | Vec2): Vec2 {\n\tswitch (orig) {\n\t\tcase \"topleft\": return vec2(-1, -1);\n\t\tcase \"top\": return vec2(0, -1);\n\t\tcase \"topright\": return vec2(1, -1);\n\t\tcase \"left\": return vec2(-1, 0);\n\t\tcase \"center\": return vec2(0, 0);\n\t\tcase \"right\": return vec2(1, 0);\n\t\tcase \"botleft\": return vec2(-1, 1);\n\t\tcase \"bot\": return vec2(0, 1);\n\t\tcase \"botright\": return vec2(1, 1);\n\t\tdefault: return orig;\n\t}\n}\n\nfunction createEmptyAudioBuffer() {\n\treturn new AudioBuffer({\n\t\tlength: 1,\n\t\tnumberOfChannels: 1,\n\t\tsampleRate: 44100\n\t});\n}\n\n// only exports one kaboom() which contains all the state\nexport default (gopt: KaboomOpt = {}): KaboomCtx => {\n\nconst app = (() => {\n\n\tconst root = gopt.root ?? document.body;\n\n\t// if root is not defined (which falls back to <body>) we assume user is using kaboom on a clean page, and modify <body> to better fit a full screen canvas\n\tif (root === document.body) {\n\t\tdocument.body.style[\"width\"] = \"100%\";\n\t\tdocument.body.style[\"height\"] = \"100%\";\n\t\tdocument.body.style[\"margin\"] = \"0px\";\n\t\tdocument.documentElement.style[\"width\"] = \"100%\";\n\t\tdocument.documentElement.style[\"height\"] = \"100%\";\n\t}\n\n\t// create a <canvas> if user didn't provide one\n\tconst canvas = gopt.canvas ?? (() => {\n\t\tconst canvas = document.createElement(\"canvas\");\n\t\troot.appendChild(canvas);\n\t\treturn canvas;\n\t})();\n\n\t// global pixel scale\n\tconst gscale = gopt.scale ?? 1;\n\n\t// adjust canvas size according to user size / viewport settings\n\tif (gopt.width && gopt.height && !gopt.stretch && !gopt.letterbox) {\n\t\tcanvas.width = gopt.width * gscale;\n\t\tcanvas.height = gopt.height * gscale;\n\t} else {\n\t\tcanvas.width = canvas.parentElement.offsetWidth;\n\t\tcanvas.height = canvas.parentElement.offsetHeight;\n\t}\n\n\t// canvas css styles\n\tconst styles = [\n\t\t\"outline: none\",\n\t\t\"cursor: default\",\n\t];\n\n\tif (gopt.crisp) {\n\t\tstyles.push(\"image-rendering: pixelated\");\n\t\tstyles.push(\"image-rendering: crisp-edges\");\n\t}\n\n\t// TODO: .style is supposed to be readonly? alternative?\n\t// @ts-ignore\n\tcanvas.style = styles.join(\";\");\n\n\t// make canvas focusable\n\tcanvas.setAttribute(\"tabindex\", \"0\");\n\n\t// create webgl context\n\tconst gl = canvas\n\t\t.getContext(\"webgl\", {\n\t\t\tantialias: true,\n\t\t\tdepth: true,\n\t\t\tstencil: true,\n\t\t\talpha: true,\n\t\t\tpreserveDrawingBuffer: true,\n\t\t});\n\n\treturn {\n\n\t\tcanvas: canvas,\n\t\tscale: gscale,\n\t\tgl: gl,\n\n\t\t// keep track of all button states\n\t\tkeyStates: {} as Record<Key, ButtonState>,\n\t\tmouseStates: {} as Record<MouseButton, ButtonState>,\n\n\t\t// input states from last frame, should reset every frame\n\t\tcharInputted: [],\n\t\tisMouseMoved: false,\n\t\tisKeyPressed: false,\n\t\tisKeyPressedRepeat: false,\n\t\tisKeyReleased: false,\n\t\tmousePos: vec2(0, 0),\n\t\tmouseDeltaPos: vec2(0, 0),\n\n\t\t// total time elapsed\n\t\ttime: 0,\n\t\t// real total time elapsed (including paused time)\n\t\trealTime: 0,\n\t\t// if we should skip next dt, to prevent the massive dt surge if user switch to another tab for a while and comeback\n\t\tskipTime: false,\n\t\t// how much time last frame took\n\t\tdt: 0.0,\n\t\t// total frames elapsed\n\t\tnumFrames: 0,\n\n\t\t// if we're on a touch device\n\t\tisTouch: (\"ontouchstart\" in window) || navigator.maxTouchPoints > 0,\n\n\t\t// requestAnimationFrame id\n\t\tloopID: null,\n\t\t// if our game loop is currently stopped / paused\n\t\tstopped: false,\n\t\tpaused: false,\n\n\t\t// TODO: take fps counter out pure\n\t\tfpsCounter: new FPSCounter(),\n\n\t\t// if we finished loading all assets\n\t\tloaded: false,\n\n\t};\n\n})();\n\nconst gfx = (() => {\n\n\tconst gl = app.gl;\n\tconst defShader = makeShader(DEF_VERT, DEF_FRAG);\n\n\t// a 1x1 white texture to draw raw shapes like rectangles and polygons\n\t// we use a texture for those so we can use only 1 pipeline for drawing sprites + shapes\n\tconst emptyTex = makeTex(\n\t\tnew ImageData(new Uint8ClampedArray([ 255, 255, 255, 255, ]), 1, 1)\n\t);\n\n\tconst c = gopt.background ?? rgb(0, 0, 0);\n\n\tif (gopt.background) {\n\t\tconst c = Color.fromArray(gopt.background);\n\t\tgl.clearColor(c.r / 255, c.g / 255, c.b / 255, gopt.background[3] ?? 1);\n\t}\n\n\tgl.enable(gl.BLEND);\n\tgl.enable(gl.SCISSOR_TEST);\n\tgl.blendFuncSeparate(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE_MINUS_SRC_ALPHA);\n\n\t// we only use one vertex and index buffer that batches all draw calls\n\tconst vbuf = gl.createBuffer();\n\n\tgl.bindBuffer(gl.ARRAY_BUFFER, vbuf);\n\t// vec3 pos\n\tgl.vertexAttribPointer(0, 3, gl.FLOAT, false, STRIDE * 4, 0);\n\tgl.enableVertexAttribArray(0);\n\t// vec2 uv\n\tgl.vertexAttribPointer(1, 2, gl.FLOAT, false, STRIDE * 4, 12);\n\tgl.enableVertexAttribArray(1);\n\t// vec4 color\n\tgl.vertexAttribPointer(2, 4, gl.FLOAT, false, STRIDE * 4, 20);\n\tgl.enableVertexAttribArray(2);\n\tgl.bufferData(gl.ARRAY_BUFFER, QUEUE_COUNT * 4, gl.DYNAMIC_DRAW);\n\tgl.bindBuffer(gl.ARRAY_BUFFER, null);\n\n\tconst ibuf = gl.createBuffer();\n\n\tgl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibuf);\n\tgl.bufferData(gl.ELEMENT_ARRAY_BUFFER, QUEUE_COUNT * 2, gl.DYNAMIC_DRAW);\n\tgl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, null);\n\n\t// a checkerboard texture used for the default background\n\tconst bgTex = makeTex(\n\t\tnew ImageData(new Uint8ClampedArray([\n\t\t\t128, 128, 128, 255,\n\t\t\t190, 190, 190, 255,\n\t\t\t190, 190, 190, 255,\n\t\t\t128, 128, 128, 255,\n\t\t]), 2, 2), {\n\t\t\twrap: \"repeat\",\n\t\t\tfilter: \"nearest\",\n\t\t},\n\t);\n\n\treturn {\n\n\t\t// keep track of how many draw calls we're doing this frame\n\t\tdrawCalls: 0,\n\t\t// how many draw calls we're doing last frame, this is the number we give to users\n\t\tlastDrawCalls: 0,\n\n\t\t// gfx states\n\t\tdefShader: defShader,\n\t\tcurShader: defShader,\n\t\tdefTex: emptyTex,\n\t\tcurTex: emptyTex,\n\t\tcurUniform: {},\n\t\tvbuf: vbuf,\n\t\tibuf: ibuf,\n\n\t\t// local vertex / index buffer queue\n\t\tvqueue: [],\n\t\tiqueue: [],\n\n\t\ttransform: new Mat4(),\n\t\ttransformStack: [],\n\n\t\tbgTex: bgTex,\n\n\t\twidth: gopt.width,\n\t\theight: gopt.height,\n\n\t\tviewport: {\n\t\t\tx: 0,\n\t\t\ty: 0,\n\t\t\twidth: gl.drawingBufferWidth,\n\t\t\theight: gl.drawingBufferHeight,\n\t\t},\n\n\t};\n\n})();\n\nupdateViewport();\n\nconst audio = (() => {\n\n\t// TODO: handle when audio context is unavailable\n\tconst ctx = new (window.AudioContext || (window as any).webkitAudioContext)() as AudioContext\n\tconst masterNode = ctx.createGain();\n\tmasterNode.connect(ctx.destination);\n\n\t// by default browsers can only load audio async, we don't deal with that and just start with an empty audio buffer\n\tconst burpSnd = {\n\t\tbuf: createEmptyAudioBuffer(),\n\t};\n\n\t// load that burp sound\n\tctx.decodeAudioData(burpBytes.buffer.slice(0), (buf) => {\n\t\tburpSnd.buf = buf;\n\t}, () => {\n\t\tthrow new Error(\"Failed to load burp.\")\n\t});\n\n\treturn {\n\t\tctx,\n\t\tmasterNode,\n\t\tburpSnd,\n\t};\n\n})();\n\nconst assets = {\n\n\t// keep track of how many assets are loading / loaded, for calculaating progress\n\tnumLoading: 0,\n\tnumLoaded: 0,\n\n\t// prefix for when loading from a url\n\turlPrefix: \"\",\n\n\t// asset holders\n\tsprites: {},\n\tsounds: {},\n\tshaders: {},\n\tfonts: {},\n\n};\n\nconst game = {\n\n\t// event callbacks\n\tevents: {},\n\tobjEvents: {},\n\n\t// root game object\n\t// these transforms are used as camera\n\troot: make([]),\n\n\ttimers: new IDList<Timer>(),\n\n\t// misc\n\tlayers: {},\n\tdefLayer: null,\n\tgravity: DEF_GRAVITY,\n\ton<F>(ev: string, cb: F): EventCanceller {\n\t\tif (!this.events[ev]) {\n\t\t\tthis.events[ev] = new IDList();\n\t\t}\n\t\treturn this.events[ev].pushd(cb);\n\t},\n\ttrigger(ev: string, ...args) {\n\t\tif (this.events[ev]) {\n\t\t\tthis.events[ev].forEach((cb) => cb(...args));\n\t\t}\n\t},\n\tscenes: {},\n\n\t// on screen log\n\tlogs: [],\n\n\t// camera\n\tcam: {\n\t\tpos: center(),\n\t\tscale: vec2(1),\n\t\tangle: 0,\n\t\tshake: 0,\n\t\ttransform: new Mat4(),\n\t},\n\n}\n\n// wrap individual loaders with global loader counter, for stuff like progress bar\nfunction load<T>(prom: Promise<T>): Promise<T> {\n\n\tassets.numLoading++;\n\n\t// wrapping another layer of promise because we are catching errors here internally and we also want users be able to catch errors, however only one catch is allowed per promise chain\n\treturn new Promise((resolve, reject) => {\n\t\tprom\n\t\t\t.then(resolve)\n\t\t\t.catch((err) => {\n\t\t\t\tdebug.error(err);\n\t\t\t\treject(err);\n\t\t\t})\n\t\t\t.finally(() => {\n\t\t\t\tassets.numLoading--;\n\t\t\t\tassets.numLoaded++;\n\t\t\t});\n\t}) as Promise<T>;\n\n}\n\n// get current load progress\nfunction loadProgress(): number {\n\treturn assets.numLoaded / (assets.numLoading + assets.numLoaded);\n}\n\n// global load path prefix\nfunction loadRoot(path?: string): string {\n\tif (path !== undefined) {\n\t\tassets.urlPrefix = path;\n\t}\n\treturn assets.urlPrefix;\n}\n\n// wrapper around fetch() that applies urlPrefix and basic error handling\nfunction fetchURL(path: string) {\n\tconst url = assets.urlPrefix + path;\n\treturn fetch(url)\n\t\t.then((res) => {\n\t\t\tif (!res.ok) {\n\t\t\t\tthrow new Error(`Failed to fetch ${url}`);\n\t\t\t}\n\t\t\treturn res;\n\t\t});\n}\n\n// wrapper around image loader to get a Promise\nfunction loadImg(src: string): Promise<HTMLImageElement> {\n\tconst img = new Image();\n\timg.src = isDataURL(src) ? src : assets.urlPrefix + src;\n\timg.crossOrigin = \"anonymous\";\n\treturn new Promise<HTMLImageElement>((resolve, reject) => {\n\t\timg.onload = () => resolve(img);\n\t\t// TODO: truncate for long dataurl src\n\t\timg.onerror = () => reject(`Failed to load image from \"${src}\"`);\n\t});\n}\n\n// TODO: support SpriteLoadSrc\nfunction loadFont(\n\tname: string | null,\n\tsrc: string,\n\tgw: number,\n\tgh: number,\n\topt: FontLoadOpt = {},\n): Promise<FontData> {\n\treturn load(loadImg(src)\n\t\t.then((img) => {\n\t\t\tconst font = makeFont(\n\t\t\t\tmakeTex(img, opt),\n\t\t\t\tgw,\n\t\t\t\tgh,\n\t\t\t\topt.chars ?? ASCII_CHARS\n\t\t\t);\n\t\t\tif (name) {\n\t\t\t\tassets.fonts[name] = font;\n\t\t\t}\n\t\t\treturn font;\n\t\t})\n\t);\n}\n\nfunction getSprite(name: string): SpriteData | null {\n\treturn assets.sprites[name] ?? null;\n}\n\nfunction getSound(name: string): SoundData | null {\n\treturn assets.sounds[name] ?? null;\n}\n\nfunction getFont(name: string): FontData | null {\n\treturn assets.fonts[name] ?? null;\n}\n\nfunction getShader(name: string): ShaderData | null {\n\treturn assets.shaders[name] ?? null;\n}\n\n// get an array of frames based on configuration on how to slice the image\nfunction slice(x = 1, y = 1, dx = 0, dy = 0, w = 1, h = 1): Quad[] {\n\tconst frames = [];\n\tconst qw = w / x;\n\tconst qh = h / y;\n\tfor (let j = 0; j < y; j++) {\n\t\tfor (let i = 0; i < x; i++) {\n\t\t\tframes.push(new Quad(\n\t\t\t\tdx + i * qw,\n\t\t\t\tdy + j * qh,\n\t\t\t\tqw,\n\t\t\t\tqh,\n\t\t\t));\n\t\t}\n\t}\n\treturn frames;\n}\n\nfunction loadSpriteAtlas(\n\tsrc: SpriteLoadSrc,\n\tdata: SpriteAtlasData | string\n): Promise<Record<string, SpriteData>> {\n\tif (typeof data === \"string\") {\n\t\t// TODO: this adds a new loader asyncly\n\t\treturn load(fetchURL(data)\n\t\t\t.then((res) => res.json())\n\t\t\t.then((data2) => loadSpriteAtlas(src, data2)));\n\t}\n\treturn load(loadSprite(null, src).then((atlas) => {\n\t\tconst map = {};\n\t\tconst w = atlas.tex.width;\n\t\tconst h = atlas.tex.height;\n\t\tfor (const name in data) {\n\t\t\tconst info = data[name];\n\t\t\tconst spr = {\n\t\t\t\ttex: atlas.tex,\n\t\t\t\tframes: slice(info.sliceX, info.sliceY, info.x / w, info.y / h, info.width / w, info.height / h),\n\t\t\t\tanims: info.anims,\n\t\t\t}\n\t\t\tassets.sprites[name] = spr;\n\t\t\tmap[name] = spr;\n\t\t}\n\t\treturn map;\n\t}));\n}\n\n// synchronously load sprite from local pixel data\nfunction loadRawSprite(\n\tname: string | null,\n\tsrc: GfxTexData,\n\topt: SpriteLoadOpt = {}\n) {\n\n\tconst tex = makeTex(src, opt);\n\tconst frames = slice(opt.sliceX || 1, opt.sliceY || 1);\n\n\tconst sprite = {\n\t\ttex: tex,\n\t\tframes: frames,\n\t\tanims: opt.anims || {},\n\t};\n\n\tif (name) {\n\t\tassets.sprites[name] = sprite;\n\t}\n\n\treturn sprite;\n\n}\n\n// load a sprite to asset manager\nfunction loadSprite(\n\tname: string | null,\n\tsrc: SpriteLoadSrc,\n\topt: SpriteLoadOpt = {\n\t\tsliceX: 1,\n\t\tsliceY: 1,\n\t\tanims: {},\n\t},\n): Promise<SpriteData> {\n\n\treturn load(new Promise<SpriteData>((resolve, reject) => {\n\n\t\tif (!src) {\n\t\t\treturn reject(`Expected sprite src for \"${name}\"`);\n\t\t}\n\n\t\t// from url\n\t\tif (typeof(src) === \"string\") {\n\t\t\tloadImg(src)\n\t\t\t\t.then((img) => resolve(loadRawSprite(name, img, opt)))\n\t\t\t\t.catch(reject);\n\t\t} else {\n\t\t\tresolve(loadRawSprite(name, src, opt));\n\t\t}\n\n\t}));\n\n}\n\n// TODO: accept raw json\nfunction loadPedit(name: string, src: string): Promise<SpriteData> {\n\n\treturn load(new Promise<SpriteData>((resolve, reject) => {\n\n\t\tfetchURL(src)\n\t\t\t.then((res) => res.json())\n\t\t\t.then(async (data) => {\n\n\t\t\t\tconst images = await Promise.all(data.frames.map(loadImg));\n\t\t\t\tconst canvas = document.createElement(\"canvas\");\n\t\t\t\tcanvas.width = data.width;\n\t\t\t\tcanvas.height = data.height * data.frames.length;\n\n\t\t\t\tconst ctx = canvas.getContext(\"2d\");\n\n\t\t\t\timages.forEach((img: HTMLImageElement, i) => {\n\t\t\t\t\tctx.drawImage(img, 0, i * data.height);\n\t\t\t\t});\n\n\t\t\t\treturn loadSprite(name, canvas, {\n\t\t\t\t\tsliceY: data.frames.length,\n\t\t\t\t\tanims: data.anims,\n\t\t\t\t});\n\t\t\t})\n\t\t\t.then(resolve)\n\t\t\t.catch(reject)\n\t\t\t;\n\n\t}));\n\n}\n\n// TODO: accept raw json\nfunction loadAseprite(\n\tname: string | null,\n\timgSrc: SpriteLoadSrc,\n\tjsonSrc: string\n): Promise<SpriteData> {\n\n\treturn load(new Promise<SpriteData>((resolve, reject) => {\n\n\t\tloadSprite(name, imgSrc)\n\t\t\t.then((sprite: SpriteData) => {\n\t\t\t\tfetchURL(jsonSrc)\n\t\t\t\t\t.then((res) => res.json())\n\t\t\t\t\t.then((data) => {\n\t\t\t\t\t\tconst size = data.meta.size;\n\t\t\t\t\t\tsprite.frames = data.frames.map((f: any) => {\n\t\t\t\t\t\t\treturn new Quad(\n\t\t\t\t\t\t\t\tf.frame.x / size.w,\n\t\t\t\t\t\t\t\tf.frame.y / size.h,\n\t\t\t\t\t\t\t\tf.frame.w / size.w,\n\t\t\t\t\t\t\t\tf.frame.h / size.h,\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t});\n\t\t\t\t\t\tfor (const anim of data.meta.frameTags) {\n\t\t\t\t\t\t\tif (anim.from === anim.to) {\n\t\t\t\t\t\t\t\tsprite.anims[anim.name] = anim.from\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tsprite.anims[anim.name] = {\n\t\t\t\t\t\t\t\t\tfrom: anim.from,\n\t\t\t\t\t\t\t\t\tto: anim.to,\n\t\t\t\t\t\t\t\t\t// TODO: let users define these\n\t\t\t\t\t\t\t\t\tspeed: 10,\n\t\t\t\t\t\t\t\t\tloop: true,\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresolve(sprite);\n\t\t\t\t\t})\n\t\t\t\t\t.catch(reject)\n\t\t\t\t\t;\n\t\t\t})\n\t\t\t.catch(reject);\n\n\t}));\n\n}\n\nfunction loadShader(\n\tname: string | null,\n\tvert?: string,\n\tfrag?: string,\n\tisUrl: boolean = false,\n): Promise<ShaderData> {\n\n\tfunction loadRawShader(\n\t\tname: string | null,\n\t\tvert: string | null,\n\t\tfrag: string | null,\n\t): ShaderData {\n\t\tconst shader = makeShader(vert, frag);\n\t\tif (name) {\n\t\t\tassets.shaders[name] = shader;\n\t\t}\n\t\treturn shader;\n\t}\n\n\treturn load(new Promise<ShaderData>((resolve, reject) => {\n\n\t\tif (!vert && !frag) {\n\t\t\treturn reject(\"no shader\");\n\t\t}\n\n\t\tfunction resolveUrl(url?: string) {\n\t\t\treturn url ?\n\t\t\t\tfetchURL(url)\n\t\t\t\t\t.then((res) => res.text())\n\t\t\t\t\t.catch(reject)\n\t\t\t\t: new Promise((r) => r(null));\n\t\t}\n\n\t\tif (isUrl) {\n\t\t\tPromise.all([resolveUrl(vert), resolveUrl(frag)])\n\t\t\t\t.then(([vcode, fcode]: [string | null, string | null]) => {\n\t\t\t\t\tresolve(loadRawShader(name, vcode, fcode));\n\t\t\t\t})\n\t\t\t\t.catch(reject);\n\t\t} else {\n\t\t\ttry {\n\t\t\t\tresolve(loadRawShader(name, vert, frag));\n\t\t\t} catch (err) {\n\t\t\t\treject(err);\n\t\t\t}\n\t\t}\n\n\t}));\n\n}\n\n// TODO: accept dataurl\n// load a sound to asset manager\nfunction loadSound(\n\tname: string | null,\n\tsrc: string,\n): Promise<SoundData> {\n\n\treturn load(new Promise<SoundData>((resolve, reject) => {\n\n\t\tif (!src) {\n\t\t\treturn reject(`expected sound src for \"${name}\"`);\n\t\t}\n\n\t\t// from url\n\t\tif (typeof(src) === \"string\") {\n\t\t\tfetchURL(src)\n\t\t\t\t.then((res) => res.arrayBuffer())\n\t\t\t\t.then((data) => {\n\t\t\t\t\treturn new Promise((resolve2, reject2) =>\n\t\t\t\t\t\taudio.ctx.decodeAudioData(data, resolve2, reject2)\n\t\t\t\t\t);\n\t\t\t\t})\n\t\t\t\t.then((buf: AudioBuffer) => {\n\t\t\t\t\tconst snd = {\n\t\t\t\t\t\tbuf: buf,\n\t\t\t\t\t}\n\t\t\t\t\tif (name) {\n\t\t\t\t\t\tassets.sounds[name] = snd;\n\t\t\t\t\t}\n\t\t\t\t\tresolve(snd);\n\t\t\t\t})\n\t\t\t\t.catch(reject);\n\t\t}\n\n\t}));\n\n}\n\nfunction loadBean(name: string = \"bean\"): Promise<SpriteData> {\n\treturn loadSprite(name, beanSrc);\n}\n\n// get / set master volume\nfunction volume(v?: number): number {\n\tif (v !== undefined) {\n\t\taudio.masterNode.gain.value = clamp(v, MIN_GAIN, MAX_GAIN);\n\t}\n\treturn audio.masterNode.gain.value;\n}\n\n// plays a sound, returns a control handle\nfunction play(\n\tsrc: SoundData | string,\n\topt: AudioPlayOpt = {\n\t\tloop: false,\n\t\tvolume: 1,\n\t\tspeed: 1,\n\t\tdetune: 0,\n\t\tseek: 0,\n\t},\n): AudioPlay {\n\n\t// TODO: clean?\n\tif (typeof src === \"string\") {\n\n\t\tconst pb = play({\n\t\t\tbuf: createEmptyAudioBuffer(),\n\t\t});\n\n\t\tonLoad(() => {\n\t\t\tconst snd = assets.sounds[src];\n\t\t\tif (!snd) {\n\t\t\t\tthrow new Error(`Sound not found: \"${src}\"`);\n\t\t\t}\n\t\t\tconst pb2 = play(snd, opt);\n\t\t\tfor (const k in pb2) {\n\t\t\t\tpb[k] = pb2[k];\n\t\t\t}\n\t\t});\n\n\t\treturn pb;\n\n\t}\n\n\tconst ctx = audio.ctx;\n\tlet stopped = false;\n\tlet srcNode = ctx.createBufferSource();\n\n\tsrcNode.buffer = src.buf;\n\tsrcNode.loop = opt.loop ? true : false;\n\n\tconst gainNode = ctx.createGain();\n\n\tsrcNode.connect(gainNode);\n\tgainNode.connect(audio.masterNode);\n\n\tconst pos = opt.seek ?? 0;\n\n\tsrcNode.start(0, pos);\n\n\tlet startTime = ctx.currentTime - pos;\n\tlet stopTime: number | null = null;\n\n\tconst handle = {\n\n\t\tstop() {\n\t\t\tif (stopped) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.pause();\n\t\t\tstartTime = ctx.currentTime;\n\t\t},\n\n\t\tplay(seek?: number) {\n\n\t\t\tif (!stopped) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst oldNode = srcNode;\n\n\t\t\tsrcNode = ctx.createBufferSource();\n\t\t\tsrcNode.buffer = oldNode.buffer;\n\t\t\tsrcNode.loop = oldNode.loop;\n\t\t\tsrcNode.playbackRate.value = oldNode.playbackRate.value;\n\n\t\t\tif (srcNode.detune) {\n\t\t\t\tsrcNode.detune.value = oldNode.detune.value;\n\t\t\t}\n\n\t\t\tsrcNode.connect(gainNode);\n\n\t\t\tconst pos = seek ?? this.time();\n\n\t\t\tsrcNode.start(0, pos);\n\t\t\tstartTime = ctx.currentTime - pos;\n\t\t\tstopped = false;\n\t\t\tstopTime = null;\n\n\t\t},\n\n\t\tpause() {\n\t\t\tif (stopped) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tsrcNode.stop();\n\t\t\tstopped = true;\n\t\t\tstopTime = ctx.currentTime;\n\t\t},\n\n\t\tisPaused(): boolean {\n\t\t\treturn stopped;\n\t\t},\n\n\t\tpaused(): boolean {\n\t\t\tdeprecateMsg(\"paused()\", \"isPaused()\");\n\t\t\treturn this.isPaused();\n\t\t},\n\n\t\tisStopped(): boolean {\n\t\t\treturn stopped;\n\t\t},\n\n\t\tstopped(): boolean {\n\t\t\tdeprecateMsg(\"stopped()\", \"isStopped()\");\n\t\t\treturn this.isStopped();\n\t\t},\n\n\t\t// TODO: affect time()\n\t\tspeed(val?: number): number {\n\t\t\tif (val !== undefined) {\n\t\t\t\tsrcNode.playbackRate.value = clamp(val, MIN_SPEED, MAX_SPEED);\n\t\t\t}\n\t\t\treturn srcNode.playbackRate.value;\n\t\t},\n\n\t\tdetune(val?: number): number {\n\t\t\tif (!srcNode.detune) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tif (val !== undefined) {\n\t\t\t\tsrcNode.detune.value = clamp(val, MIN_DETUNE, MAX_DETUNE);\n\t\t\t}\n\t\t\treturn srcNode.detune.value;\n\t\t},\n\n\t\tvolume(val?: number): number {\n\t\t\tif (val !== undefined) {\n\t\t\t\tgainNode.gain.value = clamp(val, MIN_GAIN, MAX_GAIN);\n\t\t\t}\n\t\t\treturn gainNode.gain.value;\n\t\t},\n\n\t\tloop() {\n\t\t\tsrcNode.loop = true;\n\t\t},\n\n\t\tunloop() {\n\t\t\tsrcNode.loop = false;\n\t\t},\n\n\t\tduration(): number {\n\t\t\treturn src.buf.duration;\n\t\t},\n\n\t\ttime(): number {\n\t\t\tif (stopped) {\n\t\t\t\treturn stopTime - startTime;\n\t\t\t} else {\n\t\t\t\treturn ctx.currentTime - startTime;\n\t\t\t}\n\t\t},\n\n\t};\n\n\thandle.speed(opt.speed);\n\thandle.detune(opt.detune);\n\thandle.volume(opt.volume);\n\n\treturn handle;\n\n}\n\n// core kaboom logic\nfunction burp(opt?: AudioPlayOpt): AudioPlay {\n\treturn play(audio.burpSnd, opt);\n}\n\n// TODO: take these webgl structures out pure\nfunction makeTex(\n\tdata: GfxTexData,\n\topt: GfxTexOpt = {}\n): GfxTexture {\n\n\tconst gl = app.gl;\n\tconst id = gl.createTexture();\n\n\tgl.bindTexture(gl.TEXTURE_2D, id);\n\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, data);\n\n\tconst filter = (() => {\n\t\tswitch (opt.filter ?? gopt.texFilter) {\n\t\t\tcase \"linear\": return gl.LINEAR;\n\t\t\tcase \"nearest\": return gl.NEAREST;\n\t\t\tdefault: return gl.NEAREST;\n\t\t}\n\t})();\n\n\tconst wrap = (() => {\n\t\tswitch (opt.wrap) {\n\t\t\tcase \"repeat\": return gl.REPEAT;\n\t\t\tcase \"clampToEdge\": return gl.CLAMP_TO_EDGE;\n\t\t\tdefault: return gl.CLAMP_TO_EDGE;\n\t\t}\n\t})();\n\n\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filter);\n\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filter);\n\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, wrap);\n\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, wrap);\n\tgl.bindTexture(gl.TEXTURE_2D, null);\n\n\treturn {\n\t\twidth: data.width,\n\t\theight: data.height,\n\t\tbind() {\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, id);\n\t\t},\n\t\tunbind() {\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, null);\n\t\t},\n\t};\n\n}\n\nfunction makeShader(\n\tvertSrc: string | null = DEF_VERT,\n\tfragSrc: string | null = DEF_FRAG,\n): GfxShader {\n\n\tconst gl = app.gl;\n\tlet msg;\n\tconst vcode = VERT_TEMPLATE.replace(\"{{user}}\", vertSrc ?? DEF_VERT);\n\tconst fcode = FRAG_TEMPLATE.replace(\"{{user}}\", fragSrc ?? DEF_FRAG);\n\tconst vertShader = gl.createShader(gl.VERTEX_SHADER);\n\tconst fragShader = gl.createShader(gl.FRAGMENT_SHADER);\n\n\tgl.shaderSource(vertShader, vcode);\n\tgl.shaderSource(fragShader, fcode);\n\tgl.compileShader(vertShader);\n\tgl.compileShader(fragShader);\n\n\tif ((msg = gl.getShaderInfoLog(vertShader))) {\n\t\tthrow new Error(msg);\n\t}\n\n\tif ((msg = gl.getShaderInfoLog(fragShader))) {\n\t\tthrow new Error(msg);\n\t}\n\n\tconst id = gl.createProgram();\n\n\tgl.attachShader(id, vertShader);\n\tgl.attachShader(id, fragShader);\n\n\tgl.bindAttribLocation(id, 0, \"a_pos\");\n\tgl.bindAttribLocation(id, 1, \"a_uv\");\n\tgl.bindAttribLocation(id, 2, \"a_color\");\n\n\tgl.linkProgram(id);\n\n\tif ((msg = gl.getProgramInfoLog(id))) {\n\t\t// for some reason on safari it always has a \"\\n\" msg\n\t\tif (msg !== \"\\n\") {\n\t\t\tthrow new Error(msg);\n\t\t}\n\t}\n\n\treturn {\n\n\t\tbind() {\n\t\t\tgl.useProgram(id);\n\t\t},\n\n\t\tunbind() {\n\t\t\tgl.useProgram(null);\n\t\t},\n\n\t\tsend(uniform: Uniform) {\n\t\t\tthis.bind();\n\t\t\tfor (const name in uniform) {\n\t\t\t\tconst val = uniform[name];\n\t\t\t\tconst loc = gl.getUniformLocation(id, name);\n\t\t\t\tif (typeof val === \"number\") {\n\t\t\t\t\tgl.uniform1f(loc, val);\n\t\t\t\t} else if (val instanceof Mat4) {\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\tgl.uniformMatrix4fv(loc, false, new Float32Array(val.m));\n\t\t\t\t} else if (val instanceof Color) {\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\tgl.uniform4f(loc, val.r, val.g, val.b, val.a);\n\t\t\t\t} else if (val instanceof Vec3) {\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\tgl.uniform3f(loc, val.x, val.y, val.z);\n\t\t\t\t} else if (val instanceof Vec2) {\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\tgl.uniform2f(loc, val.x, val.y);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.unbind();\n\t\t},\n\n\t};\n\n}\n\nfunction makeFont(\n\ttex: GfxTexture,\n\tgw: number,\n\tgh: number,\n\tchars: string,\n): GfxFont {\n\n\tconst cols = tex.width / gw;\n\tconst rows = tex.height / gh;\n\tconst qw = 1.0 / cols;\n\tconst qh = 1.0 / rows;\n\tconst map: Record<string, Vec2> = {};\n\tconst charMap = chars.split(\"\").entries();\n\n\tfor (const [i, ch] of charMap) {\n\t\tmap[ch] = vec2(\n\t\t\t(i % cols) * qw,\n\t\t\tMath.floor(i / cols) * qh,\n\t\t);\n\t}\n\n\treturn {\n\t\ttex: tex,\n\t\tmap: map,\n\t\tqw: qw,\n\t\tqh: qh,\n\t};\n\n}\n\n// TODO: expose\nfunction drawRaw(\n\tverts: Vertex[],\n\tindices: number[],\n\tfixed: boolean,\n\ttex: GfxTexture = gfx.defTex,\n\tshader: GfxShader = gfx.defShader,\n\tuniform: Uniform = {},\n) {\n\n\ttex = tex ?? gfx.defTex;\n\tshader = shader ?? gfx.defShader;\n\n\t// flush on texture / shader change and overflow\n\tif (\n\t\ttex !== gfx.curTex\n\t\t|| shader !== gfx.curShader\n\t\t|| !deepEq(gfx.curUniform, uniform)\n\t\t|| gfx.vqueue.length + verts.length * STRIDE > QUEUE_COUNT\n\t\t|| gfx.iqueue.length + indices.length > QUEUE_COUNT\n\t) {\n\t\tflush();\n\t}\n\n\tfor (const v of verts) {\n\n\t\t// TODO: cache camTransform * gfxTransform?\n\t\tconst transform = fixed ? gfx.transform : game.cam.transform.mult(gfx.transform);\n\n\t\t// normalized world space coordinate [-1.0 ~ 1.0]\n\t\tconst pt = screen2ndc(transform.multVec2(v.pos.xy()));\n\n\t\tgfx.vqueue.push(\n\t\t\tpt.x, pt.y, v.pos.z,\n\t\t\tv.uv.x, v.uv.y,\n\t\t\tv.color.r / 255, v.color.g / 255, v.color.b / 255, v.opacity,\n\t\t);\n\n\t}\n\n\tfor (const i of indices) {\n\t\tgfx.iqueue.push(i + gfx.vqueue.length / STRIDE - verts.length);\n\t}\n\n\tgfx.curTex = tex;\n\tgfx.curShader = shader;\n\tgfx.curUniform = uniform;\n\n}\n\n// draw all batched shapes\nfunction flush() {\n\n\tif (\n\t\t!gfx.curTex\n\t\t|| !gfx.curShader\n\t\t|| gfx.vqueue.length === 0\n\t\t|| gfx.iqueue.length === 0\n\t) {\n\t\treturn;\n\t}\n\n\tconst gl = app.gl;\n\n\tgfx.curShader.send(gfx.curUniform);\n\tgl.bindBuffer(gl.ARRAY_BUFFER, gfx.vbuf);\n\tgl.bufferSubData(gl.ARRAY_BUFFER, 0, new Float32Array(gfx.vqueue));\n\tgl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gfx.ibuf);\n\tgl.bufferSubData(gl.ELEMENT_ARRAY_BUFFER, 0, new Uint16Array(gfx.iqueue));\n\tgfx.curShader.bind();\n\tgfx.curTex.bind();\n\tgl.drawElements(gl.TRIANGLES, gfx.iqueue.length, gl.UNSIGNED_SHORT, 0);\n\tgfx.curTex.unbind();\n\tgfx.curShader.unbind();\n\tgl.bindBuffer(gl.ARRAY_BUFFER, null);\n\tgl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, null);\n\n\tgfx.iqueue = [];\n\tgfx.vqueue = [];\n\n\tgfx.drawCalls++;\n\n}\n\n// start a rendering frame, reset some states\nfunction frameStart() {\n\n\tapp.gl.clear(app.gl.COLOR_BUFFER_BIT);\n\n\tif (!gopt.background) {\n\t\tdrawUVQuad({\n\t\t\twidth: width(),\n\t\t\theight: height(),\n\t\t\tquad: new Quad(\n\t\t\t\t0,\n\t\t\t\t0,\n\t\t\t\twidth() * app.scale / BG_GRID_SIZE,\n\t\t\t\theight() * app.scale / BG_GRID_SIZE,\n\t\t\t),\n\t\t\ttex: gfx.bgTex,\n\t\t\tfixed: true,\n\t\t})\n\t}\n\n\tgfx.drawCalls = 0;\n\tgfx.transformStack = [];\n\tgfx.transform = new Mat4();\n\n}\n\nfunction frameEnd() {\n\tflush();\n\tgfx.lastDrawCalls = gfx.drawCalls;\n}\n\nfunction drawCalls() {\n\treturn gfx.lastDrawCalls;\n}\n\n// convert a screen space coordinate to webgl normalized device coordinate\nfunction screen2ndc(pt: Vec2): Vec2 {\n\treturn vec2(\n\t\tpt.x / width() * 2 - 1,\n\t\t-pt.y / height() * 2 + 1,\n\t);\n}\n\n// convert a webgl normalied device coordinate to screen space coordinate\nfunction ndc2screen(pt: Vec2): Vec2 {\n\treturn vec2(\n\t\t(pt.x + 1) / 2 * width(),\n\t\t-(pt.y - 1) / 2 * height(),\n\t);\n}\n\nfunction applyMatrix(m: Mat4) {\n\tgfx.transform = m.clone();\n}\n\nfunction pushTranslate(...args) {\n\tif (args[0] === undefined) return;\n\tconst p = vec2(...args);\n\tif (p.x === 0 && p.y === 0) return;\n\tgfx.transform = gfx.transform.translate(p);\n}\n\nfunction pushScale(...args) {\n\tif (args[0] === undefined) return;\n\tconst p = vec2(...args);\n\tif (p.x === 1 && p.y === 1) return;\n\tgfx.transform = gfx.transform.scale(p);\n}\n\nfunction pushRotateX(a: number) {\n\tif (!a) {\n\t\treturn;\n\t}\n\tgfx.transform = gfx.transform.rotateX(a);\n}\n\nfunction pushRotateY(a: number) {\n\tif (!a) {\n\t\treturn;\n\t}\n\tgfx.transform = gfx.transform.rotateY(a);\n}\n\nfunction pushRotateZ(a: number) {\n\tif (!a) {\n\t\treturn;\n\t}\n\tgfx.transform = gfx.transform.rotateZ(a);\n}\n\nfunction pushTransform() {\n\tgfx.transformStack.push(gfx.transform.clone());\n}\n\nfunction popTransform() {\n\tif (gfx.transformStack.length > 0) {\n\t\tgfx.transform = gfx.transformStack.pop();\n\t}\n}\n\n// draw a uv textured quad\nfunction drawUVQuad(opt: DrawUVQuadOpt) {\n\n\tif (opt.width === undefined || opt.height === undefined) {\n\t\tthrow new Error(\"drawUVQuad() requires property \\\"width\\\" and \\\"height\\\".\");\n\t}\n\n\tif (opt.width <= 0 || opt.height <= 0) {\n\t\treturn;\n\t}\n\n\tconst w = opt.width;\n\tconst h = opt.height;\n\tconst origin = originPt(opt.origin || DEF_ORIGIN);\n\tconst offset = origin.scale(vec2(w, h).scale(-0.5));\n\tconst q = opt.quad || new Quad(0, 0, 1, 1);\n\tconst color = opt.color || rgb(255, 255, 255);\n\tconst opacity = opt.opacity ?? 1;\n\n\tpushTransform();\n\tpushTranslate(opt.pos);\n\tpushRotateZ(opt.angle);\n\tpushScale(opt.scale);\n\tpushTranslate(offset);\n\n\tdrawRaw([\n\t\t{\n\t\t\tpos: vec3(-w / 2, h / 2, 0),\n\t\t\tuv: vec2(opt.flipX ? q.x + q.w : q.x, opt.flipY ? q.y : q.y + q.h),\n\t\t\tcolor: color,\n\t\t\topacity: opacity,\n\t\t},\n\t\t{\n\t\t\tpos: vec3(-w / 2, -h / 2, 0),\n\t\t\tuv: vec2(opt.flipX ? q.x + q.w : q.x, opt.flipY ? q.y + q.h : q.y),\n\t\t\tcolor: color,\n\t\t\topacity: opacity,\n\t\t},\n\t\t{\n\t\t\tpos: vec3(w / 2, -h / 2, 0),\n\t\t\tuv: vec2(opt.flipX ? q.x : q.x + q.w, opt.flipY ? q.y + q.h : q.y),\n\t\t\tcolor: color,\n\t\t\topacity: opacity,\n\t\t},\n\t\t{\n\t\t\tpos: vec3(w / 2, h / 2, 0),\n\t\t\tuv: vec2(opt.flipX ? q.x : q.x + q.w, opt.flipY ? q.y : q.y + q.h),\n\t\t\tcolor: color,\n\t\t\topacity: opacity,\n\t\t},\n\t], [0, 1, 3, 1, 2, 3], opt.fixed, opt.tex, opt.shader, opt.uniform);\n\n\tpopTransform();\n\n}\n\n// TODO: clean\nfunction drawTexture(opt: DrawTextureOpt) {\n\n\tif (!opt.tex) {\n\t\tthrow new Error(\"drawTexture() requires property \\\"tex\\\".\");\n\t}\n\n\tconst q = opt.quad ?? new Quad(0, 0, 1, 1);\n\tconst w = opt.tex.width * q.w;\n\tconst h = opt.tex.height * q.h;\n\tconst scale = vec2(1);\n\n\tif (opt.tiled) {\n\n\t\t// TODO: draw fract\n\t\tconst repX = Math.ceil((opt.width || w) / w);\n\t\tconst repY = Math.ceil((opt.height || h) / h);\n\t\tconst origin = originPt(opt.origin || DEF_ORIGIN).add(vec2(1, 1)).scale(0.5);\n\t\tconst offset = origin.scale(repX * w, repY * h);\n\n\t\t// TODO: rotation\n\t\tfor (let i = 0; i < repX; i++) {\n\t\t\tfor (let j = 0; j < repY; j++) {\n\t\t\t\tdrawUVQuad({\n\t\t\t\t\t...opt,\n\t\t\t\t\tpos: (opt.pos || vec2(0)).add(vec2(w * i, h * j)).sub(offset),\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\tscale: scale.scale(opt.scale || vec2(1)),\n\t\t\t\t\ttex: opt.tex,\n\t\t\t\t\tquad: q,\n\t\t\t\t\twidth: w,\n\t\t\t\t\theight: h,\n\t\t\t\t\torigin: \"topleft\",\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t} else {\n\n\t\t// TODO: should this ignore scale?\n\t\tif (opt.width && opt.height) {\n\t\t\tscale.x = opt.width / w;\n\t\t\tscale.y = opt.height / h;\n\t\t} else if (opt.width) {\n\t\t\tscale.x = opt.width / w;\n\t\t\tscale.y = scale.x;\n\t\t} else if (opt.height) {\n\t\t\tscale.y = opt.height / h;\n\t\t\tscale.x = scale.y;\n\t\t}\n\n\t\tdrawUVQuad({\n\t\t\t...opt,\n\t\t\t// @ts-ignore\n\t\t\tscale: scale.scale(opt.scale || vec2(1)),\n\t\t\ttex: opt.tex,\n\t\t\tquad: q,\n\t\t\twidth: w,\n\t\t\theight: h,\n\t\t});\n\n\t}\n\n}\n\n// TODO: use native asset loader tracking\nconst loading = new Set();\n\nfunction drawSprite(opt: DrawSpriteOpt) {\n\n\tif (!opt.sprite) {\n\t\tthrow new Error(`drawSprite() requires property \"sprite\"`);\n\t}\n\n\tconst spr = findAsset(opt.sprite, assets.sprites);\n\n\tif (!spr) {\n\n\t\t// if passes a source url, we load it implicitly\n\t\tif (typeof opt.sprite === \"string\") {\n\t\t\tif (!loading.has(opt.sprite)) {\n\t\t\t\tloading.add(opt.sprite);\n\t\t\t\tloadSprite(opt.sprite, opt.sprite)\n\t\t\t\t\t.then((a) => loading.delete(opt.sprite));\n\t\t\t}\n\t\t\treturn;\n\t\t} else {\n\t\t\tthrow new Error(`sprite not found: \"${opt.sprite}\"`);\n\t\t}\n\n\t}\n\n\tconst q = spr.frames[opt.frame ?? 0];\n\n\tif (!q) {\n\t\tthrow new Error(`frame not found: ${opt.frame ?? 0}`);\n\t}\n\n\tdrawTexture({\n\t\t...opt,\n\t\ttex: spr.tex,\n\t\tquad: q.scale(opt.quad || new Quad(0, 0, 1, 1)),\n\t\tuniform: opt.uniform,\n\t});\n\n}\n\n// generate vertices to form an arc\nfunction getArcPts(\n\tpos: Vec2,\n\tradiusX: number,\n\tradiusY: number,\n\tstart: number,\n\tend: number,\n\tres: number = 1,\n): Vec2[] {\n\n\t// normalize and turn start and end angles to radians\n\tstart = deg2rad(start % 360);\n\tend = deg2rad(end % 360);\n\tif (end <= start) end += Math.PI * 2;\n\n\t// TODO: better way to get this?\n\t// the number of vertices is sqrt(r1 + r2) * 3 * res with a minimum of 16\n\tconst nverts = Math.ceil(Math.max(Math.sqrt(radiusX + radiusY) * 3 * (res || 1), 16));\n\tconst step = (end - start) / nverts;\n\tconst pts = [];\n\n\t// calculate vertices\n\tfor (let a = start; a < end; a += step) {\n\t\tpts.push(pos.add(radiusX * Math.cos(a), radiusY * Math.sin(a)));\n\t}\n\n\t// doing this on the side due to possible floating point inaccuracy\n\tpts.push(pos.add(radiusX * Math.cos(end), radiusY * Math.sin(end)));\n\n\treturn pts;\n\n}\n\nfunction drawRect(opt: DrawRectOpt) {\n\n\tif (opt.width === undefined || opt.height === undefined) {\n\t\tthrow new Error(\"drawRect() requires property \\\"width\\\" and \\\"height\\\".\");\n\t}\n\n\tif (opt.width <= 0 || opt.height <= 0) {\n\t\treturn;\n\t}\n\n\tconst w = opt.width;\n\tconst h = opt.height;\n\tconst origin = originPt(opt.origin || DEF_ORIGIN).add(1, 1);\n\tconst offset = origin.scale(vec2(w, h).scale(-0.5));\n\n\tlet pts = [\n\t\tvec2(0, 0),\n\t\tvec2(w, 0),\n\t\tvec2(w, h),\n\t\tvec2(0, h),\n\t];\n\n\t// TODO: drawPolygon should handle generic rounded corners\n\tif (opt.radius) {\n\n\t\t// maxium radius is half the shortest side\n\t\tconst r = Math.min(Math.min(w, h) / 2, opt.radius);\n\n\t\tpts = [\n\t\t\tvec2(r, 0),\n\t\t\tvec2(w - r, 0),\n\t\t\t...getArcPts(vec2(w - r, r), r, r, 270, 360),\n\t\t\tvec2(w, r),\n\t\t\tvec2(w, h - r),\n\t\t\t...getArcPts(vec2(w - r, h - r), r, r, 0, 90),\n\t\t\tvec2(w - r, h),\n\t\t\tvec2(r, h),\n\t\t\t...getArcPts(vec2(r, h - r), r, r, 90, 180),\n\t\t\tvec2(0, h - r),\n\t\t\tvec2(0, r),\n\t\t\t...getArcPts(vec2(r, r), r, r, 180, 270),\n\t\t];\n\n\t}\n\n\tdrawPolygon({ ...opt, offset, pts });\n\n}\n\nfunction drawLine(opt: DrawLineOpt) {\n\n\tconst { p1, p2 } = opt;\n\n\tif (!p1 || !p2) {\n\t\tthrow new Error(\"drawLine() requires properties \\\"p1\\\" and \\\"p2\\\".\");\n\t}\n\n\tconst w = opt.width || 1;\n\n\t// the displacement from the line end point to the corner point\n\tconst dis = p2.sub(p1).unit().normal().scale(w * 0.5);\n\n\t// calculate the 4 corner points of the line polygon\n\tconst verts = [\n\t\tp1.sub(dis),\n\t\tp1.add(dis),\n\t\tp2.add(dis),\n\t\tp2.sub(dis),\n\t].map((p) => ({\n\t\tpos: vec3(p.x, p.y, 0),\n\t\tuv: vec2(0),\n\t\tcolor: opt.color ?? Color.WHITE,\n\t\topacity: opt.opacity ?? 1,\n\t}));\n\n\tdrawRaw(verts, [0, 1, 3, 1, 2, 3], opt.fixed, gfx.defTex, opt.shader, opt.uniform);\n\n}\n\nfunction drawLines(opt: DrawLinesOpt) {\n\n\tconst pts = opt.pts;\n\n\tif (!pts) {\n\t\tthrow new Error(\"drawLines() requires property \\\"pts\\\".\");\n\t}\n\n\tif (pts.length < 2) {\n\t\treturn;\n\t}\n\n\tif (opt.radius && pts.length >= 3) {\n\n\t\t// TODO: rounded vertices for arbitury polygonic shape\n\t\tlet minLen = pts[0].dist(pts[1]);\n\n\t\tfor (let i = 1; i < pts.length - 1; i++) {\n\t\t\tminLen = Math.min(pts[i].dist(pts[i + 1]), minLen);\n\t\t}\n\n\t\tconst radius = Math.min(opt.radius, minLen / 2);\n\n\t\tdrawLine({ ...opt, p1: pts[0], p2: pts[1], });\n\n\t\tfor (let i = 1; i < pts.length - 2; i++) {\n\t\t\tconst p1 = pts[i];\n\t\t\tconst p2 = pts[i + 1];\n\t\t\tdrawLine({\n\t\t\t\t...opt,\n\t\t\t\tp1: p1,\n\t\t\t\tp2: p2,\n\t\t\t});\n\t\t}\n\n\t\tdrawLine({ ...opt, p1: pts[pts.length - 2], p2: pts[pts.length - 1], });\n\n\t} else {\n\n\t\tfor (let i = 0; i < pts.length - 1; i++) {\n\t\t\tdrawLine({\n\t\t\t\t...opt,\n\t\t\t\tp1: pts[i],\n\t\t\t\tp2: pts[i + 1],\n\t\t\t});\n\t\t}\n\n\t}\n\n}\n\nfunction drawTriangle(opt: DrawTriangleOpt) {\n\tif (!opt.p1 || !opt.p2 || !opt.p3) {\n\t\tthrow new Error(\"drawPolygon() requires properties \\\"p1\\\", \\\"p2\\\" and \\\"p3\\\".\");\n\t}\n\treturn drawPolygon({\n\t\t...opt,\n\t\tpts: [opt.p1, opt.p2, opt.p3],\n\t});\n}\n\n// TODO: origin\nfunction drawCircle(opt: DrawCircleOpt) {\n\n\tif (!opt.radius) {\n\t\tthrow new Error(\"drawCircle() requires property \\\"radius\\\".\");\n\t}\n\n\tif (opt.radius === 0) {\n\t\treturn;\n\t}\n\n\tdrawEllipse({\n\t\t...opt,\n\t\tradiusX: opt.radius,\n\t\tradiusY: opt.radius,\n\t\tangle: 0,\n\t});\n\n}\n\n// TODO: use fan-like triangulation\nfunction drawEllipse(opt: DrawEllipseOpt) {\n\n\tif (opt.radiusX === undefined || opt.radiusY === undefined) {\n\t\tthrow new Error(\"drawEllipse() requires properties \\\"radiusX\\\" and \\\"radiusY\\\".\");\n\t}\n\n\tif (opt.radiusX === 0 || opt.radiusY === 0) {\n\t\treturn;\n\t}\n\n\tdrawPolygon({\n\t\t...opt,\n\t\tpts: getArcPts(\n\t\t\tvec2(0),\n\t\t\topt.radiusX,\n\t\t\topt.radiusY,\n\t\t\topt.start ?? 0,\n\t\t\topt.end ?? 360,\n\t\t\topt.resolution\n\t\t),\n\t\tradius: 0,\n\t});\n\n}\n\nfunction drawPolygon(opt: DrawPolygonOpt) {\n\n\tif (!opt.pts) {\n\t\tthrow new Error(\"drawPolygon() requires property \\\"pts\\\".\");\n\t}\n\n\tconst npts = opt.pts.length;\n\n\tif (npts < 3) {\n\t\treturn;\n\t}\n\n\tpushTransform();\n\tpushTranslate(opt.pos);\n\tpushScale(opt.scale);\n\tpushRotateZ(opt.angle);\n\tpushTranslate(opt.offset);\n\n\tif (opt.fill !== false) {\n\n\t\tconst color = opt.color ?? Color.WHITE;\n\n\t\tconst verts = opt.pts.map((pt) => ({\n\t\t\tpos: vec3(pt.x, pt.y, 0),\n\t\t\tuv: vec2(0, 0),\n\t\t\tcolor: color,\n\t\t\topacity: opt.opacity ?? 1,\n\t\t}));\n\n\t\t// TODO: better triangulation\n\t\tconst indices = [...Array(npts - 2).keys()]\n\t\t\t.map((n) => [0, n + 1, n + 2])\n\t\t\t.flat();\n\n\t\tdrawRaw(verts, opt.indices ?? indices, opt.fixed, gfx.defTex, opt.shader, opt.uniform);\n\n\t}\n\n\tif (opt.outline) {\n\t\tdrawLines({\n\t\t\tpts: [ ...opt.pts, opt.pts[0] ],\n\t\t\tradius: opt.radius,\n\t\t\twidth: opt.outline.width,\n\t\t\tcolor: opt.outline.color,\n\t\t\tuniform: opt.uniform,\n\t\t\tfixed: opt.fixed,\n\t\t});\n\t}\n\n\tpopTransform();\n\n}\n\nfunction applyCharTransform(fchar: FormattedChar, tr: CharTransform) {\n\tif (tr.pos) fchar.pos = fchar.pos.add(tr.pos);\n\tif (tr.scale) fchar.scale = fchar.scale.scale(vec2(tr.scale));\n\tif (tr.angle) fchar.angle += tr.angle;\n\tif (tr.color) fchar.color = fchar.color.mult(tr.color);\n\tif (tr.opacity) fchar.opacity *= tr.opacity;\n}\n\n// TODO: escape\nconst TEXT_STYLE_RE = /\\[(?<text>[^\\]]*)\\]\\.(?<style>[\\w\\.]+)+/g;\n\nfunction compileStyledText(text: string): {\n\tcharStyleMap: Record<number, {\n\t\tlocalIdx: number,\n\t\tstyles: string[],\n\t}>,\n\ttext: string,\n} {\n\n\tconst charStyleMap = {};\n\t// get the text without the styling syntax\n\tconst renderText = text.replace(TEXT_STYLE_RE, \"$1\");\n\tlet idxOffset = 0;\n\n\t// put each styled char index into a map for easy access when iterating each char\n\tfor (const match of text.matchAll(TEXT_STYLE_RE)) {\n\t\tconst styles = match.groups.style.split(\".\");\n\t\tconst origIdx = match.index - idxOffset;\n\t\tfor (\n\t\t\tlet i = origIdx;\n\t\t\ti < match.index + match.groups.text.length;\n\t\t\ti++\n\t\t) {\n\t\t\tcharStyleMap[i] = {\n\t\t\t\tlocalIdx: i - origIdx,\n\t\t\t\tstyles: styles,\n\t\t\t};\n\t\t}\n\t\t// omit \"[\", \"]\", \".\" and the style text in the format string when calculating index\n\t\tidxOffset += 3 + match.groups.style.length;\n\t}\n\n\treturn {\n\t\tcharStyleMap: charStyleMap,\n\t\ttext: renderText,\n\t};\n\n}\n\nfunction findAsset<T>(src: string | T, lib: Record<string, T>, def?: string): T | undefined {\n\tif (src) {\n\t\treturn typeof src === \"string\" ? lib[src] : src;\n\t} else if (def) {\n\t\treturn lib[def];\n\t}\n}\n\n// format text and return a list of chars with their calculated position\nfunction formatText(opt: DrawTextOpt): FormattedText {\n\n\tif (opt.text === undefined) {\n\t\tthrow new Error(\"formatText() requires property \\\"text\\\".\");\n\t}\n\n\tconst font = findAsset(opt.font ?? gopt.font, assets.fonts, DEF_FONT);\n\n\tif (!font) {\n\t\tthrow new Error(`Font not found: ${opt.font}`);\n\t}\n\n\tconst { charStyleMap, text } = compileStyledText(opt.text + \"\");\n\tconst chars = text.split(\"\");\n\tconst gw = font.qw * font.tex.width;\n\tconst gh = font.qh * font.tex.height;\n\tconst size = opt.size || gh;\n\tconst scale = vec2(size / gh).scale(vec2(opt.scale || 1));\n\tconst cw = scale.x * gw + (opt.letterSpacing ?? 0);\n\tconst ch = scale.y * gh + (opt.lineSpacing ?? 0);\n\tlet curX = 0;\n\tlet th = ch;\n\tlet tw = 0;\n\tconst flines = [];\n\tlet curLine = [];\n\tlet lastSpace = null;\n\tlet cursor = 0;\n\n\twhile (cursor < chars.length) {\n\n\t\tlet char = chars[cursor];\n\n\t\t// check new line\n\t\tif (char === \"\\n\") {\n\t\t\t// always new line on '\\n'\n\t\t\tth += ch;\n\t\t\tcurX = 0;\n\t\t\tlastSpace = null;\n\t\t\tcurLine.push(char);\n\t\t\tflines.push(curLine);\n\t\t\tcurLine = [];\n\t\t} else if ((opt.width ? (curX + cw > opt.width) : false)) {\n\t\t\t// new line on last word if width exceeds\n\t\t\tth += ch;\n\t\t\tcurX = 0;\n\t\t\tif (lastSpace != null) {\n\t\t\t\tcursor -= curLine.length - lastSpace;\n\t\t\t\tchar = chars[cursor];\n\t\t\t\tcurLine = curLine.slice(0, lastSpace);\n\t\t\t}\n\t\t\tlastSpace = null;\n\t\t\tflines.push(curLine);\n\t\t\tcurLine = [];\n\t\t}\n\n\t\t// push char\n\t\tif (char !== \"\\n\") {\n\t\t\tcurLine.push(char);\n\t\t\tcurX += cw;\n\t\t\tif (char === \" \") {\n\t\t\t\tlastSpace = curLine.length;\n\t\t\t}\n\t\t}\n\n\t\ttw = Math.max(tw, curX);\n\t\tcursor++;\n\n\t}\n\n\tflines.push(curLine);\n\n\tif (opt.width) {\n\t\ttw = opt.width;\n\t}\n\n\t// whole text offset\n\tconst fchars = [];\n\tconst pos = vec2(opt.pos || 0);\n\tconst offset = originPt(opt.origin || DEF_ORIGIN).scale(0.5);\n\t// this math is complicated i forgot how it works instantly\n\tconst ox = -offset.x * cw - (offset.x + 0.5) * (tw - cw);\n\tconst oy = -offset.y * ch - (offset.y + 0.5) * (th - ch);\n\tlet idx = 0;\n\n\tflines.forEach((line, ln) => {\n\n\t\t// line offset\n\t\tconst oxl = (tw - line.length * cw) * (offset.x + 0.5);\n\n\t\tline.forEach((char, cn) => {\n\t\t\tconst qpos = font.map[char];\n\t\t\tconst x = cn * cw;\n\t\t\tconst y = ln * ch;\n\t\t\tif (qpos) {\n\t\t\t\tconst fchar: FormattedChar = {\n\t\t\t\t\ttex: font.tex,\n\t\t\t\t\tquad: new Quad(qpos.x, qpos.y, font.qw, font.qh),\n\t\t\t\t\tch: char,\n\t\t\t\t\tpos: vec2(pos.x + x + ox + oxl, pos.y + y + oy),\n\t\t\t\t\topacity: opt.opacity,\n\t\t\t\t\tcolor: opt.color ?? rgb(255, 255, 255),\n\t\t\t\t\tscale: scale,\n\t\t\t\t\tangle: 0,\n\t\t\t\t\tuniform: opt.uniform,\n\t\t\t\t\tfixed: opt.fixed,\n\t\t\t\t}\n\t\t\t\tif (opt.transform) {\n\t\t\t\t\tconst tr = typeof opt.transform === \"function\"\n\t\t\t\t\t\t? opt.transform(idx, char)\n\t\t\t\t\t\t: opt.transform;\n\t\t\t\t\tif (tr) {\n\t\t\t\t\t\tapplyCharTransform(fchar, tr);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (charStyleMap[idx]) {\n\t\t\t\t\tconst { styles, localIdx } = charStyleMap[idx];\n\t\t\t\t\tfor (const name of styles) {\n\t\t\t\t\t\tconst style = opt.styles[name];\n\t\t\t\t\t\tconst tr = typeof style === \"function\"\n\t\t\t\t\t\t\t? style(localIdx, char)\n\t\t\t\t\t\t\t: style;\n\t\t\t\t\t\tif (tr) {\n\t\t\t\t\t\t\tapplyCharTransform(fchar, tr);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tfchars.push(fchar);\n\t\t\t}\n\t\t\tidx += 1;\n\t\t});\n\t});\n\n\treturn {\n\t\twidth: tw,\n\t\theight: th,\n\t\tchars: fchars,\n\t};\n\n}\n\nfunction drawText(opt: DrawTextOpt) {\n\tdrawFormattedText(formatText(opt));\n}\n\n// TODO: rotation\nfunction drawFormattedText(ftext: FormattedText) {\n\tfor (const ch of ftext.chars) {\n\t\tdrawUVQuad({\n\t\t\ttex: ch.tex,\n\t\t\twidth: ch.tex.width * ch.quad.w,\n\t\t\theight: ch.tex.height * ch.quad.h,\n\t\t\tpos: ch.pos,\n\t\t\tscale: ch.scale,\n\t\t\tangle: ch.angle,\n\t\t\tcolor: ch.color,\n\t\t\topacity: ch.opacity,\n\t\t\tquad: ch.quad,\n\t\t\t// TODO: topleft\n\t\t\torigin: \"center\",\n\t\t\tuniform: ch.uniform,\n\t\t\tfixed: ch.fixed,\n\t\t});\n\t}\n}\n\n/**\n * Update viewport based on user setting and fullscreen state\n */\nfunction updateViewport() {\n\n\tconst gl = app.gl;\n\n\t// canvas size\n\tconst cw = gl.drawingBufferWidth;\n\tconst ch = gl.drawingBufferHeight;\n\n\t// game size\n\tconst gw = width();\n\tconst gh = height();\n\n\tif (isFullscreen()) {\n\t\t// TODO: doesn't work with letterbox\n\t\tconst ww = window.innerWidth;\n\t\tconst wh = window.innerHeight;\n\t\tconst rw = ww / wh;\n\t\tconst rc = cw / ch;\n\t\tif (rw > rc) {\n\t\t\tconst sw = window.innerHeight * rc;\n\t\t\tgfx.viewport = {\n\t\t\t\tx: (ww - sw) / 2,\n\t\t\t\ty: 0,\n\t\t\t\twidth: sw,\n\t\t\t\theight: wh,\n\t\t\t};\n\t\t} else {\n\t\t\tconst sh = window.innerWidth / rc;\n\t\t\tgfx.viewport = {\n\t\t\t\tx: 0,\n\t\t\t\ty: (wh - sh) / 2,\n\t\t\t\twidth: ww,\n\t\t\t\theight: sh,\n\t\t\t};\n\t\t}\n\t\treturn;\n\t}\n\n\tif (gopt.letterbox) {\n\n\t\tif (!gopt.width || !gopt.height) {\n\t\t\tthrow new Error(\"Letterboxing requires width and height defined.\");\n\t\t}\n\n\t\tconst rc = cw / ch;\n\t\tconst rg = gopt.width / gopt.height;\n\n\t\tif (rc > rg) {\n\t\t\tif (!gopt.stretch) {\n\t\t\t\tgfx.width = ch * rg;\n\t\t\t\tgfx.height = ch;\n\t\t\t}\n\t\t\tconst sw = ch * rg;\n\t\t\tconst sh = ch;\n\t\t\tconst x = (cw - sw) / 2;\n\t\t\tgl.scissor(x, 0, sw, sh);\n\t\t\tgl.viewport(x, 0, sw, ch);\n\t\t\tgfx.viewport = {\n\t\t\t\tx: x,\n\t\t\t\ty: 0,\n\t\t\t\twidth: sw,\n\t\t\t\theight: ch,\n\t\t\t};\n\t\t} else {\n\t\t\tif (!gopt.stretch) {\n\t\t\t\tgfx.width = cw;\n\t\t\t\tgfx.height = cw / rg;\n\t\t\t}\n\t\t\tconst sw = cw;\n\t\t\tconst sh = cw / rg;\n\t\t\tconst y = (ch - sh) / 2;\n\t\t\tgl.scissor(0, y, sw, sh);\n\t\t\tgl.viewport(0, y, cw, sh);\n\t\t\tgfx.viewport = {\n\t\t\t\tx: 0,\n\t\t\t\ty: y,\n\t\t\t\twidth: cw,\n\t\t\t\theight: sh,\n\t\t\t};\n\t\t}\n\n\t\treturn;\n\n\t}\n\n\tif (gopt.stretch) {\n\n\t\tif (!gopt.width || !gopt.height) {\n\t\t\tthrow new Error(\"Stretching requires width and height defined.\");\n\t\t}\n\n\t\tgl.viewport(0, 0, cw, ch);\n\n\t\tgfx.viewport = {\n\t\t\tx: 0,\n\t\t\ty: 0,\n\t\t\twidth: cw,\n\t\t\theight: ch,\n\t\t};\n\n\t\treturn;\n\t}\n\n\tgfx.width = cw / app.scale;\n\tgfx.height = ch / app.scale;\n\tgl.viewport(0, 0, cw, ch);\n\n\tgfx.viewport = {\n\t\tx: 0,\n\t\ty: 0,\n\t\twidth: cw,\n\t\theight: ch,\n\t};\n\n}\n\n// get game width\nfunction width(): number {\n\treturn gfx.width;\n}\n\n// get game height\nfunction height(): number {\n\treturn gfx.height;\n}\n\n// TODO: support remove events\napp.canvas.addEventListener(\"mousemove\", (e) => {\n\tapp.mousePos = vec2(\n\t\t(e.offsetX - gfx.viewport.x) * width() / gfx.viewport.width,\n\t\t(e.offsetY - gfx.viewport.y) * height() / gfx.viewport.height,\n\t);\n\tapp.mouseDeltaPos = vec2(e.movementX, e.movementY).scale(1 / app.scale);\n\tapp.isMouseMoved = true;\n});\n\napp.canvas.addEventListener(\"mousedown\", (e) => {\n\tconst m = MOUSE_BUTTONS[e.button];\n\tif (m) {\n\t\tapp.mouseStates[m] = \"pressed\";\n\t}\n});\n\napp.canvas.addEventListener(\"mouseup\", (e) => {\n\tconst m = MOUSE_BUTTONS[e.button];\n\tif (m) {\n\t\tapp.mouseStates[m] = \"released\";\n\t}\n});\n\napp.canvas.addEventListener(\"keydown\", (e) => {\n\n\tconst k = KEY_ALIAS[e.key] || e.key.toLowerCase();\n\n\tif (PREVENT_DEFAULT_KEYS.includes(k)) {\n\t\te.preventDefault();\n\t}\n\n\tif (k.length === 1) {\n\t\tapp.charInputted.push(e.key);\n\t}\n\n\tif (k === \"space\") {\n\t\tapp.charInputted.push(\" \");\n\t}\n\n\tif (e.repeat) {\n\t\tapp.isKeyPressedRepeat = true;\n\t\tapp.keyStates[k] = \"rpressed\";\n\t} else {\n\t\tapp.isKeyPressed = true;\n\t\tapp.keyStates[k] = \"pressed\";\n\t}\n\n});\n\napp.canvas.addEventListener(\"keyup\", (e: KeyboardEvent) => {\n\tconst k = KEY_ALIAS[e.key] || e.key.toLowerCase();\n\tapp.keyStates[k] = \"released\";\n\tapp.isKeyReleased = true;\n});\n\napp.canvas.addEventListener(\"touchstart\", (e) => {\n\tif (!gopt.touchToMouse) return;\n\t// disable long tap context menu\n\te.preventDefault();\n\tconst t = e.touches[0];\n\tapp.mousePos = vec2(t.clientX, t.clientY).scale(1 / app.scale);\n\tapp.mouseStates[\"left\"] = \"pressed\";\n});\n\napp.canvas.addEventListener(\"touchmove\", (e) => {\n\tif (!gopt.touchToMouse) return;\n\t// disable scrolling\n\te.preventDefault();\n\tconst t = e.touches[0];\n\tapp.mousePos = vec2(t.clientX, t.clientY).scale(1 / app.scale);\n\tapp.isMouseMoved = true;\n});\n\napp.canvas.addEventListener(\"touchend\", (e) => {\n\tif (!gopt.touchToMouse) return;\n\tapp.mouseStates[\"left\"] = \"released\";\n});\n\napp.canvas.addEventListener(\"touchcancel\", (e) => {\n\tif (!gopt.touchToMouse) return;\n\tapp.mouseStates[\"left\"] = \"released\";\n});\n\napp.canvas.addEventListener(\"touchstart\", (e) => {\n\t[...e.changedTouches].forEach((t) => {\n\t\tgame.trigger(\"onTouchStart\", t.identifier, vec2(t.clientX, t.clientY).scale(1 / app.scale));\n\t});\n});\n\napp.canvas.addEventListener(\"touchmove\", (e) => {\n\t[...e.changedTouches].forEach((t) => {\n\t\tgame.trigger(\"onTouchMove\", t.identifier, vec2(t.clientX, t.clientY).scale(1 / app.scale));\n\t});\n});\n\napp.canvas.addEventListener(\"touchend\", (e) => {\n\t[...e.changedTouches].forEach((t) => {\n\t\tgame.trigger(\"onTouchEnd\", t.identifier, vec2(t.clientX, t.clientY).scale(1 / app.scale));\n\t});\n});\n\napp.canvas.addEventListener(\"contextmenu\", function (e) {\n\te.preventDefault();\n});\n\ndocument.addEventListener(\"visibilitychange\", () => {\n\tswitch (document.visibilityState) {\n\t\tcase \"visible\":\n\t\t\t// prevent a surge of dt() when switch back after the tab being hidden for a while\n\t\t\tapp.skipTime = true;\n\t\t\t// TODO: don't resume if debug.paused\n\t\t\taudio.ctx.resume();\n\t\t\tbreak;\n\t\tcase \"hidden\":\n\t\t\taudio.ctx.suspend();\n\t\t\tbreak;\n\t}\n});\n\n// TODO: not quite working\n// window.addEventListener(\"resize\", () => {\n// \tif (!(gopt.width && gopt.height && !gopt.stretch)) {\n// \t\tapp.canvas.width = app.canvas.parentElement.offsetWidth;\n// \t\tapp.canvas.height = app.canvas.parentElement.offsetHeight;\n// \t}\n// });\n\nfunction mousePos(): Vec2 {\n\treturn app.mousePos.clone();\n}\n\nfunction mouseDeltaPos(): Vec2 {\n\treturn app.mouseDeltaPos.clone();\n}\n\nfunction isMousePressed(m = \"left\"): boolean {\n\treturn app.mouseStates[m] === \"pressed\";\n}\n\nfunction isMouseDown(m = \"left\"): boolean {\n\treturn app.mouseStates[m] === \"pressed\" || app.mouseStates[m] === \"down\";\n}\n\nfunction isMouseReleased(m = \"left\"): boolean {\n\treturn app.mouseStates[m] === \"released\";\n}\n\nfunction isMouseMoved(): boolean {\n\treturn app.isMouseMoved;\n}\n\nfunction isKeyPressed(k?: string): boolean {\n\tif (k === undefined) {\n\t\treturn app.isKeyPressed;\n\t} else {\n\t\treturn app.keyStates[k] === \"pressed\";\n\t}\n}\n\nfunction isKeyPressedRepeat(k: string): boolean {\n\tif (k === undefined) {\n\t\treturn app.isKeyPressedRepeat;\n\t} else {\n\t\treturn app.keyStates[k] === \"pressed\" || app.keyStates[k] === \"rpressed\";\n\t}\n}\n\nfunction isKeyDown(k: string): boolean {\n\treturn app.keyStates[k] === \"pressed\"\n\t\t|| app.keyStates[k] === \"rpressed\"\n\t\t|| app.keyStates[k] === \"down\";\n}\n\nfunction isKeyReleased(k?: string): boolean {\n\tif (k === undefined) {\n\t\treturn app.isKeyReleased;\n\t} else {\n\t\treturn app.keyStates[k] === \"released\";\n\t}\n}\n\nfunction charInputted(): string[] {\n\treturn [...app.charInputted];\n}\n\nfunction time(): number {\n\treturn app.time;\n}\n\n// get a base64 png image of canvas\nfunction screenshot(): string {\n\treturn app.canvas.toDataURL();\n}\n\n// TODO: custom cursor\nfunction cursor(c?: Cursor): Cursor {\n\tif (c) {\n\t\tapp.canvas.style.cursor = c;\n\t}\n\treturn app.canvas.style.cursor;\n}\n\nfunction fullscreen(f: boolean = true) {\n\tif (f) {\n\t\tenterFullscreen(app.canvas);\n\t} else {\n\t\texitFullscreen();\n\t}\n}\n\nfunction isFullscreen(): boolean {\n\treturn Boolean(getFullscreenElement());\n}\n\nfunction quit() {\n\tcancelAnimationFrame(app.loopID);\n\tapp.stopped = true;\n}\n\nconst debug: Debug = {\n\tinspect: false,\n\ttimeScale: 1,\n\tshowLog: true,\n\tfps: () => app.fpsCounter.fps,\n\tobjCount(): number {\n\t\t// TODO: recursive count\n\t\treturn game.root.children.length;\n\t},\n\tstepFrame: updateFrame,\n\tdrawCalls: () => gfx.drawCalls,\n\tclearLog: () => game.logs = [],\n\tlog: (msg) => game.logs.unshift(`[${time().toFixed(2)}].time [${msg}].info`),\n\terror: (msg) => game.logs.unshift(`[${time().toFixed(2)}].time [${msg}].error`),\n\tcurRecording: null,\n\tget paused() {\n\t\treturn app.paused;\n\t},\n\tset paused(v) {\n\t\tapp.paused = v;\n\t\tif (v) {\n\t\t\taudio.ctx.suspend();\n\t\t} else {\n\t\t\taudio.ctx.resume();\n\t\t}\n\t}\n};\n\nfunction dt() {\n\treturn app.dt * debug.timeScale;\n}\n\nfunction mouseWorldPos(): Vec2 {\n\tdeprecateMsg(\"mouseWorldPos()\", \"toWorld(mousePos())\");\n\treturn toWorld(mousePos());\n}\n\ntype Camera = {\n\tpos: Vec2,\n\tscale: Vec2,\n\tangle: number,\n\tshake: number,\n};\n\ntype Layer = {\n\torder: number,\n}\n\ntype TaggedEvent = {\n\ttag: string,\n\tcb: (...args) => void,\n};\n\ntype KeyEvent = {\n\tkey: string,\n\tcb(),\n};\n\ntype MouseInputEvent = {\n\tcb(),\n};\n\ntype LoadEvent = () => void;\ntype NextFrameEvent = () => void;\ntype MouseEvent = () => void;\ntype CharEvent = (ch: string) => void;\n\nfunction layers(list: string[], def?: string) {\n\n\tlist.forEach((name, idx) => {\n\t\tgame.layers[name] = idx + 1;\n\t});\n\n\tif (def) {\n\t\tgame.defLayer = def;\n\t}\n\n}\n\nfunction camPos(...pos): Vec2 {\n\tif (pos.length > 0) {\n\t\tgame.cam.pos = vec2(...pos);\n\t}\n\treturn game.cam.pos.clone();\n}\n\nfunction camScale(...scale): Vec2 {\n\tif (scale.length > 0) {\n\t\tgame.cam.scale = vec2(...scale);\n\t}\n\treturn game.cam.scale.clone();\n}\n\nfunction camRot(angle: number): number {\n\tif (angle !== undefined) {\n\t\tgame.cam.angle = angle;\n\t}\n\treturn game.cam.angle;\n}\n\nfunction shake(intensity: number = 12) {\n\tgame.cam.shake = intensity;\n}\n\nfunction toScreen(p: Vec2): Vec2 {\n\treturn game.cam.transform.multVec2(p);\n}\n\nfunction toWorld(p: Vec2): Vec2 {\n\treturn game.cam.transform.invert().multVec2(p);\n}\n\nfunction make<T>(comps: CompList<T>): GameObj<T> {\n\n\tconst compStates = new Map();\n\tconst customState = {};\n\tlet events = {};\n\n\tconst obj = {\n\n\t\t_id: uid(),\n\t\thidden: false,\n\t\tpaused: false,\n\t\tchildren: [],\n\t\tparent: null,\n\n\t\t// TODO: accept gameobj\n\t\tadd<T2>(comps: CompList<T2>): GameObj<T2> {\n\t\t\tif (this !== game.root) {\n\t\t\t\tthrow new Error(\"Children game object not supported yet\");\n\t\t\t}\n\t\t\tconst obj = make(comps);\n\t\t\tobj.parent = this;\n\t\t\tobj.trigger(\"add\");\n\t\t\tonLoad(() => obj.trigger(\"load\"));\n\t\t\tthis.children.push(obj);\n\t\t\treturn obj;\n\t\t},\n\n\t\t// TODO: use add()\n\t\treadd(obj: GameObj): GameObj {\n\t\t\tthis.remove(obj);\n\t\t\tthis.children.push(obj);\n\t\t\treturn obj;\n\t\t},\n\n\t\tremove(obj: GameObj): void {\n\t\t\tconst idx = this.children.indexOf(obj);\n\t\t\tif (idx !== -1) {\n\t\t\t\tobj.parent = null;\n\t\t\t\tobj.trigger(\"destroy\");\n\t\t\t\tthis.children.splice(idx, 1);\n\t\t\t}\n\t\t},\n\n\t\tremoveAll(tag: Tag) {\n\t\t\tthis.every(tag, (obj) => this.remove(obj));\n\t\t},\n\n\t\tupdate() {\n\t\t\tif (this.paused) return;\n\t\t\tthis.revery((child) => child.update());\n\t\t\tthis.trigger(\"update\");\n\t\t},\n\n\t\tdraw() {\n\t\t\tif (this.hidden) return;\n\t\t\tpushTransform();\n\t\t\tpushTranslate(this.pos);\n\t\t\tpushScale(this.scale);\n\t\t\tpushRotateZ(this.angle);\n\t\t\tthis.every((child) => child.draw());\n\t\t\tthis.trigger(\"draw\");\n\t\t\tpopTransform();\n\t\t},\n\n\t\t// use a comp, or tag\n\t\tuse(comp: Comp | Tag) {\n\n\t\t\tif (!comp) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// tag\n\t\t\tif (typeof comp === \"string\") {\n\t\t\t\treturn this.use({\n\t\t\t\t\tid: comp\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// clear if overwrite\n\t\t\tif (comp.id) {\n\t\t\t\tthis.unuse(comp.id);\n\t\t\t\tcompStates.set(comp.id, {});\n\t\t\t}\n\n\t\t\t// state source location\n\t\t\tconst state = comp.id ? compStates.get(comp.id) : customState;\n\n\t\t\tstate.cleanups = [];\n\n\t\t\tfor (const k in comp) {\n\n\t\t\t\tif (COMP_DESC.has(k)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// event / custom method\n\t\t\t\tif (typeof comp[k] === \"function\") {\n\t\t\t\t\tconst func = comp[k].bind(this);\n\t\t\t\t\tif (COMP_EVENTS.has(k)) {\n\t\t\t\t\t\tstate.cleanups.push(this.on(k, func));\n\t\t\t\t\t\tstate[k] = func;\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tstate[k] = func;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tstate[k] = comp[k];\n\t\t\t\t}\n\n\t\t\t\tif (this[k] === undefined) {\n\t\t\t\t\t// assign comp fields to game obj\n\t\t\t\t\tObject.defineProperty(this, k, {\n\t\t\t\t\t\tget: () => state[k],\n\t\t\t\t\t\tset: (val) => state[k] = val,\n\t\t\t\t\t\tconfigurable: true,\n\t\t\t\t\t\tenumerable: true,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tconst checkDeps = () => {\n\t\t\t\tif (!comp.require) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tfor (const dep of comp.require) {\n\t\t\t\t\tif (!this.c(dep)) {\n\t\t\t\t\t\tthrow new Error(`comp '${comp.id}' requires comp '${dep}'`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\n\t\t\t// check deps or run add event\n\t\t\tif (this.exists()) {\n\t\t\t\tif (comp.add) {\n\t\t\t\t\tcomp.add.call(this);\n\t\t\t\t}\n\t\t\t\tif (comp.load) {\n\t\t\t\t\tonLoad(() => comp.load.call(this));\n\t\t\t\t}\n\t\t\t\tcheckDeps();\n\t\t\t} else {\n\t\t\t\tif (comp.require) {\n\t\t\t\t\tstate.cleanups.push(this.on(\"add\", checkDeps));\n\t\t\t\t}\n\t\t\t}\n\n\t\t},\n\n\t\tunuse(id: Tag) {\n\t\t\tif (compStates.has(id)) {\n\t\t\t\tconst comp = compStates.get(id);\n\t\t\t\tcomp.cleanups.forEach((f) => f());\n\t\t\t\tfor (const k in comp) {\n\t\t\t\t\tdelete comp[k];\n\t\t\t\t}\n\t\t\t}\n\t\t\tcompStates.delete(id);\n\t\t},\n\n\t\tc(id: Tag): Comp {\n\t\t\treturn compStates.get(id);\n\t\t},\n\n\t\t// TODO: a recursive variant\n\t\tget(t?: Tag | Tag[]): GameObj[] {\n\t\t\treturn this.children\n\t\t\t\t.filter((child) => t ? child.is(t) : true)\n\t\t\t\t.sort((o1, o2) => {\n\t\t\t\t\t// TODO: layers are deprecated\n\t\t\t\t\tconst l1 = game.layers[o1.layer ?? game.defLayer] ?? 0;\n\t\t\t\t\tconst l2 = game.layers[o2.layer ?? game.defLayer] ?? 0;\n\t\t\t\t\t// if on same layer, use \"z\" comp to decide which is on top, if given\n\t\t\t\t\tif (l1 == l2) {\n\t\t\t\t\t\treturn (o1.z ?? 0) - (o2.z ?? 0);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn l1 - l2;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t},\n\n\t\tevery<T>(t: Tag | Tag[] | ((obj: GameObj) => T), f?: (obj: GameObj) => T) {\n\t\t\tif (typeof t === \"function\" && f === undefined) {\n\t\t\t\treturn this.get().forEach((obj) => t(obj));\n\t\t\t} else if (typeof t === \"string\" || Array.isArray(t)) {\n\t\t\t\treturn this.get(t).forEach((obj) => f(obj));\n\t\t\t}\n\t\t},\n\n\t\trevery<T>(t: Tag | Tag[] | ((obj: GameObj) => T), f?: (obj: GameObj) => T) {\n\t\t\tif (typeof t === \"function\" && f === undefined) {\n\t\t\t\treturn this.get().reverse().forEach((obj) => t(obj));\n\t\t\t} else if (typeof t === \"string\" || Array.isArray(t)) {\n\t\t\t\treturn this.get(t).reverse().forEach((obj) => f(obj));\n\t\t\t}\n\t\t},\n\n\t\texists(): boolean {\n\t\t\tif (this.parent === game.root) {\n\t\t\t\treturn true;\n\t\t\t} else {\n\t\t\t\treturn this.parent?.exists();\n\t\t\t}\n\t\t},\n\n\t\tis(tag: Tag | Tag[]): boolean {\n\t\t\tif (tag === \"*\") {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tif (Array.isArray(tag)) {\n\t\t\t\tfor (const t of tag) {\n\t\t\t\t\tif (!this.c(t)) {\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t} else {\n\t\t\t\treturn this.c(tag) != null;\n\t\t\t}\n\t\t},\n\n\t\ton(ev: string, cb): EventCanceller {\n\t\t\tif (!events[ev]) {\n\t\t\t\tevents[ev] = new IDList();\n\t\t\t}\n\t\t\treturn events[ev].pushd(cb);\n\t\t},\n\n\t\taction(...args): EventCanceller {\n\t\t\tconsole.warn(\"action() is deprecated. Use onUpdate() instead\")\n\t\t\treturn this.onUpdate(...args);\n\t\t},\n\n\t\ttrigger(ev: string, ...args): void {\n\n\t\t\tif (events[ev]) {\n\t\t\t\tevents[ev].forEach((cb) => cb.call(this, ...args));\n\t\t\t}\n\n\t\t\tconst gEvents = game.objEvents[ev];\n\n\t\t\tif (gEvents) {\n\t\t\t\tgEvents.forEach((e) => {\n\t\t\t\t\tif (this.is(e.tag)) {\n\t\t\t\t\t\te.cb(this, ...args);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t},\n\n\t\tdestroy() {\n\t\t\tthis.parent?.remove(this);\n\t\t},\n\n\t\tinspect() {\n\t\t\tconst info = {};\n\t\t\tfor (const [tag, comp] of compStates) {\n\t\t\t\tinfo[tag] = comp.inspect ? comp.inspect() : null;\n\t\t\t}\n\t\t\treturn info;\n\t\t},\n\n\t\tonUpdate(cb: () => void): EventCanceller {\n\t\t\treturn this.on(\"update\", cb);\n\t\t},\n\n\t\tonDraw(cb: () => void): EventCanceller {\n\t\t\treturn this.on(\"draw\", cb);\n\t\t},\n\n\t\tonDestroy(action: () => void): EventCanceller {\n\t\t\treturn this.on(\"destroy\", action);\n\t\t},\n\n\t\tclearEvents() {\n\t\t\tevents = {}\n\t\t},\n\n\t};\n\n\tfor (const comp of comps) {\n\t\tobj.use(comp);\n\t}\n\n\treturn obj as unknown as GameObj<T>;\n\n}\n\n// add an event to a tag\nfunction on(event: string, tag: Tag, cb: (obj: GameObj, ...args) => void): EventCanceller {\n\tif (!game.objEvents[event]) {\n\t\tgame.objEvents[event] = new IDList();\n\t}\n\treturn game.objEvents[event].pushd({\n\t\ttag: tag,\n\t\tcb: cb,\n\t});\n}\n\n// add update event to a tag or global update\nfunction onUpdate(tag: Tag | (() => void), cb?: (obj: GameObj) => void): EventCanceller {\n\tif (typeof tag === \"function\" && cb === undefined) {\n\t\treturn game.root.onUpdate(tag);\n\t} else if (typeof tag === \"string\") {\n\t\treturn on(\"update\", tag, cb);\n\t}\n}\n\n// add draw event to a tag or global draw\nfunction onDraw(tag: Tag | (() => void), cb?: (obj: GameObj) => void) {\n\tif (typeof tag === \"function\" && cb === undefined) {\n\t\treturn game.root.onDraw(tag);\n\t} else if (typeof tag === \"string\") {\n\t\treturn on(\"draw\", tag, cb);\n\t}\n}\n\n// add an event that runs with objs with t1 collides with objs with t2\nfunction onCollide(\n\tt1: Tag,\n\tt2: Tag,\n\tf: (a: GameObj, b: GameObj, col?: Collision) => void,\n): EventCanceller {\n\tconst e1 = on(\"collide\", t1, (a, b, col) => b.is(t2) && f(a, b, col));\n\tconst e2 = on(\"collide\", t2, (a, b, col) => b.is(t1) && f(b, a, col));\n\tconst e3 = onUpdate(t1, (o1: GameObj) => {\n\t\tif (!o1.area) {\n\t\t\tthrow new Error(\"onCollide() requires the object to have area() component\");\n\t\t}\n\t\to1._checkCollisions(t2, (o2) => {\n\t\t\tf(o1, o2);\n\t\t});\n\t});\n\treturn () => [e1, e2, e3].forEach((f) => f());\n}\n\n// add an event that runs when objs with tag t is clicked\nfunction onClick(tag: Tag | (() => void), cb?: (obj: GameObj) => void): EventCanceller {\n\tif (typeof tag === \"function\") {\n\t\treturn onMousePress(tag);\n\t} else {\n\t\treturn onUpdate(tag, (o: GameObj) => {\n\t\t\tif (!o.area) throw new Error(\"onClick() requires the object to have area() component\");\n\t\t\tif (o.isClicked()) {\n\t\t\t\tcb(o);\n\t\t\t}\n\t\t});\n\t}\n}\n\n// add an event that runs when objs with tag t is hovered\nfunction onHover(t: string, onHover: (obj: GameObj) => void, onNotHover?: (obj: GameObj) => void): EventCanceller {\n\treturn onUpdate(t, (o: GameObj) => {\n\t\tif (!o.area) throw new Error(\"onHover() requires the object to have area() component\");\n\t\tif (o.isHovering()) {\n\t\t\tonHover(o);\n\t\t} else {\n\t\t\tif (onNotHover) {\n\t\t\t\tonNotHover(o);\n\t\t\t}\n\t\t}\n\t});\n}\n\n// add an event that'd be run after t\nfunction wait(t: number, f?: () => void): Promise<void> {\n\treturn new Promise((resolve) => {\n\t\tgame.timers.push(new Timer(t, () => {\n\t\t\tif (f) f();\n\t\t\tresolve();\n\t\t}))\n\t});\n}\n\n// add an event that's run every t seconds\nfunction loop(t: number, f: () => void): EventCanceller {\n\n\tlet stopped = false;\n\n\tconst newF = () => {\n\t\tif (stopped) {\n\t\t\treturn;\n\t\t}\n\t\tf();\n\t\twait(t, newF);\n\t};\n\n\tnewF();\n\n\treturn () => stopped = true;\n\n}\n\n// input callbacks\nfunction onKeyDown(k: Key | Key[], f: () => void): EventCanceller {\n\tif (Array.isArray(k)) {\n\t\tconst cancellers = k.map((key) => onKeyDown(key, f));\n\t\treturn () => cancellers.forEach((cb) => cb());\n\t} {\n\t\treturn game.on(\"input\", () => isKeyDown(k) && f());\n\t}\n}\n\nfunction onKeyPress(k: Key | Key[] | (() => void), f?: () => void): EventCanceller {\n\tif (Array.isArray(k)) {\n\t\tconst cancellers = k.map((key) => onKeyPress(key, f));\n\t\treturn () => cancellers.forEach((cb) => cb());\n\t} else if (typeof k === \"function\") {\n\t\treturn game.on(\"input\", () => isKeyPressed() && k());\n\t} else {\n\t\treturn game.on(\"input\", () => isKeyPressed(k) && f());\n\t}\n}\n\nfunction onKeyPressRepeat(k: Key | Key[] | (() => void), f?: () => void): EventCanceller {\n\tif (Array.isArray(k)) {\n\t\tconst cancellers = k.map((key) => onKeyPressRepeat(key, f));\n\t\treturn () => cancellers.forEach((cb) => cb());\n\t} else if (typeof k === \"function\") {\n\t\treturn game.on(\"input\", () => isKeyPressed() && k());\n\t} else {\n\t\treturn game.on(\"input\", () => isKeyPressedRepeat(k) && f());\n\t}\n}\n\nfunction onKeyRelease(k: Key | Key[] | (() => void), f?: () => void): EventCanceller {\n\tif (Array.isArray(k)) {\n\t\tconst cancellers = k.map((key) => onKeyRelease(key, f));\n\t\treturn () => cancellers.forEach((cb) => cb());\n\t} else if (typeof k === \"function\") {\n\t\treturn game.on(\"input\", () => isKeyReleased() && k());\n\t} else {\n\t\treturn game.on(\"input\", () => isKeyReleased(k) && f());\n\t}\n}\n\nfunction onMouseDown(\n\tm: MouseButton | ((pos?: Vec2) => void),\n\taction?: (pos?: Vec2) => void\n): EventCanceller {\n\tif (typeof m === \"function\") {\n\t\treturn game.on(\"input\", () => isMouseDown() && m(mousePos()));\n\t} else {\n\t\treturn game.on(\"input\", () => isMouseDown(m) && action(mousePos()));\n\t}\n}\n\nfunction onMousePress(\n\tm: MouseButton | ((pos?: Vec2) => void),\n\taction?: (pos?: Vec2) => void\n): EventCanceller {\n\tif (typeof m === \"function\") {\n\t\treturn game.on(\"input\", () => isMousePressed() && m(mousePos()));\n\t} else {\n\t\treturn game.on(\"input\", () => isMousePressed(m) && action(mousePos()));\n\t}\n}\n\nfunction onMouseRelease(\n\tm: MouseButton | ((pos?: Vec2) => void),\n\taction?: (pos?: Vec2) => void\n): EventCanceller {\n\tif (typeof m === \"function\") {\n\t\treturn game.on(\"input\", () => isMouseReleased() && m(mousePos()));\n\t} else {\n\t\treturn game.on(\"input\", () => isMouseReleased(m) && action(mousePos()));\n\t}\n}\n\nfunction onMouseMove(f: (pos: Vec2, dpos: Vec2) => void): EventCanceller {\n\treturn game.on(\"input\", () => isMouseMoved() && f(mousePos(), mouseDeltaPos()));\n}\n\nfunction onCharInput(f: (ch: string) => void): EventCanceller {\n\treturn game.on(\"input\", () => charInputted().forEach((ch) => f(ch)));\n}\n\nfunction onTouchStart(f: (id: TouchID, pos: Vec2) => void): EventCanceller {\n\treturn game.on(\"onTouchStart\", f);\n}\n\nfunction onTouchMove(f: (id: TouchID, pos: Vec2) => void): EventCanceller {\n\treturn game.on(\"onTouchMove\", f);\n}\n\nfunction onTouchEnd(f: (id: TouchID, pos: Vec2) => void): EventCanceller {\n\treturn game.on(\"onTouchEnd\", f);\n}\n\nfunction enterDebugMode() {\n\n\tonKeyPress(\"f1\", () => {\n\t\tdebug.inspect = !debug.inspect;\n\t});\n\n\tonKeyPress(\"f2\", () => {\n\t\tdebug.clearLog();\n\t});\n\n\tonKeyPress(\"f8\", () => {\n\t\tdebug.paused = !debug.paused;\n\t});\n\n\tonKeyPress(\"f7\", () => {\n\t\tdebug.timeScale = toFixed(clamp(debug.timeScale - 0.2, 0, 2), 1);\n\t});\n\n\tonKeyPress(\"f9\", () => {\n\t\tdebug.timeScale = toFixed(clamp(debug.timeScale + 0.2, 0, 2), 1);\n\t});\n\n\tonKeyPress(\"f10\", () => {\n\t\tdebug.stepFrame();\n\t});\n\n\tonKeyPress(\"f5\", () => {\n\t\tdownloadURL(screenshot(), \"kaboom.png\");\n\t});\n\n\tonKeyPress(\"f6\", () => {\n\t\tif (debug.curRecording) {\n\t\t\tdebug.curRecording.download();\n\t\t\tdebug.curRecording = null;\n\t\t} else {\n\t\t\tdebug.curRecording = record();\n\t\t}\n\t});\n\n}\n\nfunction enterBurpMode() {\n\tonKeyPress(\"b\", burp);\n}\n\n// get / set gravity\nfunction gravity(g?: number): number {\n\tif (g !== undefined) {\n\t\tgame.gravity = g;\n\t}\n\treturn game.gravity;\n}\n\nfunction regCursor(c: Cursor, draw: string | ((mpos: Vec2) => void)) {\n\t// TODO\n}\n\nfunction makeCollision(target: GameObj<any>, dis: Vec2): Collision {\n\treturn {\n\t\ttarget: target,\n\t\tdisplacement: dis,\n\t\tisTop: () => dis.y > 0,\n\t\tisBottom: () => dis.y < 0,\n\t\tisLeft: () => dis.x > 0,\n\t\tisRight: () => dis.x < 0,\n\t};\n}\n\n// TODO: manage global velocity here?\nfunction pos(...args): PosComp {\n\n\treturn {\n\n\t\tid: \"pos\",\n\t\tpos: vec2(...args),\n\n\t\t// TODO: clean\n\t\tmoveBy(...args): Collision | null {\n\n\t\t\tconst p = vec2(...args);\n\t\t\tlet dx = p.x;\n\t\t\tlet dy = p.y;\n\t\t\tlet col = null;\n\n\t\t\tif (this.solid && this.area?.shape === \"rect\") {\n\n\t\t\t\tlet a1 = this.worldArea();\n\n\t\t\t\t// TODO: definitely shouln't iterate through all solid objs\n\t\t\t\tgame.root.every((other) => {\n\n\t\t\t\t\t// make sure we still exist, don't check with self, and only\n\t\t\t\t\t// check with other solid objects\n\t\t\t\t\tif (\n\t\t\t\t\t\t!this.exists()\n\t\t\t\t\t\t|| other === this\n\t\t\t\t\t\t|| !other.solid\n\t\t\t\t\t\t|| other.area?.shape !== \"rect\"\n\t\t\t\t\t) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst a2 = other.worldArea();\n\t\t\t\t\tlet md = minkDiff(a2, a1);\n\n\t\t\t\t\t// if they're already overlapping, push them away first\n\t\t\t\t\tif (testRectPoint(md, vec2(0))) {\n\n\t\t\t\t\t\tlet dist = Math.min(\n\t\t\t\t\t\t\tMath.abs(md.p1.x),\n\t\t\t\t\t\t\tMath.abs(md.p2.x),\n\t\t\t\t\t\t\tMath.abs(md.p1.y),\n\t\t\t\t\t\t\tMath.abs(md.p2.y),\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tconst res = (() => {\n\t\t\t\t\t\t\tswitch (dist) {\n\t\t\t\t\t\t\t\tcase Math.abs(md.p1.x): return vec2(dist, 0);\n\t\t\t\t\t\t\t\tcase Math.abs(md.p2.x): return vec2(-dist, 0);\n\t\t\t\t\t\t\t\tcase Math.abs(md.p1.y): return vec2(0, dist);\n\t\t\t\t\t\t\t\tcase Math.abs(md.p2.y): return vec2(0, -dist);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})();\n\n\t\t\t\t\t\tthis.pos = this.pos.sub(res);\n\n\t\t\t\t\t\t// calculate new mink diff\n\t\t\t\t\t\ta1 = this.worldArea();\n\t\t\t\t\t\tmd = minkDiff(a2, a1);\n\n\t\t\t\t\t}\n\n\t\t\t\t\tconst ray = { p1: vec2(0), p2: vec2(dx, dy) };\n\t\t\t\t\tlet minT = 1;\n\t\t\t\t\tconst p1 = md.p1;\n\t\t\t\t\tconst p2 = vec2(md.p1.x, md.p2.y);\n\t\t\t\t\tconst p3 = md.p2;\n\t\t\t\t\tconst p4 = vec2(md.p2.x, md.p1.y);\n\t\t\t\t\tlet numCols = 0;\n\t\t\t\t\tconst lines = {\n\t\t\t\t\t\t\"right\": { p1: p1, p2: p2, },\n\t\t\t\t\t\t\"top\": { p1: p2, p2: p3, },\n\t\t\t\t\t\t\"left\": { p1: p3, p2: p4, },\n\t\t\t\t\t\t\"bottom\": { p1: p4, p2: p1, },\n\t\t\t\t\t};\n\n\t\t\t\t\tfor (const s in lines) {\n\t\t\t\t\t\tconst line = lines[s];\n\t\t\t\t\t\t// if moving along a side, we forgive\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t(dx === 0 && line.p1.x === 0 && line.p2.x === 0)\n\t\t\t\t\t\t\t||\n\t\t\t\t\t\t\t(dy === 0 && line.p1.y === 0 && line.p2.y === 0)\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tminT = 1;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst t = testLineLineT(ray, line);\n\t\t\t\t\t\tif (t != null) {\n\t\t\t\t\t\t\tnumCols++;\n\t\t\t\t\t\t\tif (t < minT) {\n\t\t\t\t\t\t\t\tminT = t;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// if moving away, we forgive\n\t\t\t\t\tif (\n\t\t\t\t\t\tminT < 1\n\t\t\t\t\t\t&& !(minT === 0 && numCols == 1 && !testRectPoint(md, vec2(dx, dy)))\n\t\t\t\t\t) {\n\t\t\t\t\t\tconst dis = vec2(-dx * (1 - minT), -dy * (1 - minT));\n\t\t\t\t\t\tdx *= minT;\n\t\t\t\t\t\tdy *= minT;\n\t\t\t\t\t\tcol = makeCollision(other, dis);\n\t\t\t\t\t}\n\n\t\t\t\t});\n\n\t\t\t}\n\n\t\t\tthis.pos.x += dx;\n\t\t\tthis.pos.y += dy;\n\n\t\t\tif (col) {\n\t\t\t\tthis.trigger(\"collide\", col.target, col);\n\t\t\t\tcol.target.trigger(\"collide\", this, makeCollision(this, col.displacement.scale(-1)));\n\t\t\t}\n\n\t\t\treturn col;\n\n\t\t},\n\n\t\t// move with velocity (pixels per second)\n\t\tmove(...args): Collision | null {\n\t\t\treturn this.moveBy(vec2(...args).scale(dt()));\n\t\t},\n\n\t\t// move to a destination, with optional speed\n\t\tmoveTo(...args) {\n\t\t\tif (typeof args[0] === \"number\" && typeof args[1] === \"number\") {\n\t\t\t\treturn this.moveTo(vec2(args[0], args[1]), args[2]);\n\t\t\t}\n\t\t\tconst dest = args[0];\n\t\t\tconst speed = args[1];\n\t\t\tif (speed === undefined) {\n\t\t\t\tthis.pos = vec2(dest);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst diff = dest.sub(this.pos);\n\t\t\tif (diff.len() <= speed * dt()) {\n\t\t\t\tthis.pos = vec2(dest);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.move(diff.unit().scale(speed));\n\t\t},\n\n\t\t// TODO\n\t\t// get the screen position (transformed by camera)\n\t\tscreenPos(): Vec2 {\n\t\t\tif (this.fixed) {\n\t\t\t\treturn this.pos;\n\t\t\t} else {\n\t\t\t\treturn toScreen(this.pos);\n\t\t\t}\n\t\t},\n\n\t\tinspect() {\n\t\t\treturn `(${Math.round(this.pos.x)}, ${Math.round(this.pos.y)})`;\n\t\t},\n\n\t};\n\n};\n\n// TODO: allow single number assignment\nfunction scale(...args): ScaleComp {\n\tif (args.length === 0) {\n\t\treturn scale(1);\n\t}\n\treturn {\n\t\tid: \"scale\",\n\t\tscale: vec2(...args),\n\t\tscaleTo(...args) {\n\t\t\tthis.scale = vec2(...args);\n\t\t},\n\t\tinspect() {\n\t\t\tif (typeof this.scale === \"number\") {\n\t\t\t\treturn `${toFixed(this.scale, 2)}`;\n\t\t\t} else {\n\t\t\t\treturn `(${toFixed(this.scale.x, 2)}, ${toFixed(this.scale.y, 2)})`;\n\t\t\t}\n\t\t},\n\t};\n}\n\nfunction rotate(r: number): RotateComp {\n\treturn {\n\t\tid: \"rotate\",\n\t\tangle: r ?? 0,\n\t\tinspect() {\n\t\t\treturn `${Math.round(this.angle)}`;\n\t\t},\n\t};\n}\n\nfunction color(...args): ColorComp {\n\treturn {\n\t\tid: \"color\",\n\t\tcolor: rgb(...args),\n\t\tinspect() {\n\t\t\treturn this.color.str();\n\t\t},\n\t};\n}\n\nfunction toFixed(n: number, f: number) {\n\treturn Number(n.toFixed(f));\n}\n\nfunction opacity(a: number): OpacityComp {\n\treturn {\n\t\tid: \"opacity\",\n\t\topacity: a ?? 1,\n\t\tinspect() {\n\t\t\treturn `${toFixed(this.opacity, 2)}`;\n\t\t},\n\t};\n}\n\nfunction origin(o: Origin | Vec2): OriginComp {\n\tif (!o) {\n\t\tthrow new Error(\"please define an origin\");\n\t}\n\treturn {\n\t\tid: \"origin\",\n\t\torigin: o,\n\t\tinspect() {\n\t\t\tif (typeof this.origin === \"string\") {\n\t\t\t\treturn this.origin;\n\t\t\t} else {\n\t\t\t\treturn this.origin.str();\n\t\t\t}\n\t\t},\n\t};\n}\n\nfunction layer(l: string): LayerComp {\n\treturn {\n\t\tid: \"layer\",\n\t\tlayer: l,\n\t\tinspect() {\n\t\t\treturn this.layer ?? game.defLayer;\n\t\t},\n\t};\n}\n\nfunction z(z: number): ZComp {\n\treturn {\n\t\tid: \"z\",\n\t\tz: z,\n\t\tinspect() {\n\t\t\treturn `${this.z}`;\n\t\t},\n\t};\n}\n\nfunction follow(obj: GameObj, offset?: Vec2): FollowComp {\n\treturn {\n\t\tid: \"follow\",\n\t\trequire: [ \"pos\", ],\n\t\tfollow: {\n\t\t\tobj: obj,\n\t\t\toffset: offset ?? vec2(0),\n\t\t},\n\t\tadd() {\n\t\t\tif (obj.exists()) {\n\t\t\t\tthis.pos = this.follow.obj.pos.add(this.follow.offset);\n\t\t\t}\n\t\t},\n\t\tupdate() {\n\t\t\tif (obj.exists()) {\n\t\t\t\tthis.pos = this.follow.obj.pos.add(this.follow.offset);\n\t\t\t}\n\t\t},\n\t};\n}\n\nfunction move(dir: number | Vec2, speed: number): MoveComp {\n\tconst d = typeof dir === \"number\" ? Vec2.fromAngle(dir) : dir.unit();\n\treturn {\n\t\tid: \"move\",\n\t\trequire: [ \"pos\", ],\n\t\tupdate() {\n\t\t\tthis.move(d.scale(speed));\n\t\t},\n\t};\n}\n\nfunction outview(opt: OutviewCompOpt = {}): OutviewComp {\n\tlet timer = 0;\n\tlet isOut = false;\n\treturn {\n\t\tid: \"outview\",\n\t\trequire: [ \"pos\", \"area\", ],\n\t\tisOutOfView(): boolean {\n\t\t\tconst offset = vec2(opt.offset ?? 0);\n\t\t\tconst screenRect = new Rect(\n\t\t\t\tvec2(0, 0).sub(offset),\n\t\t\t\tvec2(width(), height()).add(offset),\n\t\t\t);\n\t\t\treturn !testAreaRect(this.screenArea(), screenRect);\n\t\t},\n\t\tonExitView(action: () => void): EventCanceller {\n\t\t\treturn this.on(\"exitView\", action);\n\t\t},\n\t\tonEnterView(action: () => void): EventCanceller {\n\t\t\treturn this.on(\"enterView\", action);\n\t\t},\n\t\tupdate() {\n\t\t\tif (this.isOutOfView()) {\n\t\t\t\tif (!isOut) {\n\t\t\t\t\tthis.trigger(\"exitView\");\n\t\t\t\t\tisOut = true;\n\t\t\t\t}\n\t\t\t\tif (opt.delay) {\n\t\t\t\t\ttimer += dt();\n\t\t\t\t\tif (timer < opt.delay) return\n\t\t\t\t}\n\t\t\t\tif (opt.hide) this.hidden = true;\n\t\t\t\tif (opt.pause) this.paused = true;\n\t\t\t\tif (opt.destroy) this.destroy();\n\t\t\t} else {\n\t\t\t\tif (isOut) {\n\t\t\t\t\tthis.trigger(\"enterView\");\n\t\t\t\t\tisOut = false;\n\t\t\t\t}\n\t\t\t\ttimer = 0;\n\t\t\t\tif (opt.hide) this.hidden = false;\n\t\t\t\tif (opt.pause) this.paused = false;\n\t\t\t}\n\t\t},\n\t\tinspect() {\n\t\t\treturn this.isOutOfView();\n\t\t},\n\t};\n}\n\nfunction cleanup(opt: (number | undefined) | CleanupCompOpt = {}): CleanupComp {\n\tif (typeof opt === \"number\") {\n\t\tdeprecateMsg(\"clean(time)\", \"cleanup({ delay: time })\");\n\t\treturn {\n\t\t\t...outview({\n\t\t\t\tdestroy: true,\n\t\t\t\tdelay: opt,\n\t\t\t}),\n\t\t\tid: \"cleanup\",\n\t\t};\n\t}\n\treturn {\n\t\t...outview({\n\t\t\tdestroy: true,\n\t\t\tonExitView: opt.onCleanup,\n\t\t\toffset: opt.offset,\n\t\t\tdelay: opt.delay,\n\t\t}),\n\t\tid: \"cleanup\",\n\t};\n}\n\nfunction area(opt: AreaCompOpt = {}): AreaComp {\n\n\tconst colliding = {};\n\n\treturn {\n\n\t\tid: \"area\",\n\n\t\tadd() {\n\t\t\tif (this.area.cursor) {\n\t\t\t\t// TODO: collect\n\t\t\t\tthis.onHover(() => cursor(this.area.cursor));\n\t\t\t}\n\t\t},\n\n\t\tarea: {\n\t\t\tshape: \"rect\",\n\t\t\toffset: opt.offset ?? vec2(0),\n\t\t\twidth: opt.width,\n\t\t\theight: opt.height,\n\t\t\tscale: opt.scale ?? vec2(1),\n\t\t\tcursor: opt.cursor,\n\t\t},\n\n\t\tisClicked(): boolean {\n\t\t\treturn isMousePressed() && this.isHovering();\n\t\t},\n\n\t\tisHovering() {\n\t\t\tconst mpos = this.fixed ? mousePos() : toWorld(mousePos());\n\t\t\treturn this.hasPoint(mpos);\n\t\t},\n\n\t\tisColliding(other) {\n\t\t\tif (!other.area || !other.exists()) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tconst a1 = this.worldArea();\n\t\t\tconst a2 = other.worldArea();\n\t\t\treturn testAreaArea(a1, a2);\n\t\t},\n\n\t\tisTouching(other) {\n\t\t\tif (!other.area || !other.exists()) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\t// TODO: support other shapes\n\t\t\tconst a1 = this.worldArea();\n\t\t\tconst a2 = other.worldArea();\n\t\t\treturn testRectRect2(a1, a2);\n\t\t},\n\n\t\tonClick(f: () => void): EventCanceller {\n\t\t\treturn this.onUpdate(() => {\n\t\t\t\tif (this.isClicked()) {\n\t\t\t\t\tf();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\n\t\tonHover(onHover: () => void, onNotHover: () => void): EventCanceller {\n\t\t\treturn this.onUpdate(() => {\n\t\t\t\tif (this.isHovering()) {\n\t\t\t\t\tonHover();\n\t\t\t\t} else {\n\t\t\t\t\tif (onNotHover) {\n\t\t\t\t\t\tonNotHover();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\n\t\tonCollide(tag: Tag, f: (o: GameObj, col?: Collision) => void): EventCanceller {\n\t\t\tconst e1 = this.onUpdate(() => this._checkCollisions(tag, f));\n\t\t\tconst e2 = this.on(\"collide\", (obj, col) => obj.is(tag) && f(obj, col));\n\t\t\treturn () => [e1, e2].forEach((f) => f());\n\t\t},\n\n\t\tclicks(...args) {\n\t\t\tdeprecateMsg(\"clicks()\", \"onClick()\");\n\t\t\treturn this.onClick(...args);\n\t\t},\n\n\t\thovers(...args) {\n\t\t\tdeprecateMsg(\"hovers()\", \"onHover()\");\n\t\t\treturn this.onHover(...args);\n\t\t},\n\n\t\tcollides(...args) {\n\t\t\tdeprecateMsg(\"collides()\", \"onCollide()\");\n\t\t\treturn this.onCollide(...args);\n\t\t},\n\n\t\thasPoint(pt: Vec2): boolean {\n\t\t\treturn testAreaPoint(this.worldArea(), pt);\n\t\t},\n\n\t\t// push an obj out of another if they're overlapped\n\t\tpushOut(obj: GameObj): Vec2 | null {\n\n\t\t\tif (obj === this) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\t// TODO: support other shapes\n\t\t\tif (obj.area?.shape !== \"rect\") {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst a1 = this.worldArea();\n\t\t\tconst a2 = obj.worldArea();\n\t\t\tconst md = minkDiff(a1, a2);\n\n\t\t\tif (!testRectPoint(md, vec2(0))) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tlet dist = Math.min(\n\t\t\t\tMath.abs(md.p1.x),\n\t\t\t\tMath.abs(md.p2.x),\n\t\t\t\tMath.abs(md.p1.y),\n\t\t\t\tMath.abs(md.p2.y),\n\t\t\t);\n\n\t\t\tconst res = (() => {\n\t\t\t\tswitch (dist) {\n\t\t\t\t\tcase Math.abs(md.p1.x): return vec2(dist, 0);\n\t\t\t\t\tcase Math.abs(md.p2.x): return vec2(-dist, 0);\n\t\t\t\t\tcase Math.abs(md.p1.y): return vec2(0, dist);\n\t\t\t\t\tcase Math.abs(md.p2.y): return vec2(0, -dist);\n\t\t\t\t}\n\t\t\t})();\n\n\t\t\tthis.pos = this.pos.add(res);\n\n\t\t},\n\n\t\t// push object out of other solid objects\n\t\tpushOutAll() {\n\t\t\tgame.root.every(this.pushOut);\n\t\t},\n\n\t\t// @ts-ignore\n\t\t_checkCollisions(tag: Tag) {\n\n\t\t\tgame.root.every(tag, (obj) => {\n\n\t\t\t\tif (this === obj || !this.exists() || colliding[obj._id]) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (this.isColliding(obj)) {\n\t\t\t\t\tthis.trigger(\"collide\", obj, null);\n\t\t\t\t\tcolliding[obj._id] = obj;\n\t\t\t\t}\n\n\t\t\t});\n\n\t\t\tfor (const id in colliding) {\n\t\t\t\tconst obj = colliding[id];\n\t\t\t\tif (!this.isColliding(obj)) {\n\t\t\t\t\tdelete colliding[id];\n\t\t\t\t}\n\t\t\t}\n\n\t\t},\n\n\t\t// TODO: doesn't work with nested parent transforms\n\t\t// TODO: cache\n\t\t// TODO: use matrix mult for more accuracy and rotation?\n\t\tworldArea(): Area {\n\n\t\t\tlet w = this.area.width ?? this.width;\n\t\t\tlet h = this.area.height ?? this.height;\n\n\t\t\tif (w == null || h == null) {\n\t\t\t\tthrow new Error(\"failed to get area dimension\");\n\t\t\t}\n\n\t\t\tconst scale = vec2(this.scale ?? 1).scale(this.area.scale);\n\n\t\t\tw *= scale.x;\n\t\t\th *= scale.y;\n\n\t\t\tconst orig = originPt(this.origin || DEF_ORIGIN);\n\t\t\tconst pos = (this.pos ?? vec2(0))\n\t\t\t\t.add(this.area.offset)\n\t\t\t\t.sub(orig.add(1, 1).scale(0.5).scale(w, h));\n\n\t\t\treturn {\n\t\t\t\tshape: \"rect\",\n\t\t\t\tp1: pos,\n\t\t\t\tp2: vec2(pos.x + w, pos.y + h),\n\t\t\t};\n\n\t\t},\n\n\t\tscreenArea(): Area {\n\t\t\tconst area = this.worldArea();\n\t\t\tif (this.fixed) {\n\t\t\t\treturn area;\n\t\t\t} else {\n\t\t\t\treturn {\n\t\t\t\t\tshape: \"rect\",\n\t\t\t\t\tp1: toScreen(area.p1),\n\t\t\t\t\tp2: toScreen(area.p2),\n\t\t\t\t};\n\t\t\t}\n\t\t},\n\n\t};\n\n}\n\n// make the list of common render properties from the \"pos\", \"scale\", \"color\", \"opacity\", \"rotate\", \"origin\", \"outline\", and \"shader\" components of a character\nfunction getRenderProps(obj: GameObj<any>) {\n\treturn {\n\t\tcolor: obj.color,\n\t\topacity: obj.opacity,\n\t\torigin: obj.origin,\n\t\toutline: obj.outline,\n\t\tfixed: obj.fixed,\n\t\tshader: assets.shaders[obj.shader],\n\t\tuniform: obj.uniform,\n\t};\n}\n\ninterface SpriteCurAnim {\n\tname: string,\n\ttimer: number,\n\tloop: boolean,\n\tspeed: number,\n\tpingpong: boolean,\n\tonEnd: () => void,\n}\n\n// TODO: clean\nfunction sprite(id: string | SpriteData, opt: SpriteCompOpt = {}): SpriteComp {\n\n\tlet spr = null;\n\tlet curAnim: SpriteCurAnim | null = null;\n\n\tfunction calcTexScale(tex: GfxTexture, q: Quad, w?: number, h?: number): Vec2 {\n\t\tconst scale = vec2(1, 1);\n\t\tif (w && h) {\n\t\t\tscale.x = w / (tex.width * q.w);\n\t\t\tscale.y = h / (tex.height * q.h);\n\t\t} else if (w) {\n\t\t\tscale.x = w / (tex.width * q.w);\n\t\t\tscale.y = scale.x;\n\t\t} else if (h) {\n\t\t\tscale.y = h / (tex.height * q.h);\n\t\t\tscale.x = scale.y;\n\t\t}\n\t\treturn scale;\n\t}\n\n\treturn {\n\n\t\tid: \"sprite\",\n\t\t// TODO: allow update\n\t\twidth: 0,\n\t\theight: 0,\n\t\tframe: opt.frame || 0,\n\t\tquad: opt.quad || new Quad(0, 0, 1, 1),\n\t\tanimSpeed: opt.animSpeed ?? 1,\n\n\t\tload() {\n\n\t\t\tif (typeof id === \"string\") {\n\t\t\t\tspr = assets.sprites[id];\n\t\t\t} else {\n\t\t\t\tspr = id;\n\t\t\t}\n\n\t\t\tif (!spr) {\n\t\t\t\tthrow new Error(`sprite not found: \"${id}\"`);\n\t\t\t}\n\n\t\t\tlet q = spr.frames[0].clone();\n\n\t\t\tif (opt.quad) {\n\t\t\t\tq = q.scale(opt.quad);\n\t\t\t}\n\n\t\t\tconst scale = calcTexScale(spr.tex, q, opt.width, opt.height);\n\n\t\t\tthis.width = spr.tex.width * q.w * scale.x;\n\t\t\tthis.height = spr.tex.height * q.h * scale.y;\n\n\t\t\tif (opt.anim) {\n\t\t\t\tthis.play(opt.anim);\n\t\t\t}\n\n\t\t},\n\n\t\tdraw() {\n\t\t\tdrawSprite({\n\t\t\t\t...getRenderProps(this),\n\t\t\t\tsprite: spr,\n\t\t\t\tframe: this.frame,\n\t\t\t\tquad: this.quad,\n\t\t\t\tflipX: opt.flipX,\n\t\t\t\tflipY: opt.flipY,\n\t\t\t\ttiled: opt.tiled,\n\t\t\t\twidth: opt.width,\n\t\t\t\theight: opt.height,\n\t\t\t});\n\t\t},\n\n\t\tupdate() {\n\n\t\t\tif (!curAnim) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst anim = spr.anims[curAnim.name];\n\n\t\t\tif (typeof anim === \"number\") {\n\t\t\t\tthis.frame = anim;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (anim.speed === 0) {\n\t\t\t\tthrow new Error(\"sprite anim speed cannot be 0\");\n\t\t\t}\n\n\t\t\tcurAnim.timer += dt() * this.animSpeed;\n\n\t\t\tif (curAnim.timer >= (1 / curAnim.speed)) {\n\t\t\t\tcurAnim.timer = 0;\n\t\t\t\t// TODO: clean up\n\t\t\t\tif (anim.from > anim.to) {\n\t\t\t\t\tthis.frame--;\n\t\t\t\t\tif (this.frame < anim.to) {\n\t\t\t\t\t\tif (curAnim.loop) {\n\t\t\t\t\t\t\tthis.frame = anim.from;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.frame++;\n\t\t\t\t\t\t\tcurAnim.onEnd();\n\t\t\t\t\t\t\tthis.stop();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tthis.frame++;\n\t\t\t\t\tif (this.frame > anim.to) {\n\t\t\t\t\t\tif (curAnim.loop) {\n\t\t\t\t\t\t\tthis.frame = anim.from;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.frame--;\n\t\t\t\t\t\t\tcurAnim.onEnd();\n\t\t\t\t\t\t\tthis.stop();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t},\n\n\t\t// TODO: this opt should be used instead of the sprite data opt, if given\n\t\tplay(name: string, opt: SpriteAnimPlayOpt = {}) {\n\n\t\t\tif (!spr) {\n\t\t\t\tonLoad(() => {\n\t\t\t\t\tthis.play(name, opt);\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst anim = spr.anims[name];\n\n\t\t\tif (anim == null) {\n\t\t\t\tthrow new Error(`anim not found: ${name}`);\n\t\t\t}\n\n\t\t\tif (curAnim) {\n\t\t\t\tthis.stop();\n\t\t\t}\n\n\t\t\tcurAnim = {\n\t\t\t\tname: name,\n\t\t\t\ttimer: 0,\n\t\t\t\tloop: opt.loop ?? anim.loop ?? false,\n\t\t\t\tpingpong: opt.pingpong ?? anim.pingpong ?? false,\n\t\t\t\tspeed: opt.speed ?? anim.speed ?? 10,\n\t\t\t\tonEnd: opt.onEnd ?? (() => {}),\n\t\t\t};\n\n\t\t\tif (typeof anim === \"number\") {\n\t\t\t\tthis.frame = anim;\n\t\t\t} else {\n\t\t\t\tthis.frame = anim.from;\n\t\t\t}\n\n\t\t\t// TODO: \"animPlay\" is deprecated\n\t\t\tthis.trigger(\"animPlay\", name);\n\t\t\tthis.trigger(\"animStart\", name);\n\n\t\t},\n\n\t\tstop() {\n\t\t\tif (!curAnim) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst prevAnim = curAnim.name;\n\t\t\tcurAnim = null;\n\t\t\tthis.trigger(\"animEnd\", prevAnim);\n\t\t},\n\n\t\tnumFrames() {\n\t\t\tif (!spr) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\treturn spr.frames.length;\n\t\t},\n\n\t\tcurAnim() {\n\t\t\treturn curAnim?.name;\n\t\t},\n\n\t\tflipX(b: boolean) {\n\t\t\topt.flipX = b;\n\t\t},\n\n\t\tflipY(b: boolean) {\n\t\t\topt.flipY = b;\n\t\t},\n\n\t\tonAnimEnd(name: string, action: () => void): EventCanceller {\n\t\t\treturn this.on(\"animEnd\", (anim) => {\n\t\t\t\tif (anim === name) {\n\t\t\t\t\taction();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\n\t\tonAnimStart(name: string, action: () => void): EventCanceller {\n\t\t\treturn this.on(\"animStart\", (anim) => {\n\t\t\t\tif (anim === name) {\n\t\t\t\t\taction();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\n\t\tinspect() {\n\t\t\tlet msg = \"\";\n\t\t\tif (typeof id === \"string\") {\n\t\t\t\tmsg += JSON.stringify(id);\n\t\t\t} else {\n\t\t\t\tmsg += \"[blob]\";\n\t\t\t}\n\t\t\treturn msg;\n\t\t},\n\n\t};\n\n}\n\nfunction text(t: string, opt: TextCompOpt = {}): TextComp {\n\n\tfunction update(obj: GameObj<TextComp | any>) {\n\n\t\tconst ftext = formatText({\n\t\t\t...getRenderProps(obj),\n\t\t\ttext: obj.text + \"\",\n\t\t\tsize: obj.textSize,\n\t\t\tfont: obj.font,\n\t\t\twidth: opt.width && obj.width,\n\t\t\tletterSpacing: obj.letterSpacing,\n\t\t\tlineSpacing: obj.lineSpacing,\n\t\t\ttransform: obj.transform,\n\t\t\tstyles: obj.styles,\n\t\t});\n\n\t\tobj.width = ftext.width / (obj.scale?.x || 1);\n\t\tobj.height = ftext.height / (obj.scale?.y || 1);\n\n\t\treturn ftext;\n\n\t};\n\n\treturn {\n\n\t\tid: \"text\",\n\t\ttext: t,\n\t\ttextSize: opt.size,\n\t\tfont: opt.font,\n\t\twidth: opt.width,\n\t\theight: 0,\n\t\tlineSpacing: opt.lineSpacing,\n\t\tletterSpacing: opt.letterSpacing,\n\t\ttransform: opt.transform,\n\t\tstyles: opt.styles,\n\n\t\tload() {\n\t\t\tupdate(this);\n\t\t},\n\n\t\tdraw() {\n\t\t\tdrawFormattedText(update(this));\n\t\t},\n\n\t};\n\n}\n\nfunction rect(w: number, h: number, opt: RectCompOpt = {}): RectComp {\n\treturn {\n\t\tid: \"rect\",\n\t\twidth: w,\n\t\theight: h,\n\t\tradius: opt.radius || 0,\n\t\tdraw() {\n\t\t\tdrawRect({\n\t\t\t\t...getRenderProps(this),\n\t\t\t\twidth: this.width,\n\t\t\t\theight: this.height,\n\t\t\t\tradius: this.radius,\n\t\t\t});\n\t\t},\n\t\tinspect() {\n\t\t\treturn `${Math.ceil(this.width)}, ${Math.ceil(this.height)}`;\n\t\t},\n\t};\n}\n\nfunction uvquad(w: number, h: number): UVQuadComp {\n\treturn {\n\t\tid: \"rect\",\n\t\twidth: w,\n\t\theight: h,\n\t\tdraw() {\n\t\t\tdrawUVQuad({\n\t\t\t\t...getRenderProps(this),\n\t\t\t\twidth: this.width,\n\t\t\t\theight: this.height,\n\t\t\t});\n\t\t},\n\t\tinspect() {\n\t\t\treturn `${Math.ceil(this.width)}, ${Math.ceil(this.height)}`;\n\t\t},\n\t};\n}\n\nfunction circle(radius: number): CircleComp {\n\treturn {\n\t\tid: \"circle\",\n\t\tradius: radius,\n\t\tdraw() {\n\t\t\tdrawCircle({\n\t\t\t\t...getRenderProps(this),\n\t\t\t\tradius: this.radius,\n\t\t\t});\n\t\t},\n\t\tinspect() {\n\t\t\treturn `${Math.ceil(this.radius)}`;\n\t\t},\n\t};\n}\n\nfunction outline(width: number = 1, color: Color = rgb(0, 0, 0)): OutlineComp {\n\treturn {\n\t\tid: \"outline\",\n\t\toutline: {\n\t\t\twidth,\n\t\t\tcolor,\n\t\t},\n\t};\n}\n\nfunction timer(time?: number, action?: () => void): TimerComp {\n\tconst timers: IDList<Timer> = new IDList();\n\tif (time && action) {\n\t\ttimers.pushd(new Timer(time, action));\n\t}\n\treturn {\n\t\tid: \"timer\",\n\t\twait(time: number, action: () => void): EventCanceller {\n\t\t\treturn timers.pushd(new Timer(time, action));\n\t\t},\n\t\tupdate() {\n\t\t\ttimers.forEach((timer, id) => {\n\t\t\t\tif (timer.tick(dt())) {\n\t\t\t\t\ttimers.delete(id);\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t};\n}\n\n// maximum y velocity with body()\nconst DEF_JUMP_FORCE = 640;\nconst MAX_VEL = 65536;\n\n// TODO: land on wall\nfunction body(opt: BodyCompOpt = {}): BodyComp {\n\n\tlet velY = 0;\n\tlet curPlatform: GameObj | null = null;\n\tlet lastPlatformPos = null;\n\tlet canDouble = true;\n\n\treturn {\n\n\t\tid: \"body\",\n\t\trequire: [ \"pos\", \"area\", ],\n\t\tjumpForce: opt.jumpForce ?? DEF_JUMP_FORCE,\n\t\tweight: opt.weight ?? 1,\n\t\tsolid: opt.solid ?? true,\n\n\t\tupdate() {\n\n\t\t\tlet justFall = false;\n\n\t\t\t// check if loses current platform\n\t\t\tif (curPlatform) {\n\n\t\t\t\tconst a1 = this.worldArea();\n\t\t\t\tconst a2 = curPlatform.worldArea();\n\t\t\t\tconst y1 = a1.p2.y;\n\t\t\t\tconst y2 = a2.p1.y;\n\t\t\t\tconst x1 = a1.p1.x;\n\t\t\t\tconst x2 = a1.p2.x;\n\t\t\t\tconst x3 = a2.p1.x;\n\t\t\t\tconst x4 = a2.p2.x;\n\n\t\t\t\tif (\n\t\t\t\t\t!curPlatform.exists()\n\t\t\t\t\t|| y1 !== y2\n\t\t\t\t\t|| x2 < x3\n\t\t\t\t\t|| x1 > x4\n\t\t\t\t) {\n\t\t\t\t\tthis.trigger(\"fall\", curPlatform);\n\t\t\t\t\tcurPlatform = null;\n\t\t\t\t\tlastPlatformPos = null;\n\t\t\t\t\tjustFall = true;\n\t\t\t\t} else {\n\t\t\t\t\tif (lastPlatformPos && curPlatform.pos) {\n\t\t\t\t\t\t// TODO: moveBy?\n\t\t\t\t\t\t// sticky platform\n\t\t\t\t\t\tthis.pos = this.pos.add(curPlatform.pos.sub(lastPlatformPos));\n\t\t\t\t\t\tlastPlatformPos = curPlatform.pos.clone();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!curPlatform) {\n\n\t\t\t\tconst col = this.move(0, velY);\n\n\t\t\t\t// check if grounded to a new platform\n\t\t\t\tif (col) {\n\t\t\t\t\tif (col.isBottom()) {\n\t\t\t\t\t\tcurPlatform = col.target;\n\t\t\t\t\t\tconst oy = velY;\n\t\t\t\t\t\tvelY = 0;\n\t\t\t\t\t\tif (curPlatform.pos) {\n\t\t\t\t\t\t\tlastPlatformPos = curPlatform.pos.clone();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!justFall) {\n\t\t\t\t\t\t\tthis.trigger(\"ground\", curPlatform);\n\t\t\t\t\t\t\tcanDouble = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (col.isTop()) {\n\t\t\t\t\t\tvelY = 0;\n\t\t\t\t\t\tthis.trigger(\"headbutt\", col.target);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tvelY += gravity() * this.weight * dt();\n\t\t\t\tvelY = Math.min(velY, opt.maxVel ?? MAX_VEL);\n\n\t\t\t}\n\n\t\t},\n\n\t\tcurPlatform(): GameObj | null {\n\t\t\treturn curPlatform;\n\t\t},\n\n\t\tisGrounded() {\n\t\t\treturn curPlatform !== null;\n\t\t},\n\n\t\tgrounded(): boolean {\n\t\t\tdeprecateMsg(\"grounded()\", \"isGrounded()\");\n\t\t\treturn this.isGrounded();\n\t\t},\n\n\t\tisFalling(): boolean {\n\t\t\treturn velY > 0;\n\t\t},\n\n\t\tfalling(): boolean {\n\t\t\tdeprecateMsg(\"falling()\", \"isFalling()\");\n\t\t\treturn this.isFalling();\n\t\t},\n\n\t\tjump(force: number) {\n\t\t\tcurPlatform = null;\n\t\t\tlastPlatformPos = null;\n\t\t\tvelY = -force || -this.jumpForce;\n\t\t},\n\n\t\tdoubleJump(force: number) {\n\t\t\tif (this.isGrounded()) {\n\t\t\t\tthis.jump(force);\n\t\t\t} else if (canDouble) {\n\t\t\t\tcanDouble = false;\n\t\t\t\tthis.jump(force);\n\t\t\t\tthis.trigger(\"doubleJump\");\n\t\t\t}\n\t\t},\n\n\t\tonGround(action: () => void): EventCanceller {\n\t\t\treturn this.on(\"ground\", action);\n\t\t},\n\n\t\tonFall(action: () => void): EventCanceller {\n\t\t\treturn this.on(\"fall\", action);\n\t\t},\n\n\t\tonHeadbutt(action: () => void): EventCanceller {\n\t\t\treturn this.on(\"headbutt\", action);\n\t\t},\n\n\t\tonDoubleJump(action: () => void): EventCanceller {\n\t\t\treturn this.on(\"doubleJump\", action);\n\t\t},\n\n\t};\n\n}\n\nfunction shader(id: string, uniform: Uniform = {}): ShaderComp {\n\tconst shader = assets.shaders[id];\n\treturn {\n\t\tid: \"shader\",\n\t\tshader: id,\n\t\tuniform: uniform,\n\t};\n}\n\nfunction solid(): SolidComp {\n\treturn {\n\t\tid: \"solid\",\n\t\trequire: [ \"area\", ],\n\t\tsolid: true,\n\t};\n}\n\nfunction fixed(): FixedComp {\n\treturn {\n\t\tid: \"fixed\",\n\t\tfixed: true,\n\t};\n}\n\nfunction stay(): StayComp {\n\treturn {\n\t\tid: \"stay\",\n\t\tstay: true,\n\t};\n}\n\nfunction health(hp: number): HealthComp {\n\tif (hp == null) {\n\t\tthrow new Error(\"health() requires the initial amount of hp\");\n\t}\n\treturn {\n\t\tid: \"health\",\n\t\thurt(n: number = 1) {\n\t\t\tthis.setHP(hp - n);\n\t\t\tthis.trigger(\"hurt\");\n\t\t},\n\t\theal(n: number = 1) {\n\t\t\tthis.setHP(hp + n);\n\t\t\tthis.trigger(\"heal\");\n\t\t},\n\t\thp(): number {\n\t\t\treturn hp;\n\t\t},\n\t\tsetHP(n: number) {\n\t\t\thp = n;\n\t\t\tif (hp <= 0) {\n\t\t\t\tthis.trigger(\"death\");\n\t\t\t}\n\t\t},\n\t\tonHurt(action: () => void): EventCanceller {\n\t\t\treturn this.on(\"hurt\", action);\n\t\t},\n\t\tonHeal(action: () => void): EventCanceller {\n\t\t\treturn this.on(\"heal\", action);\n\t\t},\n\t\tonDeath(action: () => void): EventCanceller {\n\t\t\treturn this.on(\"death\", action);\n\t\t},\n\t\tinspect() {\n\t\t\treturn `${hp}`;\n\t\t},\n\t};\n}\n\nfunction lifespan(time: number, opt: LifespanCompOpt = {}): LifespanComp {\n\tif (time == null) {\n\t\tthrow new Error(\"lifespan() requires time\");\n\t}\n\tlet timer = 0;\n\tconst fade = opt.fade ?? 0;\n\tconst startFade = Math.max((time - fade), 0);\n\treturn {\n\t\tid: \"lifespan\",\n\t\tupdate() {\n\t\t\ttimer += dt();\n\t\t\t// TODO: don't assume 1 as start opacity\n\t\t\tif (timer >= startFade) {\n\t\t\t\tthis.opacity = map(timer, startFade, time, 1, 0);\n\t\t\t}\n\t\t\tif (timer >= time) {\n\t\t\t\tthis.destroy();\n\t\t\t}\n\t\t},\n\t};\n}\n\nfunction state(\n\tinitState: string,\n\tstateList?: string[],\n\ttransitions?: Record<string, string | string[]>,\n): StateComp {\n\n\tif (!initState) {\n\t\tthrow new Error(\"state() requires an initial state\");\n\t}\n\n\tconst events = {};\n\n\tfunction initStateHook(state: string) {\n\t\tif (!events[state]) {\n\t\t\tevents[state] = {\n\t\t\t\tenter: [],\n\t\t\t\tleave: [],\n\t\t\t\tupdate: [],\n\t\t\t\tdraw: [],\n\t\t\t};\n\t\t}\n\t}\n\n\tfunction on(event, state, action) {\n\t\tinitStateHook(state);\n\t\tevents[state][event].push(action);\n\t}\n\n\tfunction trigger(event, state, ...args) {\n\t\tinitStateHook(state);\n\t\tevents[state][event].forEach((action) => action(...args));\n\t}\n\n\treturn {\n\n\t\tid: \"state\",\n\t\tstate: initState,\n\n\t\tenterState(state: string, ...args) {\n\n\t\t\tif (stateList && !stateList.includes(state)) {\n\t\t\t\tthrow new Error(`State not found: ${state}`);\n\t\t\t}\n\n\t\t\tconst oldState = this.state;\n\n\t\t\tif (transitions) {\n\n\t\t\t\t// check if the transition is legal, if transition graph is defined\n\t\t\t\tif (!transitions?.[oldState]) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst available = typeof transitions[oldState] === \"string\"\n\t\t\t\t\t? [transitions[oldState]]\n\t\t\t\t\t: transitions[oldState] as string[];\n\n\t\t\t\tif (!available.includes(state)) {\n\t\t\t\t\tthrow new Error(`Cannot transition state from \"${oldState}\" to \"${state}\". Available transitions: ${available.map((s) => `\"${s}\"`).join(\", \")}`);\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\ttrigger(\"leave\", oldState, ...args);\n\t\t\tthis.state = state;\n\t\t\ttrigger(\"enter\", state, ...args);\n\t\t\ttrigger(\"enter\", `${oldState} -> ${state}`, ...args);\n\n\t\t},\n\n\t\tonStateTransition(from: string, to: string, action: () => void) {\n\t\t\ton(\"enter\", `${from} -> ${to}`, action);\n\t\t},\n\n\t\tonStateEnter(state: string, action: () => void) {\n\t\t\ton(\"enter\", state, action);\n\t\t},\n\n\t\tonStateUpdate(state: string, action: () => void) {\n\t\t\ton(\"update\", state, action);\n\t\t},\n\n\t\tonStateDraw(state: string, action: () => void) {\n\t\t\ton(\"draw\", state, action);\n\t\t},\n\n\t\tonStateLeave(state: string, action: () => void) {\n\t\t\ton(\"leave\", state, action);\n\t\t},\n\n\t\tupdate() {\n\t\t\ttrigger(\"update\", this.state);\n\t\t},\n\n\t\tdraw() {\n\t\t\ttrigger(\"draw\", this.state);\n\t\t},\n\n\t\tinspect() {\n\t\t\treturn this.state;\n\t\t},\n\n\t};\n\n}\n\nfunction onLoad(cb: () => void): void {\n\tif (app.loaded) {\n\t\tcb();\n\t} else {\n\t\tgame.on(\"load\", cb);\n\t}\n}\n\nfunction scene(id: SceneID, def: SceneDef) {\n\tgame.scenes[id] = def;\n}\n\nfunction go(id: SceneID, ...args) {\n\n\tif (!game.scenes[id]) {\n\t\tthrow new Error(`scene not found: ${id}`);\n\t}\n\n\tconst cancel = game.on(\"updateStart\", () => {\n\n\t\tgame.events = {};\n\n\t\tgame.objEvents = {\n\t\t\tadd: new IDList(),\n\t\t\tupdate: new IDList(),\n\t\t\tdraw: new IDList(),\n\t\t\tdestroy: new IDList(),\n\t\t};\n\n\t\tgame.root.every((obj) => {\n\t\t\tif (!obj.is(\"stay\")) {\n\t\t\t\tgame.root.remove(obj);\n\t\t\t}\n\t\t})\n\n\t\tgame.root.clearEvents();\n\t\tgame.timers = new IDList();\n\n\t\t// cam\n\t\tgame.cam = {\n\t\t\tpos: center(),\n\t\t\tscale: vec2(1),\n\t\t\tangle: 0,\n\t\t\tshake: 0,\n\t\t\ttransform: new Mat4(),\n\t\t};\n\n\t\tgame.layers = {};\n\t\tgame.defLayer = null;\n\t\tgame.gravity = DEF_GRAVITY;\n\n\t\tgame.scenes[id](...args);\n\n\t\tif (gopt.debug !== false) {\n\t\t\tenterDebugMode();\n\t\t}\n\n\t\tif (gopt.burp) {\n\t\t\tenterBurpMode();\n\t\t}\n\n\t\tcancel();\n\n\t});\n\n}\n\nfunction getData<T>(key: string, def?: T): T {\n\ttry {\n\t\treturn JSON.parse(window.localStorage[key]);\n\t} catch {\n\t\tif (def) {\n\t\t\tsetData(key, def);\n\t\t\treturn def;\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t}\n}\n\nfunction setData(key: string, data: any) {\n\twindow.localStorage[key] = JSON.stringify(data);\n}\n\nfunction plug<T>(plugin: KaboomPlugin<T>): MergeObj<T> & KaboomCtx {\n\tconst funcs = plugin(ctx);\n\tfor (const k in funcs) {\n\t\t// @ts-ignore\n\t\tctx[k] = funcs[k];\n\t\tif (gopt.global !== false) {\n\t\t\t// @ts-ignore\n\t\t\twindow[k] = funcs[k];\n\t\t}\n\t}\n\treturn ctx as unknown as MergeObj<T> & KaboomCtx;\n}\n\nfunction center(): Vec2 {\n\treturn vec2(width() / 2, height() / 2);\n}\n\nfunction grid(level: Level, p: Vec2) {\n\n\treturn {\n\n\t\tid: \"grid\",\n\t\tgridPos: p.clone(),\n\n\t\tsetGridPos(...args) {\n\t\t\tconst p = vec2(...args);\n\t\t\tthis.gridPos = p.clone();\n\t\t\tthis.pos = vec2(\n\t\t\t\tlevel.offset().x + this.gridPos.x * level.gridWidth(),\n\t\t\t\tlevel.offset().y + this.gridPos.y * level.gridHeight()\n\t\t\t);\n\t\t},\n\n\t\tmoveLeft() {\n\t\t\tthis.setGridPos(this.gridPos.add(vec2(-1, 0)));\n\t\t},\n\n\t\tmoveRight() {\n\t\t\tthis.setGridPos(this.gridPos.add(vec2(1, 0)));\n\t\t},\n\n\t\tmoveUp() {\n\t\t\tthis.setGridPos(this.gridPos.add(vec2(0, -1)));\n\t\t},\n\n\t\tmoveDown() {\n\t\t\tthis.setGridPos(this.gridPos.add(vec2(0, 1)));\n\t\t},\n\n\t};\n\n}\n\nfunction addLevel(map: string[], opt: LevelOpt): Level {\n\n\tif (!opt.width || !opt.height) {\n\t\tthrow new Error(\"Must provide level grid width & height.\");\n\t}\n\n\tconst objs: GameObj[] = [];\n\tconst offset = vec2(opt.pos || vec2(0));\n\tlet longRow = 0;\n\n\tconst level = {\n\n\t\toffset() {\n\t\t\treturn offset.clone();\n\t\t},\n\n\t\tgridWidth() {\n\t\t\treturn opt.width;\n\t\t},\n\n\t\tgridHeight() {\n\t\t\treturn opt.height;\n\t\t},\n\n\t\tgetPos(...args): Vec2 {\n\t\t\tconst p = vec2(...args);\n\t\t\treturn vec2(\n\t\t\t\toffset.x + p.x * opt.width,\n\t\t\t\toffset.y + p.y * opt.height\n\t\t\t);\n\t\t},\n\n\t\tspawn(sym: string, ...args): GameObj {\n\n\t\t\tconst p = vec2(...args);\n\n\t\t\tconst comps = (() => {\n\t\t\t\tif (opt[sym]) {\n\t\t\t\t\tif (typeof opt[sym] !== \"function\") {\n\t\t\t\t\t\tthrow new Error(\"level symbol def must be a function returning a component list\");\n\t\t\t\t\t}\n\t\t\t\t\treturn opt[sym](p);\n\t\t\t\t} else if (opt.any) {\n\t\t\t\t\treturn opt.any(sym, p);\n\t\t\t\t}\n\t\t\t})();\n\n\t\t\tif (!comps) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst posComp = vec2(\n\t\t\t\toffset.x + p.x * opt.width,\n\t\t\t\toffset.y + p.y * opt.height\n\t\t\t);\n\n\t\t\tfor (const comp of comps) {\n\t\t\t\tif (comp.id === \"pos\") {\n\t\t\t\t\tposComp.x += comp.pos.x;\n\t\t\t\t\tposComp.y += comp.pos.y;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tcomps.push(pos(posComp));\n\t\t\tcomps.push(grid(this, p));\n\n\t\t\tconst obj = game.root.add(comps);\n\n\t\t\tobjs.push(obj);\n\n\t\t\treturn obj;\n\n\t\t},\n\n\t\twidth() {\n\t\t\treturn longRow * opt.width;\n\t\t},\n\n\t\theight() {\n\t\t\treturn map.length * opt.height;\n\t\t},\n\n\t\tdestroy() {\n\t\t\tfor (const obj of objs) {\n\t\t\t\tobj.destroy();\n\t\t\t}\n\t\t},\n\n\t};\n\n\tmap.forEach((row, i) => {\n\n\t\tconst syms = row.split(\"\");\n\n\t\tlongRow = Math.max(syms.length, longRow);\n\n\t\tsyms.forEach((sym, j) => {\n\t\t\tlevel.spawn(sym, vec2(j, i));\n\t\t});\n\n\t});\n\n\treturn level;\n\n}\n\nfunction record(frameRate?): Recording {\n\n\tconst stream = app.canvas.captureStream(frameRate);\n\tconst audioDest = audio.ctx.createMediaStreamDestination();\n\n\taudio.masterNode.connect(audioDest)\n\n\tconst audioStream = audioDest.stream;\n\tconst [firstAudioTrack] = audioStream.getAudioTracks();\n\n\t// TODO: Enabling audio results in empty video if no audio received\n\t// stream.addTrack(firstAudioTrack);\n\n\tconst recorder = new MediaRecorder(stream);\n\tconst chunks = [];\n\n\trecorder.ondataavailable = (e) => {\n\t\tif (e.data.size > 0) {\n\t\t\tchunks.push(e.data);\n\t\t}\n\t};\n\n\trecorder.onerror = (e) => {\n\t\taudio.masterNode.disconnect(audioDest)\n\t\tstream.getTracks().forEach(t => t.stop());\n\t};\n\n\trecorder.start();\n\n\treturn {\n\n\t\tresume() {\n\t\t\trecorder.resume();\n\t\t},\n\n\t\tpause() {\n\t\t\trecorder.pause();\n\t\t},\n\n\t\tdownload(filename = \"kaboom.mp4\") {\n\n\t\t\trecorder.onstop = () => {\n\t\t\t\tdownloadBlob(new Blob(chunks, {\n\t\t\t\t\ttype: \"video/mp4\",\n\t\t\t\t}), filename);\n\t\t\t}\n\n\t\t\trecorder.stop();\n\t\t\t// cleanup\n\t\t\taudio.masterNode.disconnect(audioDest)\n\t\t\tstream.getTracks().forEach(t => t.stop());\n\n\t\t},\n\n\t};\n\n}\n\nfunction focus() {\n\tdeprecateMsg(\"focus()\", \"canvas.focus()\");\n\tapp.canvas.focus();\n}\n\nfunction isFocused(): boolean {\n\treturn document.activeElement === app.canvas;\n}\n\ninterface BoomOpt {\n\t/**\n\t * Animation speed.\n\t */\n\tspeed?: number,\n\t/**\n\t * Scale.\n\t */\n\tscale?: number,\n\t/**\n\t * Additional ka components.\n\t */\n\tkaComps?: () => CompList<any>,\n\t/**\n\t * Additional boom components.\n\t */\n\tboomComps?: () => CompList<any>,\n}\n\n// aliases for root game obj operations\nfunction add<T>(comps: CompList<T>): GameObj<T> {\n\treturn game.root.add(comps);\n}\n\nfunction readd<T>(obj: GameObj<T>): GameObj<T> {\n\treturn game.root.readd(obj);\n}\n\nfunction destroy(obj: GameObj) {\n\treturn game.root.remove(obj);\n}\n\nfunction destroyAll(tag: Tag) {\n\treturn game.root.removeAll(tag);\n}\n\nfunction get(...args) {\n\treturn game.root.get(...args);\n}\n\nfunction every(...args) {\n\t// @ts-ignore\n\treturn game.root.every(...args);\n}\n\nfunction revery(...args) {\n\t// @ts-ignore\n\treturn game.root.revery(...args);\n}\n\ninterface ExplodeComp extends Comp {\n}\n\nfunction explode(speed: number = 2, size: number = 1): ExplodeComp {\n\tlet time = 0;\n\treturn {\n\t\tid: \"explode\",\n\t\trequire: [ \"scale\", ],\n\t\tupdate() {\n\t\t\tconst s = Math.sin(time * speed) * size;\n\t\t\tif (s < 0) {\n\t\t\t\tdestroy(this);\n\t\t\t}\n\t\t\tthis.scale = vec2(s);\n\t\t\ttime += dt();\n\t\t},\n\t};\n}\n\nlet kaSprite = null;\nlet boomSprite = null;\n\nloadSprite(null, kaSrc).then((spr) => kaSprite = spr);\nloadSprite(null, boomSrc).then((spr) => boomSprite = spr);\n\n// TODO: use children obj\nfunction addKaboom(p: Vec2, opt: BoomOpt = {}): Kaboom {\n\n\tconst speed = (opt.speed || 1) * 5;\n\tconst s = opt.scale || 1;\n\n\tconst boom = add([\n\t\tpos(p),\n\t\tsprite(boomSprite),\n\t\tscale(0),\n\t\tstay(),\n\t\torigin(\"center\"),\n\t\texplode(speed, s),\n\t\t...(opt.boomComps ?? (() => []))(),\n\t]);\n\n\tconst ka = add([\n\t\tpos(p),\n\t\tsprite(kaSprite),\n\t\tscale(0),\n\t\tstay(),\n\t\torigin(\"center\"),\n\t\ttimer(0.4 / speed, () => ka.use(explode(speed, s))),\n\t\t...(opt.kaComps ?? (() => []))(),\n\t]);\n\n\treturn {\n\t\tdestroy() {\n\t\t\tdestroy(ka);\n\t\t\tdestroy(boom);\n\t\t},\n\t};\n\n}\n\nfunction frames() {\n\treturn app.numFrames;\n}\n\nfunction updateFrame() {\n\n\tgame.trigger(\"updateStart\");\n\n\t// update timers\n\tgame.timers.forEach((t, id) => {\n\t\tt.time -= dt();\n\t\tif (t.time <= 0) {\n\t\t\t// TODO: some timer action causes crash on FF when dt is really high, not sure why\n\t\t\tt.action();\n\t\t\tgame.timers.delete(id);\n\t\t}\n\t});\n\n\t// update every obj\n\tgame.root.update();\n\n}\n\nfunction drawFrame() {\n\n\t// calculate camera matrix\n\tconst cam = game.cam;\n\tconst shake = Vec2.fromAngle(rand(0, 360)).scale(cam.shake);\n\n\tcam.shake = lerp(cam.shake, 0, 5 * dt());\n\tcam.transform = new Mat4()\n\t\t.translate(center())\n\t\t.scale(cam.scale)\n\t\t.rotateZ(cam.angle)\n\t\t.translate(cam.pos.scale(-1).add(shake))\n\t\t;\n\n\tgame.root.draw();\n\n}\n\nfunction drawLoadScreen() {\n\n\t// if assets are not fully loaded, draw a progress bar\n\tconst progress = loadProgress();\n\n\tif (progress === 1) {\n\t\tapp.loaded = true;\n\t\tgame.trigger(\"load\");\n\t} else {\n\n\t\tconst w = width() / 2;\n\t\tconst h = 24 / app.scale;\n\t\tconst pos = vec2(width() / 2, height() / 2).sub(vec2(w / 2, h / 2));\n\n\t\tdrawRect({\n\t\t\tpos: vec2(0),\n\t\t\twidth: width(),\n\t\t\theight: height(),\n\t\t\tcolor: rgb(0, 0, 0),\n\t\t});\n\n\t\tdrawRect({\n\t\t\tpos: pos,\n\t\t\twidth: w,\n\t\t\theight: h,\n\t\t\tfill: false,\n\t\t\toutline: {\n\t\t\t\twidth: 4 / app.scale,\n\t\t\t},\n\t\t});\n\n\t\tdrawRect({\n\t\t\tpos: pos,\n\t\t\twidth: w * progress,\n\t\t\theight: h,\n\t\t});\n\n\t}\n\n}\n\nfunction drawInspectText(pos, txt) {\n\n\tconst pad = vec2(8);\n\n\tpushTransform();\n\tpushTranslate(pos);\n\tpushScale(1 / app.scale);\n\n\tconst ftxt = formatText({\n\t\ttext: txt,\n\t\tfont: assets.fonts[DBG_FONT],\n\t\tsize: 16,\n\t\tpos: pad,\n\t\tcolor: rgb(255, 255, 255),\n\t\tfixed: true,\n\t});\n\n\tconst bw = ftxt.width + pad.x * 2;\n\tconst bh = ftxt.height + pad.x * 2;\n\n\tif (pos.x + bw / app.scale >= width()) {\n\t\tpushTranslate(vec2(-bw, 0));\n\t}\n\n\tif (pos.y + bh / app.scale >= height()) {\n\t\tpushTranslate(vec2(0, -bh));\n\t}\n\n\tdrawRect({\n\t\twidth: bw,\n\t\theight: bh,\n\t\tcolor: rgb(0, 0, 0),\n\t\tradius: 4,\n\t\topacity: 0.8,\n\t\tfixed: true,\n\t});\n\n\tdrawFormattedText(ftxt);\n\tpopTransform();\n\n}\n\nfunction drawDebug() {\n\n\tif (debug.inspect) {\n\n\t\tlet inspecting = null;\n\t\tconst lcolor = Color.fromArray(gopt.inspectColor ?? [0, 0, 255]);\n\n\t\t// draw area outline\n\t\tgame.root.every((obj) => {\n\n\t\t\tif (!obj.area) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (obj.hidden) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!inspecting) {\n\t\t\t\tif (obj.isHovering()) {\n\t\t\t\t\tinspecting = obj;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst lwidth = (inspecting === obj ? 8 : 4);\n\t\t\tconst a = obj.worldArea();\n\t\t\tconst w = a.p2.x - a.p1.x;\n\t\t\tconst h = a.p2.y - a.p1.y;\n\n\t\t\tdrawRect({\n\t\t\t\tpos: a.p1,\n\t\t\t\twidth: w,\n\t\t\t\theight: h,\n\t\t\t\toutline: {\n\t\t\t\t\twidth: lwidth,\n\t\t\t\t\tcolor: lcolor,\n\t\t\t\t},\n\t\t\t\tfill: false,\n\t\t\t\tfixed: obj.fixed,\n\t\t\t});\n\n\t\t});\n\n\t\tif (inspecting) {\n\n\t\t\tconst lines = [];\n\t\t\tconst data = inspecting.inspect();\n\n\t\t\tfor (const tag in data) {\n\t\t\t\tif (data[tag]) {\n\t\t\t\t\tlines.push(`${tag}: ${data[tag]}`);\n\t\t\t\t} else {\n\t\t\t\t\tlines.push(`${tag}`);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tdrawInspectText(mousePos(), lines.join(\"\\n\"));\n\n\t\t}\n\n\t\tdrawInspectText(vec2(8 / app.scale), `FPS: ${debug.fps()}`);\n\n\t}\n\n\tif (debug.paused) {\n\n\t\t// top right corner\n\t\tpushTransform();\n\t\tpushTranslate(width(), 0);\n\t\tpushScale(1 / app.scale);\n\t\tpushTranslate(-8, 8);\n\n\t\tconst size = 32;\n\n\t\t// bg\n\t\tdrawRect({\n\t\t\twidth: size,\n\t\t\theight: size,\n\t\t\torigin: \"topright\",\n\t\t\tcolor: rgb(0, 0, 0),\n\t\t\topacity: 0.8,\n\t\t\tradius: 4,\n\t\t\tfixed: true,\n\t\t});\n\n\t\t// pause icon\n\t\tfor (let i = 1; i <= 2; i++) {\n\t\t\tdrawRect({\n\t\t\t\twidth: 4,\n\t\t\t\theight: size * 0.6,\n\t\t\t\torigin: \"center\",\n\t\t\t\tpos: vec2(-size / 3 * i, size * 0.5),\n\t\t\t\tcolor: rgb(255, 255, 255),\n\t\t\t\tradius: 2,\n\t\t\t\tfixed: true,\n\t\t\t});\n\t\t}\n\n\t\tpopTransform();\n\n\t}\n\n\tif (debug.timeScale !== 1) {\n\n\t\t// bottom right corner\n\t\tpushTransform();\n\t\tpushTranslate(width(), height());\n\t\tpushScale(1 / app.scale);\n\t\tpushTranslate(-8, -8);\n\n\t\tconst pad = 8;\n\n\t\t// format text first to get text size\n\t\tconst ftxt = formatText({\n\t\t\ttext: debug.timeScale.toFixed(1),\n\t\t\tfont: assets.fonts[DBG_FONT],\n\t\t\tsize: 16,\n\t\t\tcolor: rgb(255, 255, 255),\n\t\t\tpos: vec2(-pad),\n\t\t\torigin: \"botright\",\n\t\t\tfixed: true,\n\t\t});\n\n\t\t// bg\n\t\tdrawRect({\n\t\t\twidth: ftxt.width + pad * 2 + pad * 4,\n\t\t\theight: ftxt.height + pad * 2,\n\t\t\torigin: \"botright\",\n\t\t\tcolor: rgb(0, 0, 0),\n\t\t\topacity: 0.8,\n\t\t\tradius: 4,\n\t\t\tfixed: true,\n\t\t});\n\n\t\t// fast forward / slow down icon\n\t\tfor (let i = 0; i < 2; i++) {\n\t\t\tconst flipped = debug.timeScale < 1;\n\t\t\tdrawTriangle({\n\t\t\t\tp1: vec2(-ftxt.width - pad * (flipped ? 2 : 3.5), -pad),\n\t\t\t\tp2: vec2(-ftxt.width - pad * (flipped ? 2 : 3.5), -pad - ftxt.height),\n\t\t\t\tp3: vec2(-ftxt.width - pad * (flipped ? 3.5 : 2), -pad - ftxt.height / 2),\n\t\t\t\tpos: vec2(-i * pad * 1 + (flipped ? -pad * 0.5 : 0), 0),\n\t\t\t\tcolor: rgb(255, 255, 255),\n\t\t\t\tfixed: true,\n\t\t\t});\n\t\t}\n\n\t\t// text\n\t\tdrawFormattedText(ftxt);\n\n\t\tpopTransform();\n\n\t}\n\n\tif (debug.curRecording) {\n\n\t\tpushTransform();\n\t\tpushTranslate(0, height());\n\t\tpushScale(1 / app.scale);\n\t\tpushTranslate(24, -24);\n\n\t\tdrawCircle({\n\t\t\tradius: 12,\n\t\t\tcolor: rgb(255, 0, 0),\n\t\t\topacity: wave(0, 1, time() * 4),\n\t\t\tfixed: true,\n\t\t});\n\n\t\tpopTransform();\n\n\t}\n\n\tif (debug.showLog && game.logs.length > 0) {\n\n\t\tpushTransform();\n\t\tpushTranslate(0, height());\n\t\tpushScale(1 / app.scale);\n\t\tpushTranslate(8, -8);\n\n\t\tconst pad = 8;\n\t\tconst max = gopt.logMax ?? 1;\n\n\t\tif (game.logs.length > max) {\n\t\t\tgame.logs = game.logs.slice(0, max);\n\t\t}\n\n\t\tconst ftext = formatText({\n\t\t\ttext: game.logs.join(\"\\n\"),\n\t\t\tfont: assets.fonts[DBG_FONT],\n\t\t\tpos: vec2(pad, -pad),\n\t\t\torigin: \"botleft\",\n\t\t\tsize: 16,\n\t\t\twidth: width() * app.scale * 0.6,\n\t\t\tlineSpacing: pad / 2,\n\t\t\tfixed: true,\n\t\t\tstyles: {\n\t\t\t\t\"time\": { color: rgb(127, 127, 127) },\n\t\t\t\t\"info\": { color: rgb(255, 255, 255) },\n\t\t\t\t\"error\": { color: rgb(255, 0, 127) },\n\t\t\t},\n\t\t});\n\n\t\tdrawRect({\n\t\t\twidth: ftext.width + pad * 2,\n\t\t\theight: ftext.height + pad * 2,\n\t\t\torigin: \"botleft\",\n\t\t\tcolor: rgb(0, 0, 0),\n\t\t\tradius: 4,\n\t\t\topacity: 0.8,\n\t\t\tfixed: true,\n\t\t});\n\n\t\tdrawFormattedText(ftext);\n\t\tpopTransform();\n\n\t}\n\n}\n\nif (gopt.debug !== false) {\n\tenterDebugMode();\n}\n\nif (gopt.burp) {\n\tenterBurpMode();\n}\n\nwindow.addEventListener(\"error\", (e) => {\n\tdebug.error(`Error: ${e.error.message}`);\n\tquit();\n\trun(() => {\n\t\tif (loadProgress() === 1) {\n\t\t\tframeStart();\n\t\t\tdrawDebug();\n\t\t\tframeEnd();\n\t\t}\n\t});\n});\n\nfunction run(f: () => void) {\n\n\tconst frame = (t: number) => {\n\n\t\tif (document.visibilityState !== \"visible\") {\n\t\t\tapp.loopID = requestAnimationFrame(frame);\n\t\t\treturn;\n\t\t}\n\n\t\tconst realTime = t / 1000;\n\t\tconst realDt = realTime - app.realTime;\n\n\t\tapp.realTime = realTime;\n\n\t\tif (!app.skipTime) {\n\t\t\tapp.dt = realDt;\n\t\t\tapp.time += app.dt;\n\t\t\tapp.fpsCounter.tick(app.dt);\n\t\t}\n\n\t\tapp.skipTime = false;\n\t\tapp.numFrames++;\n\n\t\tf();\n\n\t\tfor (const k in app.keyStates) {\n\t\t\tapp.keyStates[k] = processButtonState(app.keyStates[k]);\n\t\t}\n\n\t\tfor (const m in app.mouseStates) {\n\t\t\tapp.mouseStates[m] = processButtonState(app.mouseStates[m]);\n\t\t}\n\n\t\tapp.charInputted = [];\n\t\tapp.isMouseMoved = false;\n\t\tapp.isKeyPressed = false;\n\t\tapp.isKeyPressedRepeat = false;\n\t\tapp.isKeyReleased = false;\n\t\tapp.loopID = requestAnimationFrame(frame);\n\n\t};\n\n\tapp.stopped = false;\n\tapp.loopID = requestAnimationFrame(frame);\n\n}\n\n// main game loop\nrun(() => {\n\n\t// running this every frame now mainly because isFullscreen() is not updated real time when requested fullscreen\n\tupdateViewport();\n\n\tif (!app.loaded) {\n\t\tframeStart();\n\t\tdrawLoadScreen();\n\t\tframeEnd();\n\t} else {\n\n\t\t// TODO: this gives the latest mousePos in input handlers but uses cam matrix from last frame\n\t\tgame.trigger(\"input\");\n\n\t\tif (!debug.paused) {\n\t\t\tupdateFrame();\n\t\t}\n\n\t\tframeStart();\n\t\tdrawFrame();\n\n\t\tif (gopt.debug !== false) {\n\t\t\tdrawDebug();\n\t\t}\n\n\t\tframeEnd();\n\n\t}\n\n});\n\nloadFont(\n\t\"apl386\",\n\tapl386Src,\n\t45,\n\t74,\n);\n\nloadFont(\n\t\"apl386o\",\n\tapl386oSrc,\n\t45,\n\t74,\n);\n\nloadFont(\n\t\"sink\",\n\tsinkSrc,\n\t6,\n\t8,\n\t{\n\t\tchars: ` !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\\\]^_\\`abcdefghijklmnopqrstuvwxyz{|}~`,\n\t}\n);\n\nloadFont(\n\t\"sinko\",\n\tsinkoSrc,\n\t8,\n\t10,\n);\n\nframeStart();\nframeEnd();\n\n// the exported ctx handle\nconst ctx: KaboomCtx = {\n\t// asset load\n\tloadRoot,\n\tloadSprite,\n\tloadSpriteAtlas,\n\tloadSound,\n\tloadFont,\n\tloadShader,\n\tloadAseprite,\n\tloadPedit,\n\tloadBean,\n\tload,\n\t// query\n\twidth,\n\theight,\n\tcenter,\n\tdt,\n\ttime,\n\tscreenshot,\n\trecord,\n\tisFocused,\n\tfocus,\n\tcursor,\n\tregCursor,\n\tfullscreen,\n\tisFullscreen,\n\tonLoad,\n\tisTouch: () => app.isTouch,\n\t// misc\n\tlayers,\n\tcamPos,\n\tcamScale,\n\tcamRot,\n\tshake,\n\ttoScreen,\n\ttoWorld,\n\tgravity,\n\t// obj\n\tadd,\n\treadd,\n\tdestroy,\n\tdestroyAll,\n\tget,\n\tevery,\n\trevery,\n\t// comps\n\tpos,\n\tscale,\n\trotate,\n\tcolor,\n\topacity,\n\torigin,\n\tlayer,\n\tarea,\n\tsprite,\n\ttext,\n\trect,\n\tcircle,\n\tuvquad,\n\toutline,\n\tbody,\n\tshader,\n\ttimer,\n\tsolid,\n\tfixed,\n\tstay,\n\thealth,\n\tlifespan,\n\tz,\n\tmove,\n\toutview,\n\tcleanup,\n\tfollow,\n\tstate,\n\t// group events\n\ton,\n\tonUpdate,\n\tonDraw,\n\tonCollide,\n\tonClick,\n\tonHover,\n\t// input\n\tonKeyDown,\n\tonKeyPress,\n\tonKeyPressRepeat,\n\tonKeyRelease,\n\tonMouseDown,\n\tonMousePress,\n\tonMouseRelease,\n\tonMouseMove,\n\tonCharInput,\n\tonTouchStart,\n\tonTouchMove,\n\tonTouchEnd,\n\tmousePos,\n\tmouseWorldPos,\n\tmouseDeltaPos,\n\tisKeyDown,\n\tisKeyPressed,\n\tisKeyPressedRepeat,\n\tisKeyReleased,\n\tisMouseDown,\n\tisMousePressed,\n\tisMouseReleased,\n\tisMouseMoved,\n\t// timer\n\tloop,\n\twait,\n\t// audio\n\tplay,\n\tvolume,\n\tburp,\n\taudioCtx: audio.ctx,\n\t// math\n\tTimer,\n\tLine,\n\tRect,\n\tCircle,\n\tVec2,\n\tColor,\n\tMat4,\n\tQuad,\n\tRNG,\n\trng,\n\trand,\n\trandi,\n\trandSeed,\n\tvec2,\n\trgb,\n\thsl2rgb,\n\tquad,\n\tchoose,\n\tchance,\n\tlerp,\n\tmap,\n\tmapc,\n\twave,\n\tdeg2rad,\n\trad2deg,\n\ttestAreaRect,\n\ttestAreaLine,\n\ttestAreaCircle,\n\ttestAreaPolygon,\n\ttestAreaPoint,\n\ttestAreaArea,\n\ttestLineLine,\n\ttestRectRect,\n\ttestRectLine,\n\ttestRectPoint,\n\ttestPolygonPoint,\n\ttestLinePolygon,\n\ttestPolygonPolygon,\n\ttestCircleCircle,\n\ttestCirclePoint,\n\ttestRectPolygon,\n\t// raw draw\n\tdrawSprite,\n\tdrawText,\n\tformatText,\n\tdrawRect,\n\tdrawLine,\n\tdrawLines,\n\tdrawTriangle,\n\tdrawCircle,\n\tdrawEllipse,\n\tdrawUVQuad,\n\tdrawPolygon,\n\tdrawFormattedText,\n\tpushTransform,\n\tpopTransform,\n\tpushTranslate,\n\tpushRotate: pushRotateZ,\n\tpushScale,\n\t// debug\n\tdebug,\n\t// scene\n\tscene,\n\tgo,\n\t// level\n\taddLevel,\n\t// storage\n\tgetData,\n\tsetData,\n\t// plugin\n\tplug,\n\t// char sets\n\tASCII_CHARS,\n\tCP437_CHARS,\n\t// dom\n\tcanvas: app.canvas,\n\t// misc\n\taddKaboom,\n\t// dirs\n\tLEFT: Vec2.LEFT,\n\tRIGHT: Vec2.RIGHT,\n\tUP: Vec2.UP,\n\tDOWN: Vec2.DOWN,\n\t// colors\n\tRED: Color.RED,\n\tGREEN: Color.GREEN,\n\tBLUE: Color.BLUE,\n\tYELLOW: Color.YELLOW,\n\tMAGENTA: Color.MAGENTA,\n\tCYAN: Color.CYAN,\n\tWHITE: Color.WHITE,\n\tBLACK: Color.BLACK,\n\t// deprecated\n\tkeyIsDown: deprecate(\"keyIsDown()\", \"isKeyDown()\", isKeyDown),\n\tkeyIsPressed: deprecate(\"keyIsPressed()\", \"isKeyPressed()\", isKeyPressed),\n\tkeyIsPressedRep: deprecate(\"keyIsPressedRep()\", \"isKeyPressedRepeat()\", isKeyPressedRepeat),\n\tkeyIsReleased: deprecate(\"keyIsReleased()\", \"isKeyReleased()\", isKeyReleased),\n\tmouseIsDown: deprecate(\"mouseIsDown()\", \"isMouseDown()\", isMouseDown),\n\tmouseIsClicked: deprecate(\"mouseIsClicked()\", \"isMousePressed()\", isMousePressed),\n\tmouseIsReleased: deprecate(\"mouseIsReleased()\", \"isMouseReleased()\", isMouseReleased),\n\tmouseIsMoved: deprecate(\"mouseIsMoved()\", \"isMouseMoved()\", isMouseMoved),\n\tdir: deprecate(\"dir()\", \"Vec2.fromAngle()\", Vec2.fromAngle),\n\taction: deprecate(\"action()\", \"onUpdate()\", onUpdate),\n\trender: deprecate(\"render()\", \"onDraw()\", onDraw),\n\tcollides: deprecate(\"collides()\", \"onCollide()\", onCollide),\n\tclicks: deprecate(\"clicks()\", \"onClick()\", onClick),\n\thovers: deprecate(\"hovers()\", \"onHover()\", onHover),\n\tkeyDown: deprecate(\"keyDown()\", \"onKeyDown()\", onKeyDown),\n\tkeyPress: deprecate(\"keyPress()\", \"onKeyPress()\", onKeyPress),\n\tkeyPressRep: deprecate(\"keyPressRep()\", \"onKeyPressRepeat()\", onKeyPressRepeat),\n\tkeyRelease: deprecate(\"keyRelease()\", \"onKeyRelease()\", onKeyRelease),\n\tmouseDown: deprecate(\"mouseDown()\", \"onMouseDown()\", onMouseDown),\n\tmouseClick: deprecate(\"mouseClick()\", \"onMousePress()\", onMousePress),\n\tmouseRelease: deprecate(\"mouseRelease()\", \"onMouseRelease()\", onMouseRelease),\n\tmouseMove: deprecate(\"mouseMove()\", \"onMouseMove()\", onMouseMove),\n\tcharInput: deprecate(\"charInput()\", \"onCharInput()\", onCharInput),\n\ttouchStart: deprecate(\"touchStart()\", \"onTouchStart()\", onTouchStart),\n\ttouchMove: deprecate(\"touchMove()\", \"onTouchMove()\", onTouchMove),\n\ttouchEnd: deprecate(\"touchEnd()\", \"onTouchEnd()\", onTouchEnd),\n\tfocused: deprecate(\"focused()\", \"isFocused()\", isFocused),\n\tready: deprecate(\"ready()\", \"onLoad()\", onLoad),\n};\n\nif (gopt.plugins) {\n\tgopt.plugins.forEach(plug);\n}\n\n// export everything to window if global is set\nif (gopt.global !== false) {\n\tfor (const k in ctx) {\n\t\twindow[k] = ctx[k];\n\t}\n}\n\nreturn ctx;\n\n};\n","import kaboom from \"kaboom\";\n\nkaboom({\n    width: 1500,\n    height: 1000,\n    background: [ 100, 125, 0 ]\n});\n\nconst hero = \"/test/man.png\";\nconst villan2 = \"/test/skeleton.png\";\nconst villan = \"/test/Pog.png\";\nconst bulletGraphPlace = \"/test/bulletWS.png\";\nconst SPEED = 500;\nconst ENEMY_SPEED = 250;\nlet dmg = 10;\nlet time = 0;\nlet timeA = 0;\nconst BULLET_SPEED = 600;\nlet enemyHP = 1000;\nlet enemyHPC = enemyHP;\nlet Length = width()/enemyHP;\nlet canShot = 1;\nlet cash = 0;\n\nloadSprite(\"hero\", hero)\nloadSprite(\"BUG\", bulletGraphPlace, {\n    sliceX: 5,\n\n    anims: {\n        \"idle\":{\n            from: 0,\n            to: 4,\n            speed: 4,\n            loop: true,\n        }\n    } \n})\nloadSprite(\"HealthPack\", \"/test/healthUp.png\", {\n    sliceX: 5,\n\n    anims: {\n        \"idle\":{\n            from: 0,\n            to: 4,\n            speed: 4,\n            loop: true,\n        }\n    } \n})\nloadSprite(\"vil\", villan, {\n    sliceX: 4,\n    width: 112,\n    \n    anims: {\n        \"move\":{\n            from: 0,\n            to: 3,\n            speed: 5,\n            loop: true,\n        }\n    } \n})\nloadSprite(\"vil2\", villan2, {\n    sliceX: 3,\n    \n    anims: {\n        \"move\":{\n            from: 0,\n            to: 2,\n            speed: 5,\n            loop: true,\n        }\n    } \n})\n\nscene(\"start\", () => {\n    add([\n        rect(250,100),\n        color(WHITE),\n        pos(center().sub(125,100)),\n        area(),\n        \"StartButton\",\n        text(\"start\")\n    ])\n    add([\n        rect(250,100),\n        color(WHITE),\n        pos(center().sub(125, 0)),\n        area(),\n        \"upgrade\",\n        text(\"upgrades\")\n    ])\n\n    onClick(\"StartButton\", () => go(\"LevelSelector\"))\n    \n    onClick(\"upgrade\", () => go(\"Upgrade\"))\n    \n\n})\nscene(\"LevelSelector\", () => {\n    add([\n        text(\"Press the enemy you want to fight\"),\n        pos(20,0),\n        scale(0.9)\n    ])\n    add([\n        rect(300,300),\n        color(255,255,0),\n        pos(50, height()/2-100),\n        area(),\n        \"Level1\",\n    ])\n    add([\n        sprite(\"vil\"),\n        pos(25, height()/2-70),\n        scale(12),\n    ])\n    add([\n        text(\"Slimy boi\"),\n        pos(70, height()/2-170),\n        scale(0.5)\n    ])\n    onClick(\"Level1\", () => go(\"lvl1\"))\n    add([\n        rect(300,300),\n        color(255,255,0),\n        pos(450, height()/2-100),\n        area(),\n        \"Level2\",\n    ])\n    add([\n        sprite(\"vil2\"),\n        pos(480, height()/2-70),\n        scale(14),\n    ])\n    add([\n        text(\"Skeletony boi\"),\n        pos(470, height()/2-170),\n        scale(0.5)\n    ])\n    onClick(\"Level2\", () => go(\"lvl2\"))\n\n    makeBackButton();\n  \n\n\n\n\n\n})\nscene(\"lvl1\", () => {\n\n    \n// Add player game object\nconst player = add([\n    sprite(\"hero\"),\n    pos((100, 100)),\n    area(),\n    origin(\"center\"),\n    scale(3),\n])\n\n\n\n    const enemy = add([\n        sprite(\"vil\"),\n        pos((1000, 1000)),\n        area({ scale: 0.6 }),\n        state[\"move\"],\n        \"enemy\",\n        origin(\"center\"),\n        scale(5),\n    ])\n    enemy.play(\"move\")\n    movePlayer(player);\n\n    const healthbar =  add([\n        rect(Length*enemyHP, 14),\n        color(GREEN), \n        pos(0,0),\n        \"hp\",\n        {\n            set(Health){\n                this.width = Length*enemyHP;\n            }\n        }\n    ])\n    \n    onUpdate(() => {\n        if (!player.exists()) return\n        if (!enemy.exists()) return\n    \n    \n        const dir = player.pos.sub(enemy.pos).unit()\n        enemy.move(dir.scale(ENEMY_SPEED))  \n        if(time == 20){\n            enemyNS(enemy.pos, dir);\n            time = 0;\n        }\n        if(timeA >= 150 && enemyHP < enemyHPC/2){\n            //circleAt(10, enemy.pos);\n            fireworkAT(20, enemy.pos, dir)\n            timeA = 0;\n        }\n        timeA += 1;\n        time += 1;\n    })\n\n    \n    \n    player.onCollide(\"bullet\", () =>{\n        destroy(player);\n        makeBackButton();\n        cash += 1000/enemyHP;\n    })\n    \n    enemy.onCollide(\"MyB\", () =>{\n        enemyHP -= dmg;\n        if(enemyHP <= 0){\n            destroy(enemy);\n            cash += 2000;\n            makeBackButton();\n        }\n        healthbar.set()\n    })\n\n    onClick(shot);\n    onMouseDown(shot);\n    function shot(){\n        if (!player.exists() || !canShot == 1) return\n        const Mpos = mousePos();\n        const dir2 = Mpos.sub(player.pos).unit()\n        add([\n            pos(player.pos),\n            rect(12,12),\n            area(),\n            handleout(),\n            color(BLUE),\n            move(dir2, 1000),\n            \"MyB\",\n            \"WallB\",\n            ])\n        canShot = 0\n        wait(0.25, () => canShot = 1)\n    }\n    \n\n\n\n})\nscene(\"lvl2\", () => {\n\n    enemyHP = 2500\n    enemyHPC = enemyHP;\n    Length = width()/enemyHP\n    const player = add([\n        sprite(\"hero\"),\n        pos((100, 100)),\n        area(),\n        origin(\"center\"),\n        scale(3),\n    ])\n    \n    \n    \n        const enemy = add([\n            sprite(\"vil2\"),\n            pos((1000, 700)),\n            area({ scale: 0.6 }),\n            state[\"move\"],\n            \"enemy\",\n            origin(\"center\"),\n            scale(5),\n        ])\n        enemy.play(\"move\")\n       movePlayer(player);\n    \n        const healthbar =     add([\n            rect(Length*enemyHP, 14),\n            color(GREEN), \n            pos(0,0),\n            \"hp\",\n            {\n                set(Health){\n                    this.width = Length*enemyHP;\n                }\n            }\n        ])\n        onClick(shot);\n        onMouseDown(shot);\n\n\n      // ----------------------------------------------------------------------- DO STUFF      \n    onUpdate(() => {\n        if (!player.exists()) return\n        if (!enemy.exists()) return\n    \n    \n        const dir = player.pos.sub(enemy.pos).unit()\n        enemy.move(dir.scale(ENEMY_SPEED))  \n        if(time == 20){\n            enemyNS(enemy.pos, dir);\n            time = 0;\n        }\n        if(timeA >= 30 && enemyHP < enemyHPC){\n            fireworkAT(20, enemy.pos, dir)\n            timeA = 0;\n        }\n        timeA += 1;\n        time += 1;\n    })\n        \n    player.onCollide(\"bullet\", () =>{\n        destroy(player)\n\n        makeBackButton();\n    })\n    \n    enemy.onCollide(\"MyB\", () =>{\n        enemyHP -= dmg;\n        if(enemyHP <= 0){\n            destroy(enemy);\n            makeBackButton();\n        }\n        healthbar.set()\n    })\n\n    cashDisplay(cash);\n\n    function shot(){\n        if (!player.exists() || !canShot == 1) return\n        const Mpos = mousePos();\n        const dir2 = Mpos.sub(player.pos).unit()\n        add([\n            pos(player.pos),\n            rect(12,12),\n            area(),\n            handleout(),\n            color(BLUE),\n            move(dir2, 1000),\n            \"MyB\",\n            \"WallB\",\n            ])\n        canShot = 0\n        wait(0.25, () => canShot = 1)\n    }\n    \n\n\n})\nscene(\"Upgrade\", () => {\n\n    add ([\n        rect(300,300),\n        color(WHITE),\n        area(),\n        \"MoreDMG\",\n        pos(460,450),\n        origin(\"center\"),\n        outline(10, BLACK)\n\n    ])\n    const bulletGraph = add([\n        \n        sprite(\"BUG\"),\n        pos((700, 500)),\n        origin(\"center\"),\n        scale(10),\n        state[\"idle\"],\n\n    ])\n    makeBackButton();\n  \n\n    const healthUp = add([\n        sprite(\"HealthPack\"),\n        pos(800, 450),\n        origin(\"center\"),\n        scale(10),\n        state[\"idle\"],\n        \"IncreaseHealth\"\n    ])\n    onClick(\"MoreDMG\", () => dmg += 10)\n    healthUp.play(\"idle\")\n    bulletGraph.play(\"idle\")\n\n\n})\n\nscene(\"testing\", () => {\n    let player = add([\n        pos(600, 600),\n        color(BLUE),\n        rect(20,20)\n        \n    ])\n   movePlayer(player)\n\n    makeEne(10,800);\n \n    onUpdate(\"redBlock\", (m) => {\n        \n        const dir = player.pos.sub(m.pos).sub(rand(vec2(70))).unit()\n        m.move(dir.scale(300));\n    })\n  \n\n})\n\n\n\nfunction movePlayer(player){\n\n\n    onKeyDown(\"a\", () => {\n        if(player.pos.x > 24){\n           player.move(-SPEED, 0)  \n        }\n  \n    })\n    \n    onKeyDown(\"d\", () => {\n        if(player.pos.x < width()-24){\n        player.move(SPEED, 0)\n        }\n    })\n\n    onKeyDown(\"w\", () => {\n        if(player.pos.y > 67){\n            player.move(0, -SPEED)\n        }\n    })\n    \n    onKeyDown(\"s\", () => {\n        if(player.pos.y < height() -40){\n            player.move(0, SPEED)\n            }\n    \n    })\n}\n//MAKE ENEMIES ------------------------------------------------------------------------------\nfunction makeEne(amount, highPos){\n    for(let loops = 0; loops < amount; loops++){\n        \n        add([\n      \n            pos(rand(vec2(highPos))),\n            rect(12,12),\n            color(RED),\n            area(),\n            solid({scale : 0.5}),\n            \"redBlock\",\n        ]) \n    }\n\n}\n//End of Function -----------------------------------------------------------------------------\n\n//Needs the angle and a enemy pos\nfunction circleAt(x, Position){\n    for(let i = 0; i < 360; i += x ){\n        add\n        ([\n            pos(Position),\n            move(Vec2.fromAngle(i), BULLET_SPEED),\n            rect(12, 12),\n            area(),\n            origin(\"center\"),\n            color(GREEN),\n            handleout(),\n            \"bullet\",\n            \"WallB\",\n        ])\n    }\n}\n\nfunction fireworkAT(x, test, dir){\n    const firework = add([\n        pos(test),\n        move(dir, BULLET_SPEED/1.4),\n        circle(25),\n        origin(\"center\"),\n        color(GREEN),\n        handleout(),\n        \"bullet\",\n        \"WallB\",\n        \n    ])\n    wait(1, () =>  {\n        circleAt(x, firework.pos)\n        destroy(firework)\n    })\n\n}\n\n\n\n//Needs a enemy.pos and dir towards the player\n\nfunction enemyNS(enemy, dir){\n      \n    add([\n        pos(enemy),\n        move(dir, BULLET_SPEED),\n        rect(12, 12),\n        area(),\n        cleanup(),\n        origin(\"center\"),\n        color(GREEN),\n        handleout(),\n        \"bullet\",\n        \"WallB\",\n    ])\n}\n\nfunction handleout() {\n\treturn {\n\t\tid: \"handleout\",\n\t\trequire: [ \"pos\" ],\n\t\tupdate() {\n\t\t\tconst spos = this.screenPos()\n\t\t\tif (\n\t\t\t\tspos.x < 0 ||\n\t\t\t\tspos.x > width() ||\n\t\t\t\tspos.y < 0 ||\n\t\t\t\tspos.y > height()\n\t\t\t) {\n\t\t\t\t// triggers a custom event when out\n\t\t\t\tthis.trigger(\"out\")\n\t\t\t}\n\t\t},\n\t}\n}\n\non(\"out\", \"WallB\", (m) => {\n\tdestroy(m)\n})\n\n\nfunction cashDisplay(cash){\n    add ([\n        text(\"Cash: \" + cash),\n        pos(0, 10),\n    ])\n}\nfunction makeBackButton(){\n    add([\n        rect(300,100),\n        color(255,0,255),\n        pos(center().sub(150, -300)),\n        area(),\n        \"Back\",\n        text(\"Back\")\n    ])\n    onClick(\"Back\", () => go(\"start\"))\n}\n\ngo(\"start\")\n"],"names":["$adc7cb3c45508c7c$var$jt","Object","defineProperty","$adc7cb3c45508c7c$var$Ki","defineProperties","$adc7cb3c45508c7c$var$Hi","getOwnPropertyDescriptors","$adc7cb3c45508c7c$var$sr","getOwnPropertySymbols","$adc7cb3c45508c7c$var$zi","prototype","hasOwnProperty","$adc7cb3c45508c7c$var$Ji","propertyIsEnumerable","$adc7cb3c45508c7c$var$Nt","i","t","l","enumerable","configurable","writable","value","$adc7cb3c45508c7c$var$P","call","$adc7cb3c45508c7c$var$D","$adc7cb3c45508c7c$var$a","$adc7cb3c45508c7c$var$b","$adc7cb3c45508c7c$var$Zi","Uint8Array","w","length","U","p","S","A","charCodeAt","q","k","j","IDList","Map","constructor","args","super","__publicField","this","_lastID","push","v","id","set","pushd","delete","deepEq","o1","o2","t1","t2","k1","keys","k2","v1","v2","downloadURL","url","filename","a","document","createElement","body","appendChild","setAttribute","href","download","click","removeChild","downloadBlob","blob","URL","createObjectURL","revokeObjectURL","isDataURL","str","match","__name","uid","warned","Set","deprecateMsg","oldName","newName","has","add","console","warn","deprecate","newFunc","deg2rad","deg","Math","PI","rad2deg","rad","clamp","val","min","max","lerp","b","map","l1","h1","l2","h2","mapc","_Vec2","x","y","static","angle","cos","sin","clone","p2","vec2","sub","scale","s","dist","sqrt","len","unit","normal","dot","atan2","toFixed","n","Number","eq","other","toString","Vec2","Array","isArray","apply","Vec3","z","xy","vec3","_Color","r","g","arr","lighten","darken","invert","mult","h","rgb","hue2rgb","round","Color","fromArray","hsl2rgb","fromHSL","Quad","quad","Mat4","m","out","multVec4","multVec3","p4","multVec2","translate","rotateX","rotateY","rotateZ","f00","f01","f02","f03","f04","f05","f06","f07","f08","f09","f10","f11","f12","f13","f14","f15","f16","f17","f18","det","wave","lo","hi","f","RNG","seed","gen","defRNG","Date","now","rng","randSeed","rand","randi","floor","chance","choose","list","testRectRect2","r1","r2","p1","testRectRect","testLineLineT","denom","ua","ub","testLineLine","testRectLine","testRectPoint","Line","pt","testRectCircle","c","center","radius","testRectPolygon","testPolygonPolygon","testLinePoint","testLineCircle","testLinePolygon","testPolygonPoint","testCirclePoint","testCircleCircle","c1","c2","testCirclePolygon","testPointPoint","testAreaRect","shape","pts","Error","testAreaLine","Boolean","testAreaCircle","testAreaPolygon","testAreaPoint","testAreaArea","a1","a2","minkDiff","Rect","Circle","FPSCounter","tick","dt","buf","timer","fps","reduce","Timer","time","action","finished","paused","reset","get","$adc7cb3c45508c7c$var$Qi","default","$adc7cb3c45508c7c$var$sn","KEY_ALIAS","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","MOUSE_BUTTONS","PREVENT_DEFAULT_KEYS","ASCII_CHARS","VERT_TEMPLATE","FRAG_TEMPLATE","DEF_VERT","DEF_FRAG","COMP_DESC","COMP_EVENTS","processButtonState","enterFullscreen","el","requestFullscreen","webkitRequestFullscreen","exitFullscreen","webkitExitFullScreen","getFullscreenElement","fullscreenElement","webkitFullscreenElement","originPt","orig","createEmptyAudioBuffer","AudioBuffer","numberOfChannels","sampleRate","gopt","app","_a","_b","_c","root","style","width","height","margin","documentElement","canvas","gscale","stretch","letterbox","parentElement","offsetWidth","offsetHeight","styles","crisp","join","gl","getContext","antialias","depth","stencil","alpha","preserveDrawingBuffer","keyStates","mouseStates","charInputted","isMouseMoved","isKeyPressed","isKeyPressedRepeat","isKeyReleased","mousePos","mouseDeltaPos","realTime","skipTime","numFrames","isTouch","window","navigator","maxTouchPoints","loopID","stopped","fpsCounter","loaded","gfx","defShader","makeShader","emptyTex","makeTex","ImageData","Uint8ClampedArray","background","clearColor","enable","BLEND","SCISSOR_TEST","blendFuncSeparate","SRC_ALPHA","ONE_MINUS_SRC_ALPHA","ONE","vbuf","createBuffer","bindBuffer","ARRAY_BUFFER","vertexAttribPointer","FLOAT","STRIDE","enableVertexAttribArray","bufferData","QUEUE_COUNT","DYNAMIC_DRAW","ibuf","ELEMENT_ARRAY_BUFFER","bgTex","wrap","filter","drawCalls","lastDrawCalls","curShader","defTex","curTex","curUniform","vqueue","iqueue","transform","transformStack","viewport","drawingBufferWidth","drawingBufferHeight","updateViewport","audio","ctx","AudioContext","webkitAudioContext","masterNode","createGain","connect","destination","burpSnd","decodeAudioData","burp_default","buffer","slice","assets","numLoading","numLoaded","urlPrefix","sprites","sounds","shaders","fonts","game","events","objEvents","make","timers","layers","defLayer","gravity","on","ev","cb","trigger","forEach","scenes","logs","cam","pos","shake","load","prom","Promise","resolve","reject","then","catch","err","debug","error","finally","loadProgress","loadRoot","path","fetchURL","fetch","res","ok","loadImg","src","img","Image","crossOrigin","onload","onerror","loadFont","name","gw","gh","opt","font","makeFont","chars","dx","dy","frames","qw","qh","loadSpriteAtlas","data","json","data2","loadSprite","atlas","tex","info","spr","sliceX","sliceY","anims","loadRawSprite","sprite","loadPedit","next","throw","done","__async","images","all","drawImage","loadAseprite","imgSrc","jsonSrc","size","meta","frame","anim","frameTags","from","to","speed","loop","loadShader","vert","frag","isUrl","loadRawShader","shader","resolveUrl","text","vcode","fcode","loadSound","arrayBuffer","resolve2","reject2","snd","loadBean","volume","gain","play","detune","seek","pb","onLoad","pb2","srcNode","createBufferSource","gainNode","start","startTime","currentTime","stopTime","handle","stop","pause","oldNode","playbackRate","isPaused","isStopped","unloop","duration","burp","createTexture","bindTexture","TEXTURE_2D","texImage2D","RGBA","UNSIGNED_BYTE","texFilter","LINEAR","NEAREST","REPEAT","CLAMP_TO_EDGE","texParameteri","TEXTURE_MIN_FILTER","TEXTURE_MAG_FILTER","TEXTURE_WRAP_S","TEXTURE_WRAP_T","bind","unbind","vertSrc","fragSrc","msg","replace","vertShader","createShader","VERTEX_SHADER","fragShader","FRAGMENT_SHADER","shaderSource","compileShader","getShaderInfoLog","createProgram","attachShader","bindAttribLocation","linkProgram","getProgramInfoLog","useProgram","send","uniform","loc","getUniformLocation","uniform1f","uniformMatrix4fv","Float32Array","uniform4f","uniform3f","uniform2f","cols","charMap","split","entries","ch","drawRaw","verts","indices","fixed","flush","screen2ndc","uv","color","opacity","bufferSubData","Uint16Array","drawElements","TRIANGLES","UNSIGNED_SHORT","frameStart","clear","COLOR_BUFFER_BIT","drawUVQuad","frameEnd","pushTranslate","pushScale","pushRotateZ","pushTransform","popTransform","pop","offset","origin","flipX","flipY","drawTexture","tiled","repX","ceil","repY","__spreadProps","__spreadValues","loading","drawSprite","findAsset","getArcPts","radiusX","radiusY","end","step","drawRect","drawPolygon","drawLine","dis","WHITE","drawLines","minLen","drawTriangle","p3","drawCircle","drawEllipse","resolution","npts","fill","flat","outline","applyCharTransform","fchar","tr","TEXT_STYLE_RE","RegExp","compileStyledText","charStyleMap","renderText","idxOffset","matchAll","groups","origIdx","index","localIdx","lib","def","formatText","cw","letterSpacing","lineSpacing","curX","th","tw","flines","curLine","lastSpace","cursor","char","fchars","ox","oy","idx","line","ln","oxl","cn","qpos","drawText","drawFormattedText","ftext","isFullscreen","ww","innerWidth","wh","innerHeight","rc","sw","sh","rg","scissor","isMousePressed","isMouseDown","isMouseReleased","isKeyDown","screenshot","toDataURL","fullscreen","quit","cancelAnimationFrame","addEventListener","e1","offsetX","offsetY","movementX","movementY","button","key","toLowerCase","includes","preventDefault","repeat","touchToMouse","touches","clientX","clientY","left","changedTouches","identifier","visibilityState","resume","suspend","inspect","timeScale","showLog","objCount","children","stepFrame","updateFrame","clearLog","log","unshift","curRecording","mouseWorldPos","toWorld","camPos","camScale","camRot","intensity","toScreen","comps","compStates","customState","obj","_id","hidden","parent","readd","remove","indexOf","splice","removeAll","tag","every","update","revery","child","draw","use","comp","unuse","state","cleanups","func","checkDeps","require","dep","exists","is","sort","_d","_e","_f","layer","reverse","onUpdate","gEvents","e","destroy","onDraw","onDestroy","clearEvents","event","onCollide","col","e2","e3","area","_checkCollisions","onClick","onMousePress","o","isClicked","onHover","onNotHover","isHovering","wait","newF","onKeyDown","cancellers","onKeyPress","onKeyPressRepeat","onKeyRelease","onMouseDown","onMouseRelease","onMouseMove","onCharInput","onTouchStart","onTouchMove","onTouchEnd","enterDebugMode","record","enterBurpMode","regCursor","makeCollision","target","displacement","isTop","isBottom","isLeft","isRight","moveBy","solid","worldArea","md","abs","ray","minT","numCols","lines","right","top","bottom","move","moveTo","dest","diff","screenPos","scaleTo","rotate","follow","dir","d","fromAngle","outview","isOut","isOutOfView","screenRect","screenArea","onExitView","onEnterView","delay","hide","cleanup","onCleanup","colliding","mpos","hasPoint","isColliding","isTouching","clicks","hovers","collides","pushOut","pushOutAll","getRenderProps","curAnim","calcTexScale","animSpeed","onEnd","_g","pingpong","prevAnim","onAnimEnd","onAnimStart","JSON","stringify","textSize","rect","uvquad","circle","velY","curPlatform","lastPlatformPos","canDouble","jumpForce","weight","justFall","y1","y2","x1","x2","x3","x4","maxVel","isGrounded","grounded","isFalling","falling","jump","force","doubleJump","onGround","onFall","onHeadbutt","onDoubleJump","stay","health","hp","hurt","setHP","heal","onHurt","onHeal","onDeath","lifespan","fade","startFade","initState","stateList","transitions","initStateHook","enter","leave","enterState","oldState","available","onStateTransition","onStateEnter","onStateUpdate","onStateDraw","onStateLeave","scene","go","cancel","getData","parse","localStorage","setData","plug","plugin","funcs","global","grid","level","gridPos","setGridPos","gridWidth","gridHeight","moveLeft","moveRight","moveUp","moveDown","addLevel","objs","longRow","getPos","spawn","sym","any","posComp","row","syms","frameRate","stream","captureStream","audioDest","createMediaStreamDestination","audioStream","firstAudioTrack","getAudioTracks","recorder","MediaRecorder","chunks","ondataavailable","disconnect","getTracks","onstop","Blob","type","focus","isFocused","activeElement","destroyAll","explode","kaSprite","boomSprite","addKaboom","boom","boomComps","ka","kaComps","drawFrame","drawLoadScreen","progress","drawInspectText","txt","pad","ftxt","DBG_FONT","bw","bh","drawDebug","inspecting","lcolor","inspectColor","lwidth","flipped","logMax","run","requestAnimationFrame","realDt","message","audioCtx","pushRotate","CP437_CHARS","LEFT","RIGHT","UP","DOWN","RED","GREEN","BLUE","YELLOW","MAGENTA","CYAN","BLACK","keyIsDown","keyIsPressed","keyIsPressedRep","keyIsReleased","mouseIsDown","mouseIsClicked","mouseIsReleased","mouseIsMoved","render","keyDown","keyPress","keyPressRep","keyRelease","mouseDown","mouseClick","mouseRelease","mouseMove","charInput","touchStart","touchMove","touchEnd","focused","ready","plugins","$3cadc9686eae5c9c$var$dmg","$3cadc9686eae5c9c$var$time","$3cadc9686eae5c9c$var$timeA","$3cadc9686eae5c9c$var$enemyHP","$3cadc9686eae5c9c$var$enemyHPC","$3cadc9686eae5c9c$var$Length","$3cadc9686eae5c9c$var$canShot","$3cadc9686eae5c9c$var$cash","$3cadc9686eae5c9c$var$movePlayer","player","$3cadc9686eae5c9c$var$fireworkAT","test","firework","$3cadc9686eae5c9c$var$handleout","Position","$3cadc9686eae5c9c$var$circleAt","$3cadc9686eae5c9c$var$enemyNS","enemy","spos","$3cadc9686eae5c9c$var$makeBackButton","idle","healthbar","Health","shot","dir2","bulletGraph","healthUp","amount","highPos","loops","$3cadc9686eae5c9c$var$makeEne"],"version":3,"file":"index.46fa3012.js.map"}